<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Din plan ‚Äî Studiev√§gsguiden</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
:root{--bg:#FAFAF7;--card:#FFF;--tx:#1A1A18;--mu:#6B6B63;--li:#9C9C91;--ac:#7AC29A;--al:#D9F0E3;--ah:#5AA87A;--wa:#6BA3D0;--wl:#D4E8F5;--re:#E07A7A;--rl:#F8E8E8;--bl:#6BA3D0;--bll:#D4E8F5;--pu:#9B87C2;--pl:#EDE7F5;--bo:#E8E8E2;--sh:0 2px 20px rgba(0,0,0,.06);--shl:0 8px 40px rgba(0,0,0,.1);--r:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);line-height:1.6;-webkit-font-smoothing:antialiased}
nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(250,250,247,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--bo);padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between}
.logo{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;letter-spacing:0.01em}
.logo .i-dot{position:relative;display:inline-block}
.logo .i-dot::after{content:'';position:absolute;top:0.25em;left:50%;transform:translateX(-50%);width:0.2em;height:0.2em;background:#6BA3D0;border-radius:50%}
.hero{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:100px 24px 60px;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;top:-30%;left:-20%;width:60%;height:60%;background:radial-gradient(ellipse,rgba(122,194,154,.06) 0%,transparent 70%)}
.badge{display:inline-flex;align-items:center;gap:6px;background:var(--al);color:var(--ac);padding:8px 16px;border-radius:20px;font-size:.82rem;font-weight:600;margin-bottom:32px;opacity:0;animation:fu .8s ease forwards .2s}
.hero h1{font-family:'DM Serif Display',serif;font-size:clamp(2.2rem,5vw,3.8rem);line-height:1.12;max-width:680px;margin-bottom:18px;letter-spacing:-1px;opacity:0;animation:fu .8s ease forwards .4s}
.hero>p{font-size:1.12rem;color:var(--mu);max-width:480px;margin-bottom:44px;opacity:0;animation:fu .8s ease forwards .6s}
.cbox{background:var(--card);border:2px solid var(--bo);border-radius:16px;padding:28px;width:100%;max-width:500px;box-shadow:var(--shl);position:relative;z-index:1;opacity:0;animation:fu .8s ease forwards .8s}
.fld{margin-bottom:18px}
.fld label{display:block;font-size:.78rem;font-weight:600;color:var(--mu);text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px}
.fld input,.fld select{width:100%;padding:13px 15px;border:2px solid var(--bo);border-radius:10px;font-family:inherit;font-size:1rem;color:var(--tx);background:var(--bg);transition:border-color .2s;appearance:none;-webkit-appearance:none}
.fld input:focus,.fld select:focus{outline:none;border-color:var(--ac)}
.fld select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236B6B63' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
.btn{width:100%;padding:15px;background:var(--ac);color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:1.02rem;font-weight:700;cursor:pointer;transition:all .2s}
.btn:hover{background:var(--ah);transform:translateY(-1px);box-shadow:0 4px 16px rgba(122,194,154,.3)}
.sec{max-width:1100px;margin:0 auto;padding:0 32px 80px;display:none}.sec.v{display:block}
.sh{text-align:center;padding:56px 0 36px}.sh h2{font-family:'DM Serif Display',serif;font-size:1.9rem;margin-bottom:6px}.sh p{color:var(--mu)}
.gcards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:44px;max-width:720px;margin-left:auto;margin-right:auto}
.gc{background:var(--card);border:2px solid var(--bo);border-radius:var(--r);padding:18px 14px;text-align:center;opacity:0;transform:translateY(20px);position:relative}.gc.sh2{animation:fu .5s ease forwards}
.gcx{cursor:pointer;transition:border-color .2s}.gcx:hover{border-color:var(--ac)}.gcx.open{border-color:var(--ac)}
.gcarr{position:absolute;top:8px;right:8px;color:var(--li);transition:transform .2s;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%}
.gcx.open .gcarr{transform:rotate(180deg)}
.gcexp{max-height:0;overflow:hidden;transition:max-height .3s ease}
.gcx.open .gcexp{max-height:200px}
.gcexp-inner{padding-top:12px;margin-top:10px;border-top:1px solid var(--bo);text-align:left;font-size:.82rem;color:var(--mu);line-height:1.55}
.gcexp-inner .gcbar{height:5px;border-radius:3px;background:var(--bo);margin:8px 0 3px;overflow:hidden}
.gcexp-inner .gcfill{height:100%;border-radius:3px;transition:width .6s ease}
.gcexp-inner .gcmeta{display:flex;justify-content:space-between;font-size:.68rem;color:var(--li)}
.gc .gl{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.gc .gv{font-family:'DM Serif Display',serif;font-size:1.4rem;line-height:1.2}
.gc .gs{font-size:.75rem;color:var(--li);margin-top:3px}
.verd{background:var(--card);border:2px solid var(--bo);border-radius:var(--r);padding:28px 24px;text-align:center;margin-bottom:48px;opacity:0;transform:translateY(20px)}.verd.sh2{animation:fu .5s ease forwards}
.ve{font-size:2rem;margin-bottom:8px}.vt{font-size:1.02rem;line-height:1.6}.vt strong{color:var(--ac)}
/* Teaser */
.tdiv{text-align:center;margin-bottom:28px;position:relative}.tdiv::before{content:'';position:absolute;left:0;right:0;top:50%;height:1px;background:var(--bo)}.tdiv span{background:var(--bg);padding:0 16px;position:relative;font-size:.82rem;font-weight:600;color:var(--li);text-transform:uppercase;letter-spacing:1px}
.twrap{position:relative;border-radius:16px;border:2px solid var(--bo);overflow:hidden}
.tblur{filter:blur(6px);opacity:.5;pointer-events:none;user-select:none;padding:28px 24px}
.tover{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(180deg,rgba(250,250,247,0) 0%,rgba(250,250,247,.92) 30%,rgba(250,250,247,1) 60%);display:flex;flex-direction:column;align-items:center;padding:80px 24px 36px}
.tover h3{font-family:'DM Serif Display',serif;font-size:1.35rem;margin-bottom:8px;text-align:center;line-height:1.3}
.tover>p{color:var(--mu);text-align:center;max-width:380px;margin-bottom:20px;font-size:.9rem;line-height:1.5}
.ubtn{background:var(--ac);color:#fff;border:none;padding:15px 36px;border-radius:10px;font-family:inherit;font-size:1.02rem;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:10px}
.ubtn:hover{background:var(--ah);transform:translateY(-2px);box-shadow:0 6px 24px rgba(122,194,154,.3)}
.ubtn .pr{font-size:.85rem;opacity:.8;font-weight:500}
.tsec-head{font-family:'DM Serif Display',serif;font-size:1.05rem;display:flex;align-items:center;gap:8px;margin-bottom:10px}
.tsec-head .tn{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;color:#fff;flex-shrink:0}
/* Wizard */
.wov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);z-index:200;justify-content:center;align-items:center;padding:20px}.wov.a{display:flex}
.wiz{background:var(--card);border-radius:20px;max-width:520px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:var(--shl)}
.wizh{padding:24px 28px 0;display:flex;justify-content:space-between;align-items:center}.wizh h3{font-family:'DM Serif Display',serif;font-size:1.25rem}
.wizx{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--li);width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%}.wizx:hover{background:var(--bg);color:var(--tx)}
.wprog{margin:16px 28px 0;height:4px;background:var(--bo);border-radius:2px;overflow:hidden}.wbar{height:100%;background:var(--ac);transition:width .3s;border-radius:2px}
.wsl{padding:8px 28px 0;font-size:.78rem;color:var(--li)}
.wbody{padding:20px 28px 28px}
.wq h4{font-size:1.05rem;font-weight:600;margin-bottom:6px}.wq .why{font-size:.82rem;color:var(--li);margin-bottom:16px;font-style:italic}
.wopts{display:grid;gap:8px}
.wo{padding:14px 16px;border:2px solid var(--bo);border-radius:10px;cursor:pointer;transition:all .15s;font-size:.92rem;display:flex;align-items:center;gap:10px}
.wo:hover{border-color:var(--ac);background:var(--al)}.wo.sel{border-color:var(--ac);background:var(--al);font-weight:600}
.wdot{width:20px;height:20px;border-radius:50%;border:2px solid var(--bo);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.wo.sel .wdot{border-color:var(--ac);background:var(--ac)}.wo.sel .wdot::after{content:'';width:8px;height:8px;border-radius:50%;background:#fff}
.winp{display:flex;gap:10px;align-items:center}.winp input{flex:1;padding:13px 15px;border:2px solid var(--bo);border-radius:10px;font-family:inherit;font-size:1rem;color:var(--tx);background:var(--bg)}.winp input:focus{outline:none;border-color:var(--ac)}.winp span{font-size:.88rem;color:var(--mu);white-space:nowrap}
.wnav{display:flex;gap:10px;margin-top:24px}
.wbk{flex:1;padding:13px;background:var(--bg);border:2px solid var(--bo);border-radius:10px;font-family:inherit;font-weight:600;font-size:.92rem;cursor:pointer;color:var(--mu)}
.wnx{flex:2;padding:13px;background:var(--ac);color:#fff;border:none;border-radius:10px;font-family:inherit;font-weight:700;font-size:.92rem;cursor:pointer;transition:all .2s}.wnx:hover{background:var(--ah)}
.psum{background:var(--al);padding:16px;border-radius:10px;margin-bottom:20px}.psr{display:flex;justify-content:space-between;font-size:.88rem;padding:4px 0}.psr.tot{font-weight:700;font-size:1rem;border-top:1px solid rgba(122,194,154,.2);padding-top:10px;margin-top:8px}
/* Full plan */
.fp{display:none;max-width:720px;margin:0 auto;padding:0 24px}.fp.v{display:block}
.ptbar{position:sticky;top:60px;z-index:90;background:rgba(250,250,247,.98);backdrop-filter:blur(12px);border-bottom:2px solid #e0e0d8;margin:0 -24px 32px;padding:10px 16px;display:flex;gap:6px;box-shadow:0 2px 8px rgba(0,0,0,.04);overflow-x:auto;scrollbar-width:none}
.ptbar::-webkit-scrollbar{display:none}
.ptbar button{flex:1;padding:10px 6px;border-radius:10px;border:2px solid transparent;background:#fff;font-family:inherit;font-size:.75rem;font-weight:600;color:#6B6B63;cursor:pointer;transition:all .2s;position:relative}
.ptbar button:hover{border-color:var(--ac);color:var(--ac);transform:translateY(-1px)}
.ptbar button.act{background:linear-gradient(135deg,var(--ac),var(--ah));color:#fff;border-color:transparent;box-shadow:0 4px 12px rgba(122,194,154,.3);transform:translateY(-2px)}
.pwel{background:linear-gradient(135deg,var(--ac),var(--ah));border-radius:16px;padding:32px 24px;color:#fff;margin-bottom:28px}.pwel h3{font-family:'DM Serif Display',serif;font-size:1.5rem;margin-bottom:10px;color:#fff;line-height:1.3}.pwel .pintro{opacity:.9;font-size:.9rem;line-height:1.65}
.pwel .pfacts{display:flex;flex-wrap:wrap;gap:6px;margin-top:16px}.pwel .pfacts span{background:rgba(255,255,255,.15);padding:5px 12px;border-radius:20px;font-size:.74rem;font-weight:600}
/* Section dividers */
.psec{margin-bottom:36px}.psec-h{display:flex;align-items:center;gap:10px;margin-bottom:6px}.psec-n{width:28px;height:28px;border-radius:50%;background:var(--ac);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.78rem;flex-shrink:0}
.psec-t{font-family:'DM Serif Display',serif;font-size:1.2rem}
.psec-sub{font-size:.86rem;color:var(--mu);line-height:1.6;margin-bottom:16px;margin-left:38px}
/* Match cards */
.mcard{border:2px solid var(--bo);border-radius:var(--r);padding:18px;margin-bottom:10px;transition:all .2s;position:relative}.mcard.msel{border-color:var(--ac);background:var(--al)}
.mcard .mtop{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
.mcard .mname{font-weight:700;font-size:1rem}.mcard .mbadge{padding:3px 10px;border-radius:12px;font-size:.7rem;font-weight:700;flex-shrink:0;white-space:nowrap}
.mcard .mwhy{font-size:.84rem;color:var(--mu);line-height:1.5;margin-bottom:10px}
.mcard .mstats{display:flex;gap:8px;flex-wrap:wrap}.mcard .mstat{font-size:.74rem;padding:3px 8px;border-radius:5px;background:#f5f5f0}
/* Action steps */
.astep{display:flex;gap:16px;padding:18px 0;border-bottom:1px solid var(--bo)}.astep:last-child{border-bottom:none}
.anum{width:32px;height:32px;border-radius:50%;background:var(--ac);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.82rem;flex-shrink:0}
.abody{flex:1}.abody .atit{font-weight:700;font-size:.92rem;margin-bottom:2px}.abody .awhen{font-size:.76rem;color:var(--ac);font-weight:600;margin-bottom:5px}.abody .adesc{font-size:.84rem;color:var(--mu);line-height:1.55}
/* Checklist */
.chk{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:8px;border:1.5px solid var(--bo);margin-bottom:6px;cursor:pointer;transition:all .15s;font-size:.88rem;user-select:none}.chk:hover{border-color:var(--ac)}.chk.done{background:var(--al);border-color:var(--ac);color:var(--li)}
.chk.done span{text-decoration:line-through}
.chk .chkbox{width:20px;height:20px;border-radius:5px;border:2px solid var(--bo);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.chk.done .chkbox{background:var(--ac);border-color:var(--ac)}
/* Proof tags */
.ptag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:.72rem;font-weight:600;background:var(--al);color:var(--ac);margin:2px}
/* Housing buttons */
.houbtn{flex:1;padding:6px 4px;border:1.5px solid var(--bo);border-radius:6px;background:var(--bg);font-family:inherit;font-size:.72rem;font-weight:600;color:var(--mu);cursor:pointer;transition:all .15s}
.houbtn:hover{border-color:var(--re);color:var(--re)}
.houbtn.hact{border-color:var(--re);background:var(--rl);color:var(--re)}
/* Existing card styles */
.pcard{background:var(--card);border:2px solid var(--bo);border-radius:var(--r);overflow:hidden;margin-bottom:20px}
.pcardh{padding:16px 20px}.pcardh h4{font-size:1rem;font-weight:600;margin-bottom:2px}.pcardh p{font-size:.82rem;opacity:.8}
.pcardb{padding:20px}
.brow{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:8px;margin-bottom:6px}.brow label{font-size:.88rem}.brow .bv{font-weight:700;font-size:.92rem}
.bsrow{padding:12px;border-radius:8px;margin-bottom:6px}
.bslider{width:100%;height:6px;cursor:pointer;border-radius:3px;margin-top:6px}
.bsmeta{display:flex;justify-content:space-between;font-size:.68rem;color:var(--li);margin-top:4px}
.btot{display:flex;justify-content:space-between;padding:12px;border-radius:8px;color:#fff;font-weight:700}
.bres{padding:20px;border-radius:10px;text-align:center;margin-top:16px;border:2px solid}
.brl{font-size:.88rem;margin-bottom:4px}.brv{font-size:1.7rem;font-weight:700}.bra{font-size:.82rem;margin-top:8px}
.behal{padding:18px;border-radius:var(--r);margin-bottom:16px;border:2px solid}.behal h4{font-size:.95rem;margin-bottom:6px;display:flex;align-items:center;gap:8px}.behal p{font-size:.86rem;line-height:1.6}
.behc{margin-top:10px;display:flex;flex-wrap:wrap;gap:6px}.behc span{padding:4px 12px;border-radius:6px;font-size:.8rem;font-weight:600}
.amgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}.amitem{padding:14px;border-radius:10px}.amitem .aml{font-size:.72rem;font-weight:700;text-transform:uppercase;margin-bottom:4px}.amitem .amv{font-family:'DM Serif Display',serif;font-size:1.2rem}.amitem .ams{font-size:.78rem;margin-top:4px}
.ambw{margin-top:12px}.ambl{display:flex;justify-content:space-between;font-size:.82rem;margin-bottom:4px}.amb{height:8px;border-radius:4px;background:var(--bo);overflow:hidden}.ambf{height:100%;border-radius:4px;transition:width .8s ease}
.cgrid{display:grid;gap:10px}.crow{display:grid;grid-template-columns:auto 1fr auto;gap:14px;align-items:center;padding:14px 16px;border-radius:10px;border:2px solid var(--bo)}.crow:hover{border-color:var(--ac)}
.cico{display:flex;align-items:center}.cinf .cit{font-weight:600;font-size:.92rem}.cinf .cid{font-size:.78rem;color:var(--mu)}
.csal{font-family:'DM Serif Display',serif;font-size:1.1rem;text-align:right}.csal .csub{font-size:.7rem;color:var(--li);font-family:'DM Sans'}
.schi{display:flex;gap:14px;align-items:center;padding:14px 16px;border-radius:10px;border:2px solid var(--bo);margin-bottom:8px}
.schico{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.schinf{flex:1}.schinf .schn{font-weight:600;font-size:.92rem}.schinf .schm{font-size:.78rem;color:var(--mu)}
.scht{display:flex;gap:5px;flex-wrap:wrap;margin-top:4px}.scht span{padding:2px 8px;border-radius:4px;font-size:.7rem;font-weight:600;background:var(--al);color:var(--ac)}
.upsell{background:linear-gradient(135deg,var(--wl),#FFF8EE);border:2px solid var(--wa);border-radius:var(--r);padding:28px;text-align:center;margin-top:32px}
.upsell h4{font-family:'DM Serif Display',serif;font-size:1.15rem;margin-bottom:8px}.upsell>p{color:var(--mu);font-size:.9rem;margin-bottom:18px;max-width:400px;margin-left:auto;margin-right:auto}
.ubtn2{background:var(--wa);color:#fff;border:none;padding:13px 28px;border-radius:10px;font-family:inherit;font-size:.95rem;font-weight:700;cursor:pointer}.ubtn2:hover{background:#C09540}
.sgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
.scard{padding:12px 8px;border-radius:var(--r);text-align:center}.scard .sl{font-size:.64rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px}.scard .sv{font-family:'DM Serif Display',serif;font-size:1rem}
.pncont{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:28px;max-width:720px;margin-left:auto;margin-right:auto}
.pnbox{background:var(--card);border:2px solid var(--bo);border-radius:var(--r);overflow:hidden;opacity:0;transform:translateY(20px)}.pnbox.sh2{animation:fu .5s ease forwards}
.pnhead{padding:14px 16px;display:flex;align-items:center;gap:8px;font-weight:700;font-size:.88rem}
.pnhead svg{flex-shrink:0}
.pnlist{padding:0 16px 16px;display:grid;gap:8px}
.pnitem{display:flex;gap:10px;align-items:flex-start;font-size:.84rem;line-height:1.5;color:var(--mu)}
.pnitem svg{flex-shrink:0;margin-top:3px}
.pnpro .pnhead{color:var(--ac);background:var(--al);border-bottom:1px solid rgba(122,194,154,.12)}
.pncon .pnhead{color:var(--re);background:var(--rl);border-bottom:1px solid rgba(194,75,59,.12)}
.pnpro .pnitem svg{color:var(--ac)}.pncon .pnitem svg{color:var(--re)}
@keyframes fu{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE STYLES ‚Äî max-width: 640px
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media(max-width:640px){
  /* General */
  .sec{padding:0 16px 60px}
  .fp{padding:0 14px}

  /* Hero */
  .hero{padding:80px 20px 48px}
  .hero h1{font-size:1.9rem;letter-spacing:-.5px}
  .hero>p{font-size:.95rem}
  .cbox{padding:18px 16px}

  /* Nav */
  nav{padding:0 16px}

  /* Snabbkalkyl cards */
  .gcards{grid-template-columns:1fr 1fr!important}
  .sgrid{grid-template-columns:1fr 1fr!important}
  .pncont{grid-template-columns:1fr!important}
  .amgrid{grid-template-columns:1fr!important}

  /* Tab bar */
  .ptbar{padding:8px 12px;gap:4px;top:58px}
  .ptbar button{font-size:.68rem;padding:8px 3px;border-radius:8px;flex-shrink:0;min-width:0}

  /* Plan section spacing */
  .psec{margin-bottom:24px}
  .pwel{padding:22px 18px}
  .pwel h3{font-size:1.2rem}

  /* Wizard */
  .wov{padding:0;align-items:flex-end}
  .wiz{border-radius:20px 20px 0 0;max-height:92vh;max-width:100%;width:100%}
  .wizh{padding:18px 18px 0}
  .wprog,.wsl{margin-left:18px;margin-right:18px}
  .wbody{padding:16px 18px 24px}
  .wq h4{font-size:1rem}
  .wo{padding:12px 14px;font-size:.88rem}
  .wnx,.wbk{padding:12px}
  .wnav{margin-top:16px}

  /* Action steps */
  .astep{gap:12px;padding:14px 0}
  .anum{width:28px;height:28px;font-size:.78rem;flex-shrink:0}

  /* Plan overview cards */
  .mcard .mtop{flex-direction:column;gap:6px}
  .mcard .mbadge{align-self:flex-start}

  /* Paywall overlay ‚Äî force single column grids */
  #planLoader [style*="grid-template-columns:repeat(3"]{grid-template-columns:repeat(2,1fr)!important}
  #planEkon [style*="grid-template-columns:repeat(3"]{grid-template-columns:1fr 1fr!important}
  #planEkon [style*="grid-template-columns:repeat(6"]{grid-template-columns:repeat(3,1fr)!important}
  #planSkol [style*="grid-template-columns:repeat(2"]{grid-template-columns:1fr 1fr!important}
  #planTid [style*="grid-template-columns:repeat(3"]{grid-template-columns:1fr 1fr!important}
  #planOverview [style*="grid-template-columns:repeat(3"]{grid-template-columns:1fr 1fr!important}
  #planOverview [style*="grid-template-columns:repeat(4"]{grid-template-columns:1fr 1fr!important}
  #planBeh [style*="grid-template-columns:repeat(2"]{grid-template-columns:1fr!important}

  /* Budget sliders */
  .bsrow{padding:10px}
  .bslider{height:8px} /* bigger tap target */
  .houbtn{padding:8px 4px;font-size:.7rem}

  /* School cards */
  .schi{flex-wrap:wrap;gap:10px}
  .scht{margin-top:6px}

  /* Upsell */
  .upsell{padding:20px 16px}

  /* Section headers in plan */
  .sh{padding:36px 0 24px}
  .sh h2{font-size:1.5rem}

  /* Verdict card */
  .verd{padding:20px 16px}
  .ve{font-size:1.5rem}
  .vt{font-size:.92rem}

  /* CTA area */
  #ctaPlan{padding:22px 18px}
  #ctaPlan h3{font-size:1.25rem}

  /* Tidslinje date cards ‚Äî always 3 col but smaller text */
  #planTid .date-row [style*="font-size:1.4rem"]{font-size:1.1rem!important}
}

/* Smaller phones */
@media(max-width:380px){
  .ptbar button{font-size:.62rem;padding:7px 2px}
  .gcards{grid-template-columns:1fr!important}
  .hero h1{font-size:1.65rem}
  #planEkon [style*="grid-template-columns:repeat(3"]{grid-template-columns:1fr!important}
  #planTid [style*="grid-template-columns:repeat(3"]{grid-template-columns:1fr!important}
  .mob-grid-2,.mob-grid-3{grid-template-columns:1fr 1fr!important}
}

/* Mobile grid helpers */
@media(max-width:640px){
  .mob-grid-2{grid-template-columns:1fr 1fr!important}
  .mob-grid-3{grid-template-columns:1fr 1fr!important}
}

/* Tab label switching */
.ts{display:none}.tf{display:inline}
@media(max-width:480px){.ts{display:inline}.tf{display:none}}

/* Bigger tap targets on mobile */
@media(max-width:640px){
  .wo{min-height:48px}
  .wnx,.wbk{min-height:48px}
  .btn{min-height:52px}
  .ubtn{min-height:52px}
  input[type=range]{height:28px;cursor:pointer}
}

.budget-sticky {
    position:sticky;
    top:110px;
    z-index:10;
    background:var(--bg);
    padding:12px 0 10px;
    margin-bottom:20px;
}
.budget-sticky::before {
    content:'';
    position:absolute;
    top:-12px;left:-24px;right:-24px;
    height:12px;
    background:var(--bg);
}
@media(max-width:640px){.budget-sticky{top:106px}}
@media print {
    nav,.hero,.sec#secR,.ptbar,footer,.wov,#planLoader,button:not(.no-print){display:none!important}
    .pnl{display:block!important;page-break-inside:avoid}
    body{background:#fff!important}
    @page{margin:1.5cm;size:A4}
}
</style>
<style>
.blur-wrap{position:relative;overflow:hidden;border-radius:16px;border:2px solid var(--bo)}
.blur-content{filter:blur(5px);pointer-events:none;user-select:none;max-height:420px;overflow:hidden}
.paywall-overlay{position:absolute;bottom:0;left:0;right:0;top:0;background:linear-gradient(180deg,rgba(250,250,247,0) 0%,rgba(250,250,247,.92) 30%,rgba(250,250,247,1) 60%);display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding:40px 24px 40px}
.paywall-card{background:var(--card);border:2px solid var(--bo);border-radius:16px;padding:28px 24px;width:100%;max-width:480px;box-shadow:0 8px 40px rgba(0,0,0,.1);text-align:center;margin-top:20px}
</style>
</head>
<body>

<script>
const SUPABASE_URL = 'https://qofvdpvxrvvjalgdiflg.supabase.co';
const SUPABASE_KEY = 'sb_publishable_Vfm1BArZN_RAWrwTOzVGXA_WWvIk77V';
const sb = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;
</script>

<nav>
  <div class="logo"><span style="color:#6BA3D0">Studiev√§gs</span><span style="color:#7AC29A">gu<span class="i-dot">i</span>den</span></div>
  <div style="font-size:.82rem;color:var(--mu)">Din plan √§r redo</div>
</nav>

<!-- Loading state -->
<div id="loadingState" style="min-height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;padding:24px">
  <div style="font-family:'DM Serif Display',serif;font-size:1.5rem;color:var(--ah)">Laddar din plan...</div>
  <div style="font-size:.88rem;color:var(--mu)">H√§mtar dina svar</div>
</div>

<!-- Error state -->
<div id="errorState" style="display:none;min-height:100vh;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;padding:24px;text-align:center">
  <div style="font-size:2.5rem">‚ö†Ô∏è</div>
  <div style="font-family:'DM Serif Display',serif;font-size:1.5rem">Kunde inte ladda planen</div>
  <div style="color:var(--mu);max-width:360px">Dina svar hittades inte. F√∂rs√∂k igen fr√•n formul√§ret.</div>
  <a href="/skapa-min-plan" style="background:var(--ac);color:#fff;padding:14px 28px;border-radius:10px;text-decoration:none;font-weight:700">‚Üê Tillbaka till formul√§ret</a>
</div>

<!-- Plan container (hidden until loaded) -->
<div id="planWrap" style="display:none;padding-top:60px">
  <!-- Blur overlay over generated plan -->
  <div style="max-width:720px;margin:0 auto;padding:24px">
    <div id="previewCards" style="margin-bottom:20px"></div>
    
    <div class="blur-wrap">
      <div class="blur-content">
        <div class="fp v" id="fpDiv" style="max-width:100%;padding:0"></div>
      </div>
      <div class="paywall-overlay">
      </div>
    </div>
    
    <!-- Paywall card (outside blur) -->
    <div class="paywall-card" style="margin-top:24px">
      <div style="font-family:'DM Serif Display',serif;font-size:1.5rem;margin-bottom:10px;line-height:1.3">
        Din personliga plan √§r klar
      </div>
      <div style="color:var(--mu);font-size:.9rem;line-height:1.6;margin-bottom:20px">
        L√•s upp hela planen ‚Äî beh√∂righet, budget, tidslinje och konkreta n√§sta steg.
      </div>
      
      <div style="display:grid;gap:8px;margin-bottom:20px;text-align:left">
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#f8f9fa;border-radius:8px;font-size:.84rem">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          <span><strong>Beh√∂righet</strong> ‚Äî kurs f√∂r kurs baserat p√• ditt gymnasieprogram</span>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#f8f9fa;border-radius:8px;font-size:.84rem">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          <span><strong>Interaktiv budget</strong> ‚Äî justera CSN, hyra och extrajobb i realtid</span>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#f8f9fa;border-radius:8px;font-size:.84rem">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          <span><strong>Steg-f√∂r-steg plan</strong> ‚Äî konkreta datum och deadlines</span>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#f8f9fa;border-radius:8px;font-size:.84rem">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          <span><strong>Matchade skolor</strong> ‚Äî filtrerat p√• din ort och studieform</span>
        </div>
      </div>
      
      <!-- Stripe CTA ‚Äî aktiveras n√§r AB √§r registrerat -->
      <div id="stripeSection">
        <button onclick="handlePayment()" style="width:100%;background:linear-gradient(135deg,var(--ac),var(--ah));color:#fff;border:none;padding:18px 32px;border-radius:12px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(45,90,61,.3)">
          L√•s upp min plan ‚Äî 99 kr
        </button>
        <p style="font-size:.76rem;color:var(--mu);margin-top:10px;text-align:center">
          Eng√•ngsbetalning &nbsp;¬∑&nbsp; Ingen prenumeration &nbsp;¬∑&nbsp; Planen sparas
        </p>
      </div>
    </div>
    
    <div style="text-align:center;margin-top:24px">
      <a href="/skapa-min-plan" style="font-size:.82rem;color:var(--mu);text-decoration:none">‚Üê Tillbaka och √§ndra svar</a>
    </div>
  </div>
</div>

<!-- E-post modal f√∂r att spara plan -->
<div id="emailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999;justify-content:center;align-items:center;padding:24px">
  <div style="background:#fff;border-radius:20px;padding:36px 28px;max-width:420px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.2)">
    <div style="text-align:center;margin-bottom:24px">
      <div style="width:52px;height:52px;background:var(--al);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 14px">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <div style="font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:6px">Spara din plan</div>
      <div style="color:var(--mu);font-size:.88rem;line-height:1.5">Ange din e-post s√• sparar vi planen. Du kan alltid komma tillbaka och se den igen.</div>
    </div>
    <div style="margin-bottom:14px">
      <label style="display:block;font-size:.75rem;font-weight:600;color:var(--mu);text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px">Din e-postadress</label>
      <input id="emailInput" type="email" placeholder="namn@exempel.se"
        onkeydown="if(event.key==='Enter')document.getElementById('passwordInput').focus()"
        style="width:100%;padding:14px 16px;border:2px solid var(--bo);border-radius:10px;font-family:inherit;font-size:1rem;color:var(--tx);background:var(--bg);outline:none;box-sizing:border-box"
        onfocus="this.style.borderColor='var(--ac)'" onblur="this.style.borderColor='var(--bo)'">
      <div id="emailError" style="display:none;color:var(--re);font-size:.78rem;margin-top:6px">Ange en giltig e-postadress.</div>
    </div>
    <div style="margin-bottom:16px">
      <label style="display:block;font-size:.75rem;font-weight:600;color:var(--mu);text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px">V√§lj ett l√∂senord</label>
      <input id="passwordInput" type="password" placeholder="Minst 4 tecken"
        onkeydown="if(event.key==='Enter')saveAndUnlock()"
        style="width:100%;padding:14px 16px;border:2px solid var(--bo);border-radius:10px;font-family:inherit;font-size:1rem;color:var(--tx);background:var(--bg);outline:none;box-sizing:border-box"
        onfocus="this.style.borderColor='var(--ac)'" onblur="this.style.borderColor='var(--bo)'">
      <div id="passwordError" style="display:none;color:var(--re);font-size:.78rem;margin-top:6px">L√∂senordet m√•ste vara minst 4 tecken.</div>
    </div>
    <button id="emailSubmitBtn" onclick="saveAndUnlock()"
      style="width:100%;padding:15px;background:linear-gradient(135deg,var(--ac),var(--ah));color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;margin-bottom:10px">
      Spara och g√• till min plan ‚Üí
    </button>
    <button onclick="document.getElementById('emailModal').style.display='none';pay()"
      style="width:100%;padding:12px;background:none;border:none;font-family:inherit;font-size:.85rem;color:var(--li);cursor:pointer">
      Hoppa √∂ver ‚Äî visa planen utan att spara
    </button>
  </div>
</div>

<!-- Stripe-not-ready modal -->
<div id="stripeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999;justify-content:center;align-items:center;padding:24px">
  <div style="background:#fff;border-radius:20px;padding:32px;max-width:420px;width:100%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.2)">
    <div style="font-size:2.5rem;margin-bottom:16px">üîí</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:10px">Betalning kommer snart</div>
    <div style="color:var(--mu);font-size:.9rem;line-height:1.6;margin-bottom:20px">
      Vi h√•ller p√• att registrera f√∂retaget och s√§tta upp Stripe. Planen lanseras officiellt inom kort.<br><br>
      <strong>Vi sparar din session</strong> ‚Äî n√§r betalning √§r aktivt kan du l√•sa upp utan att g√∂ra om formul√§ret.
    </div>
    <button onclick="document.getElementById('stripeModal').style.display='none'" 
            style="background:var(--ac);color:#fff;border:none;padding:14px 28px;border-radius:10px;font-weight:700;cursor:pointer;font-family:inherit;font-size:.95rem">
      St√§ng
    </button>
  </div>
</div>

<footer style="text-align:center;padding:40px 24px;border-top:1px solid var(--bo);color:var(--li);font-size:.82rem">
  <p>Studiev√§gsguiden ‚Äî Verktyget ers√§tter inte professionell studiev√§gledning.</p>
</footer>

<script>
// ‚ïê‚ïê‚ïê SHARED DATA + PLAN JS ‚ïê‚ïê‚ïê
const E=[
{id:1,t:'Sjuksk√∂terska',y:3,s0:34000,s1:43900,dem:5,ai:8,stress:4,future:5,tc:11000,req:['Naturkunskap 2','Matte 2a/b','Samh√§llskunskap 1b'],rp:['Naturvetenskap','Teknik'],pp:['Samh√§ll','Ekonomi'],
 sch:[
   {n:'Sjuksk√∂terskeprogrammet',school:'Karolinska Institutet',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026'],length:'3 √•r (180 hp)',csn:true,fee:0,lang:'swedish',cutoff:18.5,vfu:'46 veckor VFU',url:'https://ki.se/utbildning/sjukskoterska',p:1.45,t:['H√∂g ranking','Forskning','Top 3 Sverige']},
   {n:'Sjuksk√∂terskeprogrammet',school:'G√∂teborgs Universitet',c:'goteborg',f:'campus',pace:'fulltime',starts:['HT2026','VT2027'],length:'3 √•r (180 hp)',csn:true,fee:0,lang:'swedish',cutoff:17.2,vfu:'46 veckor VFU',url:'https://www.gu.se/studera/sjukskoterska',p:1.25,t:['Stort universitetssjukhus','Bred VFU']},
   {n:'Sjuksk√∂terskeprogrammet',school:'Uppsala Universitet',c:'uppsala',f:'campus',pace:'fulltime',starts:['HT2026'],length:'3 √•r (180 hp)',csn:true,fee:0,lang:'swedish',cutoff:16.8,vfu:'46 veckor VFU',url:'https://www.uu.se/utbildning/sjukskoterska',p:1.15,t:['Tradition','Akademiska sjukhuset']},
   {n:'Sjuksk√∂terskeprogrammet',school:'Linn√©universitetet',c:'other',f:'both',pace:'fulltime',starts:['HT2026','VT2027'],length:'3 √•r (180 hp)',csn:true,fee:0,lang:'swedish',cutoff:14.5,vfu:'46 veckor VFU',url:'https://lnu.se/sjukskoterska',p:.85,t:['Distansalternativ','Flexibelt','L√§gre krav']},
   {n:'Sjuksk√∂terskeprogrammet',school:'Malm√∂ Universitet',c:'malmo',f:'campus',pace:'fulltime',starts:['HT2026'],length:'3 √•r (180 hp)',csn:true,fee:0,lang:'swedish',cutoff:15.8,vfu:'46 veckor VFU',url:'https://mau.se/sjukskoterska',p:1.05,t:['Modernt','Praktikfokus']},
   {n:'Sjuksk√∂terskeprogrammet (distans)',school:'Mittuniversitetet',c:'other',f:'distance',pace:'fulltime',starts:['HT2026','VT2027'],length:'3 √•r (180 hp)',csn:true,fee:0,lang:'swedish',cutoff:13.2,vfu:'46 veckor VFU',url:'https://www.miun.se/sjukskoterska-distans',p:.7,t:['Distans','Flexibelt','Egen takt']}
 ],
 sc:{st:'V√•rdcentral / avdelning',ho:'Byter specialitet / region',sp:'IVA / anestesi / barnmorska',le:'V√•rdenhetschef'}},
{id:2,t:'Systemutvecklare',y:3,s0:35000,s1:54900,dem:4,ai:15,stress:2,future:4,tc:8000,req:['Matte 3c/4','Fysik 1a/2'],rp:['Naturvetenskap','Teknik'],pp:['Samh√§ll','Ekonomi'],
 sch:[
   {n:'Civilingenj√∂r Datateknik',school:'KTH',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026'],length:'5 √•r (300 hp)',csn:true,fee:0,lang:'swedish',cutoff:22.5,vfu:'',url:'https://www.kth.se/datateknik',p:1.65,t:['Top 3 Sverige','Forskningsn√§ra','H√∂gst ranking']},
   {n:'Systemvetenskapligt program',school:'Stockholms Universitet',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026','VT2027'],length:'3 √•r (180 hp)',csn:true,fee:0,lang:'swedish',cutoff:16.5,vfu:'',url:'https://www.su.se/systemvetenskap',p:1.35,t:['Bred IT-grund','L√§gre intr√§deskrav']},
   {n:'Mjukvaruutveckling och mobila plattformar',school:'Linn√©universitetet',c:'other',f:'both',pace:'fulltime',starts:['HT2026'],length:'3 √•r (180 hp)',csn:true,fee:0,lang:'swedish',cutoff:14.2,vfu:'',url:'https://lnu.se/mjukvaruutveckling',p:1.15,t:['Modern stack','Distansm√∂jlighet']},
   {n:'.NET-utvecklare',school:'Nackademin (YH)',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026','VT2027'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'12 veckor LIA',url:'https://nackademin.se/net-utvecklare',p:0,t:['YH','Praktikfokus','Snabb v√§g in']},
   {n:'Frontendutvecklare',school:'Medieinstitutet (YH)',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026','VT2027'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'16 veckor LIA',url:'https://medieinstitutet.se/frontend',p:0,t:['YH','Modern webbutveckling','H√∂g anst√§llningsgrad']},
   {n:'Webbutvecklare (distans)',school:'Jensen Yrkesh√∂gskola',c:'other',f:'distance',pace:'fulltime',starts:['HT2026'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'12 veckor LIA',url:'https://jensen.se/webbutvecklare-distans',p:0,t:['YH','Distans','Flexibelt']}
 ],
 sc:{st:'Utvecklare p√• f√∂retag',ho:'Konsult / byter bolag',sp:'Arkitekt / specialist',le:'Tech lead / CTO'}},
{id:3,t:'Grundl√§rare',y:3.5,s0:34000,s1:40200,dem:5,ai:5,stress:4,future:4,tc:10000,req:['Matte 2a/b','Engelska 6','Svenska 3'],rp:['Samh√§ll','Naturvetenskap','Ekonomi','Teknik'],pp:['Estet','V√•rd'],
 sch:[
   {n:'Grundl√§rarprogrammet F-3',school:'Stockholms Universitet',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026'],length:'4 √•r (240 hp)',csn:true,fee:0,lang:'swedish',cutoff:15.2,vfu:'30 veckor VFU',url:'https://www.su.se/grundlarare',p:1.1,t:['Stor l√§ros√§te','Bred metodikgrund']},
   {n:'Grundl√§rarprogrammet 4-6',school:'G√∂teborgs Universitet',c:'goteborg',f:'campus',pace:'fulltime',starts:['HT2026','VT2027'],length:'4 √•r (240 hp)',csn:true,fee:0,lang:'swedish',cutoff:14.8,vfu:'30 veckor VFU',url:'https://www.gu.se/grundlarare',p:1.0,t:['Pedagogisk profil','Flexibla starter']},
   {n:'Grundl√§rarprogrammet',school:'Link√∂pings Universitet',c:'linkoping',f:'both',pace:'fulltime',starts:['HT2026'],length:'4 √•r (240 hp)',csn:true,fee:0,lang:'swedish',cutoff:13.5,vfu:'30 veckor VFU',url:'https://liu.se/grundlarare',p:.9,t:['Campus + Distans','L√§gre krav']},
   {n:'Grundl√§rarprogrammet (distans)',school:'H√∂gskolan Dalarna',c:'other',f:'distance',pace:'fulltime',starts:['HT2026','VT2027'],length:'4 √•r (240 hp)',csn:true,fee:0,lang:'swedish',cutoff:12.0,vfu:'30 veckor VFU',url:'https://du.se/grundlarare-distans',p:.6,t:['Distans','N√§tbaserat','Flexibelt']},
   {n:'Grundl√§rarprogrammet',school:'Malm√∂ Universitet',c:'malmo',f:'campus',pace:'fulltime',starts:['HT2026'],length:'4 √•r (240 hp)',csn:true,fee:0,lang:'swedish',cutoff:14.2,vfu:'30 veckor VFU',url:'https://mau.se/grundlarare',p:.95,t:['M√•ngfald','Praktik']}
 ],
 sc:{st:'Klassrumsl√§rare',ho:'Byter skola / kommun',sp:'F√∂rstel√§rare',le:'Rektor / skolledare'}},
{id:4,t:'Civilekonom',y:4,s0:34000,s1:52000,dem:3,ai:25,stress:3,future:3,tc:9000,req:['Matte 3c/4','Engelska 6'],rp:['Naturvetenskap','Teknik','Ekonomi'],pp:['Samh√§ll'],
 sch:[
   {n:'Civilekonomprogrammet',school:'Handelsh√∂gskolan Stockholm',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026'],length:'4 √•r (240 hp)',csn:true,fee:0,lang:'swedish',cutoff:22.5,vfu:'',url:'https://www.hhs.se/civilekonom',p:1.9,t:['#1 Sverige','N√§tverk','Prestige']},
   {n:'Civilekonomprogrammet',school:'Handelsh√∂gskolan G√∂teborg',c:'goteborg',f:'campus',pace:'fulltime',starts:['HT2026'],length:'4 √•r (240 hp)',csn:true,fee:0,lang:'swedish',cutoff:21.0,vfu:'',url:'https://www.handels.gu.se/civilekonom',p:1.5,t:['Top 3','Internationellt']},
   {n:'Civilekonomprogrammet',school:'Uppsala Universitet',c:'uppsala',f:'campus',pace:'fulltime',starts:['HT2026'],length:'4 √•r (240 hp)',csn:true,fee:0,lang:'swedish',cutoff:19.8,vfu:'',url:'https://www.uu.se/civilekonom',p:1.3,t:['Tradition','Bred ekonomiutbildning']},
   {n:'Civilekonomprogrammet',school:'√ñrebro Universitet',c:'orebro',f:'campus',pace:'fulltime',starts:['HT2026','VT2027'],length:'4 √•r (240 hp)',csn:true,fee:0,lang:'swedish',cutoff:17.5,vfu:'',url:'https://oru.se/civilekonom',p:.9,t:['Mindre klasser','L√§gre krav']},
   {n:'Ekonomprogrammet',school:'Linn√©universitetet',c:'other',f:'both',pace:'fulltime',starts:['HT2026','VT2027'],length:'3 √•r (180 hp)',csn:true,fee:0,lang:'swedish',cutoff:15.2,vfu:'',url:'https://lnu.se/ekonom',p:.75,t:['Distansm√∂jlighet','3-√•rigt alternativ']}
 ],
 sc:{st:'Controller / ekonom',ho:'Konsult / byter bransch',sp:'Finansanalytiker',le:'CFO / VD'}},
{id:5,t:'Civilingenj√∂r Teknik',y:5,s0:38000,s1:58000,dem:4,ai:18,stress:2,future:5,tc:8000,req:['Matte 4','Fysik 2'],rp:['Naturvetenskap','Teknik'],pp:[],
 sch:[
   {n:'Civilingenj√∂r Maskinteknik',school:'KTH',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026'],length:'5 √•r (300 hp)',csn:true,fee:0,lang:'swedish',cutoff:22.0,vfu:'',url:'https://www.kth.se/civ-maskin',p:1.7,t:['Top 3 Sverige','Forskning','Bred profil']},
   {n:'Civilingenj√∂r Teknisk Fysik',school:'Chalmers',c:'goteborg',f:'campus',pace:'fulltime',starts:['HT2026'],length:'5 √•r (300 hp)',csn:true,fee:0,lang:'swedish',cutoff:21.5,vfu:'',url:'https://www.chalmers.se/teknisk-fysik',p:1.6,t:['Industrikontakter','Internationellt']},
   {n:'Civilingenj√∂r Datateknik',school:'Lunds Tekniska H√∂gskola',c:'lund',f:'campus',pace:'fulltime',starts:['HT2026'],length:'5 √•r (300 hp)',csn:true,fee:0,lang:'swedish',cutoff:21.0,vfu:'',url:'https://www.lth.se/datateknik',p:1.45,t:['LTH','IT-fokus']},
   {n:'Civilingenj√∂r Elektroteknik',school:'Link√∂pings Universitet',c:'linkoping',f:'campus',pace:'fulltime',starts:['HT2026'],length:'5 √•r (300 hp)',csn:true,fee:0,lang:'swedish',cutoff:19.5,vfu:'',url:'https://liu.se/elektroteknik',p:1.35,t:['Innovation','Startup-kultur']}
 ],
 sc:{st:'Ingenj√∂r p√• f√∂retag',ho:'Konsult / byter bransch',sp:'Teknisk specialist',le:'Engineering manager'}},
{id:51,t:'Civilingenj√∂r Industriell ekonomi',y:5,s0:38000,s1:60000,dem:4,ai:12,stress:2,future:5,tc:8000,req:['Matte 4'],rp:['Naturvetenskap','Teknik','Ekonomi'],pp:['Samh√§ll','Ekonomi'],
 sch:[
   {n:'Civilingenj√∂r Industriell ekonomi',school:'Link√∂pings Universitet',c:'linkoping',f:'campus',pace:'fulltime',starts:['HT2026'],length:'5 √•r (300 hp)',csn:true,fee:0,lang:'swedish',cutoff:20.5,vfu:'',url:'https://liu.se/industriell-ekonomi',p:1.5,t:['Ledning & teknik','Bred profil','Ej Fysik 2']},
   {n:'Civilingenj√∂r Industriell ekonomi',school:'Chalmers',c:'goteborg',f:'campus',pace:'fulltime',starts:['HT2026'],length:'5 √•r (300 hp)',csn:true,fee:0,lang:'swedish',cutoff:20.0,vfu:'',url:'https://www.chalmers.se/industriell-ekonomi',p:1.45,t:['Industrikontakter','G√∂teborgsregionen']},
   {n:'Civilingenj√∂r Samh√§llsbyggnad',school:'Lule√• Tekniska Universitet',c:'other',f:'campus',pace:'fulltime',starts:['HT2026'],length:'5 √•r (300 hp)',csn:true,fee:0,lang:'swedish',cutoff:17.0,vfu:'',url:'https://ltu.se/samhallsbyggnad',p:.85,t:['Gruvindustri','Norra Sverige','L√§gre krav']}
 ],
 sc:{st:'Teknisk chef / konsult',ho:'Aff√§rsutvecklare',sp:'Projektledare',le:'VP / VD'}},
{id:6,t:'Socionom',y:3.5,s0:35000,s1:40300,dem:4,ai:10,stress:5,future:4,tc:10000,req:['Samh√§llskunskap 1b','Matte 1b/c'],rp:['Samh√§ll','Naturvetenskap','Ekonomi','Teknik','V√•rd'],pp:['Estet'],
 sch:[
   {n:'Socionomprogrammet',school:'Stockholms Universitet',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026'],length:'3,5 √•r (210 hp)',csn:true,fee:0,lang:'swedish',cutoff:16.5,vfu:'26 veckor VFU',url:'https://www.su.se/socionom',p:1.3,t:['Stor utbildning','M√•ngfald']},
   {n:'Socionomprogrammet',school:'G√∂teborgs Universitet',c:'goteborg',f:'campus',pace:'fulltime',starts:['HT2026','VT2027'],length:'3,5 √•r (210 hp)',csn:true,fee:0,lang:'swedish',cutoff:15.8,vfu:'26 veckor VFU',url:'https://www.gu.se/socionom',p:1.2,t:['Socialt arbete','Bred praktik']},
   {n:'Socionomprogrammet',school:'Lunds Universitet',c:'lund',f:'campus',pace:'fulltime',starts:['HT2026'],length:'3,5 √•r (210 hp)',csn:true,fee:0,lang:'swedish',cutoff:15.5,vfu:'26 veckor VFU',url:'https://www.lunduniversity.lu.se/socionom',p:1.15,t:['Tradition','Forskning']},
   {n:'Socionomprogrammet (distans)',school:'Mittuniversitetet',c:'other',f:'distance',pace:'fulltime',starts:['HT2026','VT2027'],length:'3,5 √•r (210 hp)',csn:true,fee:0,lang:'swedish',cutoff:13.0,vfu:'26 veckor VFU',url:'https://www.miun.se/socionom-distans',p:.65,t:['Distans','Flexibelt','L√§gre krav']},
   {n:'Socionomprogrammet',school:'Ersta Sk√∂ndal Br√§cke h√∂gskola',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026'],length:'3,5 √•r (210 hp)',csn:true,fee:0,lang:'swedish',cutoff:14.2,vfu:'26 veckor VFU',url:'https://esh.se/socionom',p:.9,t:['Mindre skola','Personlig']}
 ],
 sc:{st:'Socialsekreterare',ho:'Byter kommun / verksamhet',sp:'Familjer√§tt / missbruk',le:'Enhetschef'}},
{id:7,t:'Elektriker (YH)',y:2,s0:30000,s1:37700,dem:5,ai:6,stress:3,future:5,tc:10000,req:['Matte 1a/b','Fysik 1a'],rp:['El och energi','Teknik','Naturvetenskap'],pp:['Bygg','Industri','Samh√§ll'],
 sch:[
   {n:'Elinstallation',school:'Yrgo',c:'goteborg',f:'campus',pace:'fulltime',starts:['HT2026','VT2027'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'26 veckor LIA',url:'https://www.yrgo.se/elinstallation',p:0,t:['YH','50% praktik','H√∂g anst√§llning']},
   {n:'Elektriker',school:'TUC Yrkesh√∂gskola',c:'other',f:'campus',pace:'fulltime',starts:['HT2026'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'26 veckor LIA',url:'https://www.tucsweden.se/elektriker',p:0,t:['YH','Rikst√§ckande','Bred bas']},
   {n:'Elinstallat√∂r',school:'Hermods',c:'other',f:'both',pace:'fulltime',starts:['HT2026','VT2027'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'26 veckor LIA',url:'https://www.hermods.se/elinstallator',p:0,t:['YH','Campus + Distans','Flexibelt']},
   {n:'Elektriker med inriktning automation',school:'Nackademin',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'20 veckor LIA',url:'https://nackademin.se/elektriker-automation',p:0,t:['YH','Automationsfokus','Stockholm']},
   {n:'Elektriker serviceteknik',school:'Jensen Yrkesh√∂gskola',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026','VT2027'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'26 veckor LIA',url:'https://jensen.se/elektriker',p:0,t:['YH','Serviceinriktad','Praktik']}
 ],
 sc:{st:'Installationselektriker',ho:'Byter arbetsgivare / ort',sp:'Automationstekniker',le:'Arbetsledare / eget f√∂retag'}},
{id:8,t:'UX-designer (YH)',y:2,s0:32000,s1:48000,dem:3,ai:22,stress:2,future:3,tc:8000,req:['Grundl√§ggande beh√∂righet'],rp:['Samh√§ll','Naturvetenskap','Ekonomi','Teknik','Estet'],pp:[],
 sch:[
   {n:'UX-designer',school:'Nackademin',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026','VT2027'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'16 veckor LIA',url:'https://nackademin.se/ux-designer',p:0,t:['YH','H√∂g kvalitet','Industrikontakter']},
   {n:'UX/UI-designer',school:'Yrgo',c:'goteborg',f:'campus',pace:'fulltime',starts:['HT2026'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'16 veckor LIA',url:'https://www.yrgo.se/ux-ui',p:0,t:['YH','Design-fokus','Portfolio']},
   {n:'UX/UI-designer',school:'Changemaker Educations',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026','VT2027'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'16 veckor LIA',url:'https://www.changemaker.se/ux-ui',p:0,t:['YH','Startup-k√§nsla','Modern']},
   {n:'Frontendutvecklare med UX',school:'Medieinstitutet',c:'stockholm',f:'campus',pace:'fulltime',starts:['HT2026','VT2027'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'16 veckor LIA',url:'https://medieinstitutet.se/ux-frontend',p:0,t:['YH','Kod + Design','Bred kompetens']},
   {n:'UX-designer (distans)',school:'Jensen Yrkesh√∂gskola',c:'other',f:'distance',pace:'fulltime',starts:['HT2026'],length:'2 √•r (400 YH-po√§ng)',csn:true,fee:0,lang:'swedish',cutoff:null,vfu:'16 veckor LIA',url:'https://jensen.se/ux-designer-distans',p:0,t:['YH','Distans','Flexibelt']}
 ],
 sc:{st:'In-house UX',ho:'Konsult / frilans',sp:'UX Research / Design systems',le:'Head of Design'}}
];
const CIT={stockholm:7000,goteborg:5500,malmo:5000,uppsala:5500,linkoping:4500,lund:5500,umea:4000,orebro:4500,other:4500};
const HOU={student:.75,shared:.85,rental:1.2,home:0};
const FIX=5450,BID=4120,WR=150;
const GYM=[{id:'natur',l:'Naturvetenskap',k:'Naturvetenskap'},{id:'teknik',l:'Teknik',k:'Teknik'},{id:'samhall',l:'Samh√§ll',k:'Samh√§ll'},{id:'ekonomi',l:'Ekonomi',k:'Ekonomi'},{id:'estet',l:'Estet',k:'Estet'},{id:'vard',l:'V√•rd och omsorg',k:'V√•rd'},{id:'bygg',l:'Bygg och anl√§ggning',k:'Bygg'},{id:'el',l:'El och energi',k:'El och energi'},{id:'industri',l:'Industri',k:'Industri'},{id:'other',l:'Annat / Komvux',k:'other'}];
let edu=null,sal=0,ws=0,ans={};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEV FUNCTION - SKIP TO PLAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function devFillAndShowPlan() {
  // Set salary and education (Systemutvecklare = id:2)
  sal = 22000;
  edu = E.find(e => e.id === 2); // Systemutvecklare
  
  if (!edu) {
    alert('‚ùå DEV: Kunde inte hitta Systemutvecklare (id:2)');
    console.error('E array:', E);
    return;
  }
  
  // Fill all answers - test scenario: 35-√•ring, bor i Stockholm, bo kvar hemma, jobbar heltid
  ans = {
    user_name: 'Test Testsson',
    user_phone: '0701234567',
    current_location: 'Stockholm',
    willing_to_move: 'no',
    education_type: ['yh', 'uni'],
    study_pace: 'fulltime',
    study_mode: 'campus',
    when_start: 'next',
    duration: 'any',
    fee_ok: 'no',
    gym: 'te',  // Teknikprogrammet - ger full beh√∂righet till Systemutvecklare
    has_grades: 'yes',
    age: '39',  // TEST 39-√•ring f√∂r att se alla personliga texter
    work_status: 'fulltime',
    need_csn: 'both',
    work_during: 'no',
    has_kids: 'no',
    has_partner: 'no',  // 'yes_same', 'no'
    housing: 'home',  // Bo kvar d√§r jag bor
    fixed_expenses: '8000',
    variable_expenses: '4000',
    savings_amount: '10-50'
  };
  
  // Build and show the plan
  try {
    buildFP('Test');
    document.getElementById('fpDiv').classList.add('v');
    document.getElementById('fpDiv').style.display='block';
    
    // Scroll to plan
    setTimeout(() => {
      const fpDiv = document.getElementById('fpDiv');
      if (fpDiv) {
        window.scrollTo({top: fpDiv.offsetTop - 70, behavior: 'smooth'});
      }
    }, 200);
    
    console.log('‚úÖ DEV: Test scenario loaded (35-√•ring)');
    console.log('  - Utbildning: Systemutvecklare (3 √•r)');
    console.log('  - L√∂n: 22000 kr ‚Üí 36000 kr (startl√∂n)');
    console.log('  - √Ölder: 35-44 (39 √•r) - testar alla personliga motivationstexter');
    console.log('  - Beh√∂righet: Teknikprogrammet = FULL beh√∂righet');
    console.log('  - Boende: Stockholm, bo kvar hemma');
    console.log('  - CSN-skuld: 180 000 kr');
    console.log('Expected: Personliga exempel, AI-risk, √•ldersstatistik, resursl√§nkar');
    // Spara till localStorage efter lyckad planbygge
    try{localStorage.setItem('svg_answers',JSON.stringify(ans));localStorage.setItem('svg_sal',sal||0);localStorage.setItem('svg_edu',edu?edu.id:0);}catch(e){}
  } catch (error) {
    console.error('‚ùå DEV: Error building plan:', error);
    const le=document.getElementById('planLoader');
    if(le){le.style.opacity='0';setTimeout(()=>le.remove(),300);}
    document.body.style.overflow='';
    const pw=document.getElementById('pwOverlay');
    if(pw) pw.remove();
    // Show visible fallback
    let fb=document.getElementById('fpDiv');
    if(!fb){fb=document.querySelector('.fp');}
    if(fb){
      fb.style.display='block';
      fb.innerHTML=`<div style="padding:60px 24px;text-align:center;max-width:500px;margin:0 auto">
        <div style="font-size:2.5rem;margin-bottom:16px">‚ö†Ô∏è</div>
        <h3 style="font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:12px;color:#1A1A18">N√•got gick fel</h3>
        <p style="color:#6c757d;font-size:.9rem;line-height:1.7;margin-bottom:24px">Vi kunde inte bygga din plan. Dina svar √§r sparade ‚Äî klicka nedan f√∂r att f√∂rs√∂ka igen.</p>
        <button onclick="location.reload()" style="background:var(--ac);color:#fff;border:none;padding:14px 32px;border-radius:10px;font-family:inherit;font-weight:700;font-size:.95rem;cursor:pointer">F√∂rs√∂k igen</button>
        <p style="font-size:.72rem;color:#bbb;margin-top:16px">${error.message||'Ok√§nt fel'}</p>
      </div>`;
    }
  }
}

const fmt=n=>n.toLocaleString('sv-SE');

function printPlan(){
    document.querySelectorAll('.pnl').forEach(p=>{p.style.display='block'});
    document.getElementById('planTabs').style.display='none';
    window.print();
    setTimeout(()=>{
        document.querySelectorAll('.pnl').forEach((p,i)=>{if(i>0)p.style.display='none'});
        document.getElementById('planTabs').style.display='';
    },1500);
}

// Init
document.addEventListener('DOMContentLoaded',function(){
    const s=document.getElementById('inEdu');
    if(!s){console.error('inEdu element not found');return}
    E.forEach(e=>{
        const o=document.createElement('option');
        o.value=e.id;
        o.textContent=e.t+' ('+e.y+' √•r)';
        s.appendChild(o);
    });
    // √Öterst√§ll snabbkalkyl fr√•n localStorage om plan redan gjorts
    try{
        const savedSal=localStorage.getItem('svg_sal');
        const savedEdu=localStorage.getItem('svg_edu');
        if(savedSal&&savedEdu&&parseInt(savedSal)>0&&parseInt(savedEdu)>0){
            const salEl=document.getElementById('inSal');
            const eduEl=document.getElementById('inEdu');
            if(salEl) salEl.value=savedSal;
            if(eduEl) eduEl.value=savedEdu;
            calcG();
        }
    }catch(e){}
});

// Step 1
function calcG(){
    sal=parseInt(document.getElementById('inSal').value)||0;
    const eid=parseInt(document.getElementById('inEdu').value);
    if(!sal||!eid){alert('Fyll i din l√∂n och v√§lj utbildning.');return}
    edu=E.find(e=>e.id===eid);
    const e=edu,bo=e.s0-sal,mo=Math.round(e.y*10),de=e.tc*mo,op=sal*12*e.y,yg=bo*12,be=yg>0?Math.ceil((op+de)/yg):0;
    document.getElementById('gvB').textContent=(bo>=0?'+':'')+fmt(bo)+' kr/m√•n';
    document.getElementById('gvD').textContent=Math.round(de/1000)+' tkr';
    document.getElementById('gvBE').textContent=be>0&&be<50?'~'+be+' √•r':'‚Äî';
    const em=document.getElementById('vE'),tx=document.getElementById('vT');
    if(bo>5000){em.innerHTML='<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>';tx.innerHTML='Med din l√∂n p√• <strong>'+fmt(sal)+' kr</strong> och en '+e.t.toLowerCase()+'-utbildning √§r ing√•ngsl√∂nen <strong>'+fmt(bo)+' kr/m√•n</strong> h√∂gre. Mot l√∂netoppen (+'+fmt(e.s1-sal)+' kr/m√•n) tar det 3‚Äì7 √•r.';}
    else if(bo>0){em.innerHTML='<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--bl)" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>';tx.innerHTML='Ing√•ngsl√∂nen √§r j√§mf√∂rbar, men l√∂netoppen p√• <strong>'+fmt(e.s1)+' kr</strong> (+'+fmt(e.s1-sal)+' kr) n√•s inom 5‚Äì10 √•r.';}
    else if(bo>-3000){em.innerHTML='<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--wa)" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>';tx.innerHTML='Ing√•ngsl√∂nen liknar din nuvarande. Men l√∂netaket (<strong>'+fmt(e.s1)+' kr</strong>) och arbetsvillkoren f√∂r√§ndras.';}
    else{em.innerHTML='<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--re)" stroke-width="2"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>';tx.innerHTML='Du tj√§nar redan mer. Ekonomiskt tar det tid. Men livskvalitet kan vara v√§rt mer √§n kronor.';}
    document.getElementById('secR').classList.add('v');
    setTimeout(()=>document.getElementById('secR').scrollIntoView({behavior:'smooth'}),100);
    document.querySelectorAll('.gc').forEach((c,i)=>setTimeout(()=>c.classList.add('sh2'),200+i*150));
    setTimeout(()=>document.getElementById('verd').classList.add('sh2'),800);
    buildInfoCards(e);
    buildProsAndCons(e);
    buildSalaryInfo(e);
    buildLifetimeAnalysis(e);
}

function buildInfoCards(e){
    const demL=['','Mycket l√•g','L√•g','Medel','H√∂g','Mycket h√∂g'];
    const strL=['','Mycket l√•g','L√•g','Medel','H√∂g','Mycket h√∂g'];
    const futL=['','Mycket svag','Svag','Stabil','God','Mycket god'];
    const demC=['','var(--re)','var(--wa)','var(--bl)','var(--ac)','var(--ac)'];
    const strC=['','var(--ac)','var(--ac)','var(--wa)','var(--re)','var(--re)'];
    const futC=['','var(--re)','var(--wa)','var(--bl)','var(--ac)','var(--ac)'];
    const demDesc={1:'F√• lediga tj√§nster och h√∂g konkurrens.',2:'Begr√§nsat antal tj√§nster. Kan ta tid.',3:'Balanserad arbetsmarknad.',4:'Arbetsgivare s√∂ker aktivt. Goda chanser.',5:'Akut brist. N√§stan garanterat jobb direkt.'};
    const strDesc={1:'Lugn milj√∂ med god balans.',2:'Hanterbar belastning, stressigt ibland.',3:'Omv√§xlande tempo, generellt balanserat.',4:'H√∂g belastning och tidpress regelbundet.',5:'Konstant h√∂gt tryck. H√∂g personaloms√§ttning.'};
    const futDesc={1:'Branschen krymper. Jobben minskar.',2:'Os√§ker framtid, risk f√∂r omst√§llning.',3:'Stabil bransch utan stora f√∂r√§ndringar.',4:'V√§xande bransch med √∂kande behov.',5:'Mycket stark tillv√§xt. AI-risk: '+e.ai+'%.'};

    const gvDem=document.getElementById('gvDem');
    const gvStr=document.getElementById('gvStr');
    const gvFut=document.getElementById('gvFut');
    gvDem.textContent=demL[e.dem];gvDem.style.color=demC[e.dem];
    gvStr.textContent=e.ai+'%';gvStr.style.color=e.ai>30?'var(--re)':e.ai>15?'var(--wa)':'var(--ac)';
    gvFut.textContent=futL[e.future];gvFut.style.color=futC[e.future];

    document.getElementById('gc4').querySelector('.gl').style.color=demC[e.dem];
    document.getElementById('gc5').querySelector('.gl').style.color=strC[e.stress];
    document.getElementById('gc6').querySelector('.gl').style.color=futC[e.future];

    document.getElementById('gceDem').innerHTML=`<div class="gcexp-inner"><p>${demDesc[e.dem]}</p><div class="gcbar"><div class="gcfill" style="width:${e.dem*20}%;background:${demC[e.dem]}"></div></div><div class="gcmeta"><span>L√•g</span><span>Mycket h√∂g</span></div></div>`;
    document.getElementById('gceStr').innerHTML=`<div class="gcexp-inner"><p>${strDesc[e.stress]}</p><div class="gcbar"><div class="gcfill" style="width:${e.stress*20}%;background:${strC[e.stress]}"></div></div><div class="gcmeta"><span>Lugnt</span><span>Mycket h√∂g</span></div></div>`;
    document.getElementById('gceFut').innerHTML=`<div class="gcexp-inner"><p>${futDesc[e.future]}</p><div class="gcbar"><div class="gcfill" style="width:${e.future*20}%;background:${futC[e.future]}"></div></div><div class="gcmeta"><span>Svag</span><span>Mycket god</span></div></div>`;
}

function toggleGC(el){el.classList.toggle('open')}

const PN={
1:{pro:['N√§stan 100% anst√§llningsbarhet ‚Äî akut brist i hela landet','OB-till√§gg f√∂r kv√§llar, n√§tter och helger h√∂jer faktisk l√∂n','M√∂jlighet att specialisera sig (IVA, ambulans, barnmorska) med l√∂nep√•slag','Offentlig anst√§llning med kollektivavtal, tj√§nstepension och full semester'],con:['Schemaarbete med n√§tter, helger och r√∂da dagar','Jour och beredskap kan kr√§vas beroende p√• avdelning','H√∂g personaloms√§ttning inom vissa specialiteter','L√∂netak ‚Äî begr√§nsad l√∂neutveckling utan chefsroll eller vidareutbildning']},
2:{pro:['36 000 kr ing√•ngsl√∂n med snabb stegring till 55 000+','Remote-arbete standard ‚Äî de flesta tj√§nster till√•ter hemifr√•n','Konsultuppdrag kan ge 50‚Äì80% h√∂gre timpris √§n fast anst√§llning','Kort utbildning (3 √•r) relativt l√∂neniv√•n'],con:['15% AI-automatiseringsrisk ‚Äî rutinkodning ers√§tts redan','Kr√§ver st√§ndig vidareutbildning vid teknikskiften','Internationell konkurrens pressar l√∂ner i vissa segment','Konsultmarknaden sv√§nger kraftigt med konjunkturen']},
3:{pro:['13 veckors sammanh√§ngande ledighet (lov) ut√∂ver semester','Jobb i alla kommuner ‚Äî ingen geografisk begr√§nsning','L√∂netill√§gg som f√∂rstel√§rare (+5 000 kr/m√•n)','Statliga studiel√•nsavskrivningar f√∂r l√§rare i brist√§mnen'],con:['H√∂g administrativ b√∂rda ‚Äî dokumentation, √•tg√§rdsprogram, omd√∂men','Stor l√§rarbrist leder till h√∂gre arbetsbelastning per l√§rare','L√∂netak runt 41 000 kr utan skolledarroll','Begr√§nsad karri√§rstege ‚Äî f√∂rstel√§rare eller rektor √§r i princip enda stegen']},
4:{pro:['Bred arbetsmarknad ‚Äî bank, revision, konsult, industri, startup','L√∂netak p√• 52 000+ kr, betydligt h√∂gre inom finans','Internationellt g√•ngbar examen med m√∂jlighet till utlandstj√§nst','Starkt alumnin√§tverk, s√§rskilt fr√•n handelsh√∂gskolorna'],con:['25% AI-automatiseringsrisk ‚Äî analys- och rapportarbete ers√§tts','H√•rd konkurrens om trainee- och graduate-platser','L√•nga arbetsdagar norm inom revision och investment banking','Stor variation i l√∂n beroende p√• bransch och stad']},
5:{pro:['H√∂gst ing√•ngsl√∂n av alla utbildningar (38 000 kr)','L√∂netak p√• 58 000+ kr, h√∂gre i chefsroll','Bred anst√§llningsbarhet ‚Äî tech, energi, fordon, bygg, f√∂rsvar','Stark internationell efterfr√•gan p√• svensk ingenj√∂rskompetens'],con:['5 √•rs utbildningstid ‚Äî l√§ngst av alla alternativ','H√∂g studietakt med matematik, fysik och kemi','18% AI-risk ‚Äî simulering och ber√§kningsarbete automatiseras','Kr√§ver ofta flytt till storstadsregion f√∂r b√§sta tj√§nsterna']},
6:{pro:['Stor efterfr√•gan ‚Äî kommuner har sv√•rt att rekrytera socialsekreterare','Bred arbetsmarknad: socialtj√§nst, kriminalv√•rd, migration, skola','Offentlig anst√§llning med kollektivavtal och tj√§nstepension','Relativt kort utbildning (3,5 √•r) med praktik (VFU)'],con:['H√∂gst personaloms√§ttning inom socialtj√§nsten ‚Äî snitt 2‚Äì3 √•r','Tunga myndighetsut√∂vningsbeslut (LVU, tv√•ngsomh√§ndertaganden)','L√§gst ing√•ngsl√∂n av alla h√∂gskoleutbildningar i listan (30 000 kr)','H√∂g sjukfr√•nvaro i branschen j√§mf√∂rt med andra yrken']},
7:{pro:['Mycket h√∂g efterfr√•gan ‚Äî elektrikerbrist i hela landet','Kort utbildning (2 √•r) med 50% praktik p√• f√∂retag','Snabb l√∂neutveckling med certifikat och beh√∂righeter','M√∂jlighet till eget f√∂retag med relativt l√•g startkostnad'],con:['Jour och beredskap kr√§vs, √§ven helger och kv√§llar','Fysiskt kr√§vande med arbete i tr√•nga utrymmen och h√∂jder','Els√§kerhetsrisker ‚Äî strikt reglerat med personligt ansvar','Konjunkturk√§nsligt ‚Äî byggsektorn styr efterfr√•gan']},
8:{pro:['32 000 kr ing√•ngsl√∂n med potential upp till 48 000+','Kort utbildning (2 √•r YH) med praktik p√• riktiga f√∂retag','Remote och frilans vanligt ‚Äî h√∂g geografisk flexibilitet','Tv√§rfunktionell roll som fungerar i de flesta branscher'],con:['22% AI-risk ‚Äî designverktyg automatiserar allt mer','Stor konkurrens om juniora tj√§nster efter examen','Ofta bland de f√∂rsta som s√§gs upp vid nedsk√§rningar','Sv√•rt att kvantifiera aff√§rsv√§rde ‚Äî budgeten sk√§rs l√§tt ned']},
51:{pro:['H√∂gst l√∂nepotential i listan ‚Äî 60 000 kr och upp√•t','Kombinerar ingenj√∂rskunskap med f√∂retagsledning ‚Äî bred arbetsmarknad','Ledande positioner inom industri, konsult och tech','Starkt alumnin√§tverk vid Chalmers, LiTH och KTH'],con:['5 √•rs utbildningstid ‚Äî l√•ngt √•tagande','Kr√§ver Matte 4 ‚Äî ofta komplettering via Komvux','Konkurrens om de b√§sta traineepositionerna √§r h√•rd','L√∂n kan variera kraftigt beroende p√• bransch och region']}
};

function buildProsAndCons(e){
    const d=PN[e.id];if(!d)return;
    const chk='<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>';
    const cross='<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
    let h=`<div class="pnbox pnpro"><div class="pnhead"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>F√∂rdelar</div><div class="pnlist">`;
    d.pro.forEach(p=>{h+=`<div class="pnitem">${chk}<span>${p}</span></div>`});
    h+=`</div></div><div class="pnbox pncon"><div class="pnhead"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>Nackdelar</div><div class="pnlist">`;
    d.con.forEach(c=>{h+=`<div class="pnitem">${cross}<span>${c}</span></div>`});
    h+=`</div></div>`;
    document.getElementById('pnCont').innerHTML=h;
    document.querySelectorAll('.pnbox').forEach((b,i)=>setTimeout(()=>b.classList.add('sh2'),900+i*150));
}

function buildSalaryInfo(e){
    // Ber√§kna medell√∂n (genomsnitt av start och max)
    const avgSalary=Math.round((e.s0+e.s1)/2);
    // Medianl√∂n (approximativt mitt-l√∂nen efter n√•gra √•rs erfarenhet)
    const medianSalary=Math.round(e.s0+(e.s1-e.s0)*0.4);
    // Spridning (skillnad mellan min och max)
    const spread=e.s1-e.s0;
    const spreadPct=Math.round((spread/e.s0)*100);
    
    // Karri√§rscenarier
    const scenarios=[
        {label:'Stanna l√§nge',desc:'10-15 √•r p√• samma arbetsplats',salary:Math.round(e.s0+(e.s1-e.s0)*0.5),color:'#6c757d'},
        {label:'Byta ofta',desc:'5-10 byten av arbetsgivare',salary:Math.round(e.s0+(e.s1-e.s0)*0.7),color:'#0dcaf0'},
        {label:'Specialist',desc:'Expertroll utan chefsansvar',salary:Math.round(e.s1*1.1),color:'#0d6efd'},
        {label:'Chef',desc:'Ledande position',salary:Math.round(e.s1*1.3),color:'#198754'}
    ];
    const maxSalary=Math.max(...scenarios.map(s=>s.salary));
    
    let h=`
    <button onclick="const d=document.getElementById('salaryExpand');const open=d.style.display!=='none';d.style.display=open?'none':'block';this.textContent=open?'Visa l√∂nespridning ‚Üì':'D√∂lj l√∂nespridning ‚Üë'" 
    style="width:100%;padding:14px;background:linear-gradient(135deg,var(--ac),var(--ah));color:#fff;border:none;border-radius:12px;font-weight:700;font-size:.95rem;cursor:pointer;transition:transform .2s;max-width:720px;display:block;margin:0 auto 0;font-family:inherit"
    onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        Visa l√∂nespridning ‚Üì
    </button>
    <div id="salaryExpand" style="display:none;max-width:720px;margin:0 auto">
    <div class="verd sh2" style="animation-delay:.7s;text-align:left;padding:24px 20px;margin-top:12px">
<div style="text-align:center;margin-bottom:20px">
        <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2" style="margin:0 auto 10px">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
          <polyline points="17 6 23 6 23 12"/>
        </svg>
        <h3 style="font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:6px">L√∂nespridning f√∂r ${e.t.toLowerCase()}</h3>
        <p style="color:var(--mu);font-size:.85rem">Baserat p√• SCB L√∂nestrukturstatistik 2024</p>
      </div>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:18px">
        <div style="padding:16px;background:var(--al);border-radius:12px;border:2px solid var(--ac)">
          <div style="font-size:.75rem;font-weight:700;color:var(--ac);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Startl√∂n</div>
          <div style="font-family:'DM Serif Display',serif;font-size:1.8rem;color:var(--ac);margin-bottom:4px">${fmt(e.s0)} kr</div>
          <div style="font-size:.8rem;color:var(--mu)">Efter examen</div>
        </div>
        
        <div style="padding:16px;background:#f8f9fa;border-radius:12px;border:2px solid #dee2e6">
          <div style="font-size:.75rem;font-weight:700;color:#495057;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Medell√∂n</div>
          <div style="font-family:'DM Serif Display',serif;font-size:1.8rem;color:#212529;margin-bottom:4px">${fmt(avgSalary)} kr</div>
          <div style="font-size:.8rem;color:var(--mu)">Genomsnitt i yrket</div>
        </div>
        
        <div style="padding:16px;background:#f8f9fa;border-radius:12px;border:2px solid #dee2e6">
          <div style="font-size:.75rem;font-weight:700;color:#495057;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Medianl√∂n</div>
          <div style="font-family:'DM Serif Display',serif;font-size:1.8rem;color:#212529;margin-bottom:4px">${fmt(medianSalary)} kr</div>
          <div style="font-size:.8rem;color:var(--mu)">50% tj√§nar mer</div>
        </div>
        
        <div style="padding:16px;background:var(--al);border-radius:12px;border:2px solid var(--ac)">
          <div style="font-size:.75rem;font-weight:700;color:var(--ac);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Erfaren</div>
          <div style="font-family:'DM Serif Display',serif;font-size:1.8rem;color:var(--ac);margin-bottom:4px">${fmt(e.s1)} kr</div>
          <div style="font-size:.8rem;color:var(--mu)">Efter 10-15 √•r</div>
        </div>
      </div>
      
      <div style="padding:20px;background:#fff;border-radius:12px;border:1px solid var(--bo)">
        <div style="font-weight:700;margin-bottom:12px;font-size:1.05rem">L√∂nespridning: ${fmt(spread)} kr (+${spreadPct}%)</div>
        <div style="background:#e0e0d8;height:8px;border-radius:10px;overflow:hidden">
          <div style="background:linear-gradient(90deg,var(--ac),var(--ac));height:100%;width:100%;position:relative">
            <div style="position:absolute;left:0;top:-24px;font-size:.75rem;font-weight:600;color:var(--ac)">${fmt(e.s0)} kr</div>
            <div style="position:absolute;right:0;top:-24px;font-size:.75rem;font-weight:600;color:var(--ac)">${fmt(e.s1)} kr</div>
          </div>
        </div>
        <div style="font-size:.85rem;color:var(--mu);margin-top:16px">
          <strong>Vad p√•verkar l√∂nen?</strong> Erfarenhet, arbetsgivare, f√∂rhandling, specialisering och chefsansvar.
        </div>
      </div>
      
      <!-- Expanderbar karri√§rscenarier -->
      <button onclick="document.getElementById('scenariosExpand').style.display=document.getElementById('scenariosExpand').style.display==='none'?'block':'none';this.innerHTML=document.getElementById('scenariosExpand').style.display==='none'?'Visa karri√§rscenarier ‚Üì':'D√∂lj karri√§rscenarier ‚Üë'" style="width:100%;margin-top:16px;padding:14px;background:linear-gradient(135deg,var(--ac),var(--ah));color:#fff;border:none;border-radius:12px;font-weight:700;font-size:.95rem;cursor:pointer;transition:transform .2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        Visa karri√§rscenarier ‚Üì
      </button>
      
      <div id="scenariosExpand" style="display:none;margin-top:16px;padding:20px;background:#f8f9fa;border-radius:12px">
        <h4 style="font-weight:700;margin-bottom:14px;font-size:1.05rem;color:var(--ac)">Olika v√§gar ger olika l√∂ner efter 10-15 √•r</h4>
        <div style="display:grid;gap:12px">`;
    
    scenarios.forEach(sc=>{
        const widthPct=(sc.salary/maxSalary)*100;
        const diff=sc.salary-e.s0;
        const diffPct=Math.round((diff/e.s0)*100);
        
        h+=`
        <div style="padding:14px;background:#fff;border-radius:10px;border:1px solid var(--bo)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <div style="font-weight:700;font-size:.9rem">${sc.label}</div>
              <div style="font-size:.75rem;color:var(--mu)">${sc.desc}</div>
            </div>
            <div style="text-align:right">
              <div style="font-family:'DM Serif Display',serif;font-size:1.2rem;color:${sc.color}">${fmt(sc.salary)} kr</div>
              <div style="font-size:.7rem;color:var(--mu)">+${diffPct}%</div>
            </div>
          </div>
          <div style="background:#e9ecef;height:28px;border-radius:6px;overflow:hidden;position:relative">
            <div style="background:${sc.color};height:100%;width:${widthPct}%;transition:width 1s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:8px">
              <span style="color:#fff;font-weight:600;font-size:.8rem">${Math.round(widthPct)}%</span>
            </div>
          </div>
        </div>`;
    });
    
    h+=`
        </div>
        <div style="margin-top:16px;padding:14px;background:#fff;border-radius:8px;font-size:.8rem;color:var(--mu);border-left:3px solid var(--ac)">
          <strong style="color:var(--ac)">Tips:</strong> Att byta jobb var 3-5:e √•r ger ofta h√∂gre l√∂neutveckling √§n att stanna kvar.
        </div>
      </div>
      
      <!-- Expanderbar livstidsanalys -->
      <button onclick="document.getElementById('lifetimeExpand').style.display=document.getElementById('lifetimeExpand').style.display==='none'?'block':'none';this.innerHTML=document.getElementById('lifetimeExpand').style.display==='none'?'Visa livstidsanalys ‚Üì':'D√∂lj livstidsanalys ‚Üë'" style="width:100%;margin-top:16px;padding:14px;background:linear-gradient(135deg,#5a8a6e,var(--ac));color:#fff;border:none;border-radius:12px;font-weight:700;font-size:.95rem;cursor:pointer;transition:transform .2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        Visa livstidsanalys ‚Üì
      </button>
      
      <div id="lifetimeExpand" style="display:none;margin-top:16px;padding:20px;background:#f8f9fa;border-radius:12px">
        <h4 style="font-weight:700;margin-bottom:14px;font-size:1.05rem;color:var(--ac)">J√§mf√∂relse √∂ver 40 √•rs arbetsliv</h4>
        <div id="lifetimeChart"></div>
        <div style="margin-top:14px;padding:12px;background:#fff;border-radius:8px;font-size:.75rem;color:var(--mu);border-left:3px solid var(--ac)">
          <strong style="color:var(--ac)">OBS:</strong> F√∂renklad kalkyl utan h√§nsyn till inflation, l√∂ne√∂kningar eller skatter.
        </div>
      </div>
        </div>
    </div>`;

    document.getElementById('salaryInfo').innerHTML=h;
}


function buildLifetimeAnalysis(e){
    const workYears=40;
    const studyYears=e.y;
    
    // Scenario 1: Forts√§tt med nuvarande jobb
    const currentTotal=(sal*12*workYears)/1000000;
    
    // Scenario 2: Plugga f√∂rst, sedan nytt yrke
    const lostIncome=sal*12*studyYears;
    const debt=e.tc*Math.round(studyYears*10);
    const newJobYears=workYears-studyYears;
    const newJobIncome=(e.s0*12*newJobYears)/1000000;
    const studyCost=(lostIncome+debt)/1000000;
    const newTotal=newJobIncome-studyCost;
    
    // Skillnad
    const diff=newTotal-currentTotal;
    const diffAbs=Math.abs(diff);
    
    // Maxv√§rde f√∂r skalning
    const maxVal=Math.max(currentTotal,newTotal);
    const currentPct=(currentTotal/maxVal)*100;
    const newPct=(newTotal/maxVal)*100;
    
    // F√§rgkodning
    const betterColor=diff>0?'var(--ac)':'var(--re)';
    const worseColor=diff>0?'var(--re)':'var(--ac)';
    
    let h=`
    <div style="margin-bottom:28px">
      <div style="display:grid;gap:20px">
        <!-- Nuvarande yrke -->
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-size:.82rem;font-weight:600;color:var(--mu)">Forts√§tt med nuvarande jobb</div>
            <div style="font-size:1.1rem;font-weight:700;color:${diff<=0?betterColor:worseColor}">${currentTotal.toFixed(1)} M kr</div>
          </div>
          <div style="height:36px;background:var(--bo);border-radius:8px;overflow:hidden;position:relative">
            <div style="height:100%;background:${diff<=0?betterColor:worseColor};width:${currentPct}%;transition:width 1s ease;border-radius:8px"></div>
          </div>
          <div style="font-size:.72rem;color:var(--li);margin-top:4px">${sal.toLocaleString('sv-SE')} kr/m√•n √ó ${workYears} √•r</div>
        </div>
        
        <!-- Nytt yrke -->
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-size:.82rem;font-weight:600;color:var(--mu)">Plugga till ${e.t.toLowerCase()}</div>
            <div style="font-size:1.1rem;font-weight:700;color:${diff>0?betterColor:worseColor}">${newTotal.toFixed(1)} M kr</div>
          </div>
          <div style="height:36px;background:var(--bo);border-radius:8px;overflow:hidden;position:relative">
            <div style="height:100%;background:${diff>0?betterColor:worseColor};width:${newPct}%;transition:width 1s ease .3s;border-radius:8px"></div>
          </div>
          <div style="font-size:.72rem;color:var(--li);margin-top:4px">${e.s0.toLocaleString('sv-SE')} kr/m√•n √ó ${newJobYears} √•r ‚àí studiekostnad (${studyCost.toFixed(1)} M kr)</div>
        </div>
      </div>
    </div>
    
    <!-- Skillnadsruta -->
    <div style="background:${diff>0?'var(--al)':'var(--rl)'};border:2px solid ${diff>0?'var(--ac)':'var(--re)'};border-radius:12px;padding:20px;text-align:center">
      <div style="font-size:.78rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:${diff>0?'var(--ac)':'var(--re)'};margin-bottom:6px">
        ${diff>0?'Livstidsvinst':'Livstidsf√∂rlust'}
      </div>
      <div style="font-family:'DM Serif Display',serif;font-size:2rem;color:${diff>0?'var(--ac)':'var(--re)'};margin-bottom:6px">
        ${diff>0?'+':'‚àí'}${diffAbs.toFixed(1)} M kr
      </div>
      <div style="font-size:.85rem;color:${diff>0?'var(--ac)':'var(--re)'};opacity:.85">
        ${diff>0?'Att plugga ger dig totalt '+diffAbs.toFixed(1)+' miljoner mer √∂ver 40 √•r':'Med nuvarande l√∂n tj√§nar du '+diffAbs.toFixed(1)+' miljoner mer √∂ver 40 √•r'}
      </div>
    </div>`;
    
    document.getElementById('lifetimeChart').innerHTML=h;
}

function buildTeaser(){
    const e=edu,netNow=Math.round(sal*0.7);
    const debt=Math.round(e.y*10*6000);
    const monthlySave=netNow-(BID+6000);

    document.getElementById('tOverH').textContent='Din v√§g till '+e.t.toLowerCase()+' ‚Äî klar om '+e.y+' √•r';
    document.getElementById('tOverP').textContent='Vi har r√§knat p√• just din situation. Svara p√• n√•gra fr√•gor s√• l√•ser vi upp hela planen.';

    document.getElementById('tBl').innerHTML=`
    <div style="margin-bottom:14px">
    <div style="background:linear-gradient(135deg,var(--ac),var(--ah));border-radius:12px;padding:20px;color:#fff">
    <div style="font-family:'DM Serif Display',serif;font-size:1.15rem;margin-bottom:6px">Du, ${Math.round(sal/1000)}k/m√•n ‚Äî ${e.t} om ${e.y} √•r</div>
    <div style="opacity:.85;font-size:.84rem">L√∂n idag: ${fmt(sal)} kr ‚Üí Ing√•ngsl√∂n: ${fmt(e.s0)} kr (+${fmt(e.s0-sal)} kr/m√•n)</div>
    </div></div>

    <div style="margin-bottom:14px">
    <div class="tsec-head"><div class="tn" style="background:var(--ac)">1</div>Din beh√∂righet</div>
    </div>
    <div style="margin-bottom:14px">
    <div style="padding:14px;border-radius:8px;border:2px solid var(--ac);background:var(--al)">
    <div style="font-weight:700;font-size:.9rem;color:var(--ac)">Beh√∂rig? Vi kollar dina kurser mot programmets krav.</div>
    <div style="font-size:.82rem;color:var(--mu);margin-top:4px">${e.req.join(' ¬∑ ')}</div>
    </div></div>

    <div style="margin-bottom:14px">
    <div class="tsec-head"><div class="tn" style="background:var(--re)">2</div>Din ekonomi under studietiden</div>
    </div>
    <div style="margin-bottom:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f5f5f0;border-radius:8px">
    <span style="font-size:.84rem">Din bruttol√∂n idag</span><span style="font-weight:700">${fmt(netNow)} kr</span>
    </div></div>
    <div style="margin-bottom:14px;margin-top:6px">
    <div style="display:flex;justify-content:space-between;padding:12px;background:var(--bll);border-radius:8px">
    <span style="font-size:.84rem">Studentinkomst (CSN + jobb)</span><span style="font-weight:700;color:var(--bl)">${fmt(BID+6000)} kr</span>
    </div></div>
    <div style="margin-bottom:14px;margin-top:6px">
    <div style="padding:14px;background:var(--al);border-radius:8px;text-align:center;font-weight:700;color:var(--ac)">
    ${monthlySave>0?'Du tappar '+fmt(monthlySave)+' kr/m√•n ‚Äî men vi visar hur det fungerar':'Din studentinkomst t√§cker mer √§n du tror'}
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px">
    <div style="background:var(--rl);padding:12px;border-radius:8px;text-align:center"><div style="font-size:.65rem;font-weight:700;color:var(--re);text-transform:uppercase">Total skuld</div><div style="font-family:'DM Serif Display';font-size:1rem;color:var(--re)">${fmt(debt)} kr</div></div>
    <div style="background:var(--wl);padding:12px;border-radius:8px;text-align:center"><div style="font-size:.65rem;font-weight:700;color:#92400e;text-transform:uppercase">Kvar/m√•n</div><div style="font-family:'DM Serif Display';font-size:1rem;color:#92400e">? kr</div></div>
    <div style="background:var(--al);padding:12px;border-radius:8px;text-align:center"><div style="font-size:.65rem;font-weight:700;color:var(--ac);text-transform:uppercase">Break-even</div><div style="font-family:'DM Serif Display';font-size:1rem;color:var(--ac)">? √•r</div></div>
    </div></div>

    <div style="margin-bottom:14px;margin-top:8px">
    <div class="tsec-head"><div class="tn" style="background:var(--wa)">3</div>Din handlingsplan</div>
    </div>
    <div style="margin-bottom:14px">
    <div style="display:flex;gap:12px;margin-bottom:10px"><div style="width:28px;height:28px;border-radius:50%;background:var(--ac);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;flex-shrink:0">1</div><div><div style="font-weight:700;font-size:.88rem">Kontrollera dina betyg</div><div style="font-size:.78rem;color:var(--ac)">Denna vecka</div></div></div>
    <div style="display:flex;gap:12px;margin-bottom:10px"><div style="width:28px;height:28px;border-radius:50%;background:var(--ac);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;flex-shrink:0">2</div><div><div style="font-weight:700;font-size:.88rem">Ans√∂k till programmet</div><div style="font-size:.78rem;color:var(--ac)">Senast 15 april</div></div></div>
    <div style="display:flex;gap:12px"><div style="width:28px;height:28px;border-radius:50%;background:var(--ac);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;flex-shrink:0">3</div><div><div style="font-weight:700;font-size:.88rem">Studiestart ‚Äî ${e.t}</div><div style="font-size:.78rem;color:var(--ac)">H√∂sten ${new Date().getFullYear()+(new Date().getMonth()<5?0:1)}</div></div></div>
    </div>

    <div style="margin-bottom:60px">
    <div style="display:grid;gap:6px">
    <div style="background:#f5f5f0;padding:10px 12px;border-radius:8px;display:flex;justify-content:space-between"><span>Checklista: 3 saker att g√∂ra imorgon</span><span style="font-weight:700">‚Üí</span></div>
    <div style="background:#f5f5f0;padding:10px 12px;border-radius:8px;display:flex;justify-content:space-between"><span>Skolor som matchar dig</span><span style="font-weight:700">‚Üí</span></div>
    <div style="background:#f5f5f0;padding:10px 12px;border-radius:8px;display:flex;justify-content:space-between"><span>Boka samtal med yrkesperson</span><span style="font-weight:700">‚Üí</span></div>
    </div></div>`;
}

// Wizard
const QS=[
    // Del 1 ‚Äì Studiepreferenser
    {id:'current_location',t:'Var bor du idag?',w:'Hj√§lper oss ber√§kna boendekostnader och pendling.',tp:'text',ph:'T.ex. Stockholm, G√∂teborg...'},
    {id:'education_type',t:'Vilken utbildningsform s√∂ker du?',w:'V√§lj en eller flera alternativ.',tp:'multi',opts:[{v:'yh',l:'Yrkesh√∂gskola (YH)'},{v:'uni',l:'H√∂gskola / Universitet'},{v:'komvux',l:'Komvux'},{v:'folk',l:'Folkh√∂gskola'},{v:'private',l:'Privat utbildning'},{v:'any',l:'Spelar ingen roll'}]},
    {id:'study_pace',t:'Vilken studietakt passar dig?',w:'Avg√∂r om du kan arbeta samtidigt.',tp:'opts',opts:[{v:'fulltime',l:'Heltid'},{v:'parttime',l:'Deltid'},{v:'flexible',l:'Flexibel'},{v:'any',l:'Spelar ingen roll'}]},
    {id:'study_mode',t:'Hur vill du studera?',w:'P√•verkar dina studiealternativ.',tp:'opts',opts:[{v:'campus',l:'P√• plats'},{v:'distance',l:'Distans'},{v:'hybrid',l:'Hybrid'},{v:'any',l:'Spelar ingen roll'}]},
    {id:'willing_to_move',t:'√Ñr du villig att flytta f√∂r studier?',w:'P√•verkar vilka skolor som passar dig.',tp:'opts',cond:()=>ans.study_mode!=='distance',opts:[{v:'yes',l:'Ja'},{v:'no',l:'Nej'},{v:'commute',l:'Pendlingsavst√•nd'}]},
    {id:'when_start',t:'N√§r vill du b√∂rja studera?',w:'Styr tidslinjen i din plan.',tp:'opts',opts:[{v:'asap',l:'S√• snart som m√∂jligt'},{v:'next',l:'N√§sta termin'},{v:'6mo',l:'Inom 6 m√•nader'},{v:'12mo',l:'Inom 12 m√•nader'},{v:'any',l:'Spelar ingen roll'}]},
    {id:'duration',t:'Hur l√•ng utbildning √§r du beredd att g√•?',w:'Filtrerar bort f√∂r l√•nga program.',tp:'opts',opts:[{v:'short',l:'Kortare √§n 6 m√•nader'},{v:'6to12',l:'6‚Äì12 m√•nader'},{v:'1to2',l:'1‚Äì2 √•r'},{v:'3plus',l:'3 √•r eller l√§ngre'},{v:'any',l:'Spelar ingen roll'}]},
    {id:'fee_ok',t:'√Ñr du √∂ppen f√∂r avgiftsbelagda utbildningar?',w:'Privata YH och utbildningar kan kosta.',tp:'opts',opts:[{v:'yes',l:'Ja'},{v:'no',l:'Nej'},{v:'unsure',l:'Os√§ker'}]},

    // Del 2 ‚Äì Beh√∂righet
    {id:'gym',t:'Vilket gymnasieprogram gick du?',w:'Avg√∂r om du har r√§tt beh√∂righet eller beh√∂ver komplettera.',tp:'opts',opts:GYM.map(g=>({v:g.id,l:g.l}))},
    {id:'has_grades',t:'Har du fullst√§ndiga gymnasiebetyg?',w:'Avg√∂r om du kan s√∂ka direkt.',tp:'opts',opts:[{v:'yes',l:'Ja'},{v:'no',l:'Nej'},{v:'unsure',l:'Os√§ker'}]},
    {id:'hp_considered',t:'Har du skrivit H√∂gskoleprov (HP)?',w:'Ange ditt verbala och kvantitativa delbetyg (t.ex. 1.4, 1.6). Om du inte har skrivit klickar du Nej.',tp:'hp'},

    // Del 3 ‚Äì Nuvarande situation
    {id:'age',t:'Hur gammal √§r du?',w:'P√•verkar skuldfri √•lder och livstidsber√§kning.',tp:'input',ph:'T.ex. 29',inputType:'number',min:18,max:70},
    {id:'work_status',t:'Arbetar du idag?',w:'Avg√∂r om du tappar inkomst under studier.',tp:'opts',opts:[{v:'fulltime',l:'Heltid'},{v:'parttime',l:'Deltid'},{v:'hourly',l:'Timanst√§lld'},{v:'unemployed',l:'Arbetss√∂kande'},{v:'other',l:'Annat'}]},
    {id:'need_csn',t:'Kommer du beh√∂va studiest√∂d fr√•n CSN under utbildningen?',w:'Avg√∂r din studentbudget.',tp:'opts',opts:[{v:'both',l:'Ja, bidrag och l√•n'},{v:'grant',l:'Endast bidrag'},{v:'no',l:'Nej'},{v:'unsure',l:'Os√§ker'}]},
    {id:'work_during',t:'Planerar du att arbeta vid sidan av studierna?',w:'P√•verkar din totala inkomst.',tp:'opts',opts:[{v:'parttime',l:'Ja, deltid'},{v:'extra',l:'Ja, extra vid behov'},{v:'no',l:'Nej'},{v:'unsure',l:'Os√§ker'}]},

    // Del 4 ‚Äì Familj / ansvar
    {id:'has_kids',t:'Har du barn eller ekonomiskt ansvar f√∂r andra?',w:'P√•verkar barntill√§gg och budget.',tp:'opts',opts:[{v:'yes',l:'Ja'},{v:'no',l:'Nej'}]},
    {id:'num_kids',t:'Hur m√•nga barn har du?',w:'',tp:'opts',cond:()=>ans.has_kids==='yes',opts:[{v:'1',l:'1'},{v:'2',l:'2'},{v:'3',l:'3'},{v:'4plus',l:'4 eller fler'}]},
    {id:'has_partner',t:'Har du sambo?',w:'P√•verkar hush√•llsekonomi.',tp:'opts',opts:[{v:'yes_same',l:'Ja'},{v:'no',l:'Nej'}]},

    // Del 5 ‚Äì Boende & utgifter
    {id:'housing',t:'Hur t√§nker du bo under studietiden?',w:'Best√§mmer din boendekostnad i budgeten.',tp:'opts',opts:[{v:'student',l:'Studentboende / korridor'},{v:'shared',l:'Dela l√§genhet'},{v:'rental',l:'Egen hyresr√§tt'},{v:'home',l:'Bo kvar d√§r jag bor'}]},
    {id:'fixed_expenses',t:'Hur mycket har du i fasta utgifter per m√•nad?',w:'Hyra, el, f√∂rs√§kringar, abonnemang.',tp:'input',ph:'T.ex. 8500',su:'kr/m√•n',cond:()=>ans.housing==='home'},
    {id:'variable_expenses',t:'Hur mycket har du i r√∂rliga utgifter per m√•nad?',w:'Mat, n√∂je, kl√§der, transport.',tp:'input',ph:'T.ex. 4000',su:'kr/m√•n',cond:()=>ans.housing==='home'},

    // Del 6 ‚Äì Sparande
    {id:'savings_amount',t:'Hur mycket har du sparat som kan anv√§ndas under studietiden?',w:'CSN tar ~6 veckor innan f√∂rsta utbetalning.',tp:'opts',opts:[{v:'none',l:'Inget'},{v:'under10',l:'Under 10 000 kr'},{v:'10-50',l:'10 000‚Äì49 999 kr'},{v:'50-100',l:'50 000‚Äì99 999 kr'},{v:'100plus',l:'100 000 kr eller mer'}]},

    // Del 7 ‚Äì Oro & inst√§llning (sist f√∂re kontakt)
    {id:'biggest_concern',t:'Vad oroar dig mest med att studera?',w:'Hj√§lper oss ge konkreta svar p√• just dina farh√•gor.',tp:'opts',opts:[{v:'economy',l:'Ekonomin ‚Äî klarar jag mig p√• CSN?'},{v:'time',l:'Tiden ‚Äî hinner jag med allt?'},{v:'grades',l:'Betygen ‚Äî √§r jag tillr√§ckligt smart?'},{v:'age',l:'√Öldern ‚Äî √§r det f√∂r sent?'},{v:'job',l:'Jobbet ‚Äî hittar jag jobb efter√•t?'},{v:'none',l:'Inget speciellt, jag √§r redo'}]},
    {id:'why_change',t:'Vad driver dig att vilja byta?',w:'Hj√§lper oss spegla dina egna ord i planen.',tp:'opts',opts:[{v:'meaning',l:'Vill ha ett meningsfullt jobb'},{v:'salary',l:'Vill tj√§na mer'},{v:'burnout',l:'Tr√∂tt p√• nuvarande jobb'},{v:'career',l:'Vill ha b√§ttre karri√§rm√∂jligheter'},{v:'passion',l:'Har alltid velat g√∂ra n√•got annat'},{v:'other',l:'Annat'}]},

    // Del 8 ‚Äì Kontaktuppgifter
    {id:'user_name',t:'Vad heter du?',w:'Vi anv√§nder ditt namn i din personliga plan.',tp:'text',ph:'F√∂r- och efternamn'},
    {id:'user_phone',t:'Ditt mobilnummer?',w:'F√∂r att kunna skicka planen till dig.',tp:'text',ph:'070-123 45 67'}
];
const WTITLES=['Studiepreferenser','Studiepreferenser','Studiepreferenser','Studiepreferenser','Studiepreferenser','Studiepreferenser','Studiepreferenser','Studiepreferenser','Studiepreferenser','Studiepreferenser','Beh√∂righet','Beh√∂righet','Nuvarande situation','Nuvarande situation','Nuvarande situation','Nuvarande situation','Nuvarande situation','Nuvarande situation','Familj & ansvar','Familj & ansvar','Familj & ansvar','Familj & ansvar','Boende','Utgifter','Utgifter','Sparande & buffert'];

function getVisibleQS(){return QS.filter(q=>!q.cond||q.cond())}
function openW(){
    ws=0;
    // Pre-fill from snabbkalkyl if already calculated
    const prefill={};
    if(sal>0) prefill._sal=sal; // stored for economy tab
    if(edu&&edu.id) prefill._eduId=edu.id; // stored for matching
    ans=prefill;
    renderW();document.getElementById('wov').classList.add('a');document.body.style.overflow='hidden'
}
function closeW(){document.getElementById('wov').classList.remove('a');document.body.style.overflow=''}

function renderW(){
    const vqs=getVisibleQS();
    if(ws>=vqs.length){showBlurredPlan();return}
    const q=vqs[ws];
    const qi=QS.indexOf(q);
    const prog=Math.round((ws+1)/(vqs.length+1)*100);
    
    document.getElementById('wTi').textContent=WTITLES[qi]||'';
    document.getElementById('wBar').style.width=prog+'%';
    
    // Uppdaterad progress-text med mer uppmuntran
    let progressText='';
    if(ws===0) progressText=`Fr√•ga ${ws+1} av ${vqs.length} - Vi k√∂r!`;
    else if(prog<25) progressText=`Fr√•ga ${ws+1} av ${vqs.length}`;
    else if(prog<50) progressText=`${prog}% klart - Bra jobbat!`;
    else if(prog<75) progressText=`${prog}% klart - √ñver halva v√§gen!`;
    else if(prog<95) progressText=`${prog}% klart - Snart klar!`;
    else progressText=`${prog}% klart - Sista fr√•gan!`;
    document.getElementById('wSL').textContent=progressText;
    


    let h='<div class="wq">';
    // Dynamic title for familydrop
    let title=q.t,why=q.w;
    if(q.id==='familydrop'){
        const netSal=Math.round(sal*0.7);
        const maxCSN=BID+9484;
        const drop=netSal-maxCSN;
        title=drop>0?'Ditt hush√•ll tappar ~'+fmt(drop)+' kr/m√•n i inkomst':'Din CSN-inkomst √§r n√§ra din nettol√∂n';
        why=drop>0?'Du g√•r fr√•n ~'+fmt(netSal)+' kr netto till max '+fmt(maxCSN)+' kr (CSN). Hur hanterar hush√•llet det?':'Nettol√∂n ~'+fmt(netSal)+' kr vs max CSN '+fmt(maxCSN)+' kr. Hur ser ni p√• omst√§llningen?';
    }
    h+='<h4>'+title+'</h4><div class="why">'+why+'</div>';
    if(q.tp==='multi'){
        h+='<div class="wopts">';
        q.opts.forEach(o=>{
            const selected=ans[q.id]&&ans[q.id].includes(o.v);
            h+='<div class="wo'+(selected?' sel':'')+'" onclick="wMulti(\''+q.id+"','"+o.v+"',this)\"><div class=\"wdot\"></div><span>"+o.l+'</span></div>';
        });
        h+='</div>';
    }
    else if(q.tp==='opts'){h+='<div class="wopts">';q.opts.forEach(o=>{h+='<div class="wo'+(ans[q.id]===o.v?' sel':'')+'" onclick="wSel(\''+q.id+"','"+o.v+"',this)\"><div class=\"wdot\"></div><span>"+o.l+'</span></div>'});h+='</div>'}
    else if(q.tp==='hp'){h+=`<div class="winp" style="max-width:320px">
      <div style="display:flex;align-items:flex-end;gap:8px;margin-bottom:10px">
        <div style="flex:1"><div style="font-size:.75rem;color:var(--mu);margin-bottom:4px">Verbalt</div>
        <input type="number" id="wInpHpV" step="0.1" min="0" max="2.0" placeholder="1.4" value="${ans[q.id]&&ans[q.id]!=='no'?ans[q.id].split(',')[0]||'':''}" style="width:100%;padding:12px;border:1.5px solid var(--bo);border-radius:10px;font-size:1rem;font-family:inherit;outline:none;box-sizing:border-box" oninput="this.style.borderColor=this.value?'var(--ac)':'var(--bo)'"></div>
        <div style="padding-bottom:14px;color:var(--mu);font-size:1.1rem">,</div>
        <div style="flex:1"><div style="font-size:.75rem;color:var(--mu);margin-bottom:4px">Kvantitativt</div>
        <input type="number" id="wInpHpQ" step="0.1" min="0" max="2.0" placeholder="1.6" value="${ans[q.id]&&ans[q.id]!=='no'?ans[q.id].split(',')[1]||'':''}" style="width:100%;padding:12px;border:1.5px solid var(--bo);border-radius:10px;font-size:1rem;font-family:inherit;outline:none;box-sizing:border-box" oninput="this.style.borderColor=this.value?'var(--ac)':'var(--bo)'"></div>
      </div>
      <div onclick="const v=document.getElementById('wInpHpV').value,q2=document.getElementById('wInpHpQ').value;if(v&&q2){ans['${q.id}']=v+','+q2;ws++;renderW();}else{ans['${q.id}']='no';ws++;renderW();}" class="wo" style="justify-content:center;font-weight:700;background:var(--ac);color:#fff;border:none">Har inte skrivit HP</div>
    </div>`;}
    else if(q.tp==='text'){h+='<div class="winp"><input type="text" id="wInp" placeholder="'+q.ph+'" value="'+(ans[q.id]||'')+'" oninput="ans[\''+q.id+'\']=this.value"></div>'}
    else{h+='<div class="winp"><input type="number" id="wInp" placeholder="'+q.ph+'" value="'+(ans[q.id]||'')+'" oninput="ans[\''+q.id+'\']=this.value"><span>'+q.su+'</span></div>'}
    h+='<div class="wnav">';if(ws>0)h+='<button class="wbk" onclick="wBk()">‚Üê Tillbaka</button>';
    h+='<button class="wnx" onclick="wNx()">N√§sta ‚Üí</button></div></div>';
    document.getElementById('wB').innerHTML=h;
    const inp=document.getElementById('wInp');if(inp)inp.focus();
}
function wSel(qid,val,el){ans[qid]=val;el.parentElement.querySelectorAll('.wo').forEach(o=>o.classList.remove('sel'));el.classList.add('sel')}
function wMulti(qid,val,el){
    if(!ans[qid])ans[qid]=[];
    if(ans[qid].includes(val)){
        ans[qid]=ans[qid].filter(v=>v!==val);
        el.classList.remove('sel');
    }else{
        ans[qid].push(val);
        el.classList.add('sel');
    }
    // Om "Spelar ingen roll" v√§ljs, rensa alla andra
    if(val==='any'&&ans[qid].includes('any')){
        ans[qid]=['any'];
        el.parentElement.querySelectorAll('.wo').forEach(o=>o.classList.remove('sel'));
        el.classList.add('sel');
    }
    // Om n√•got annat v√§ljs, ta bort "Spelar ingen roll"
    else if(ans[qid].includes('any')&&val!=='any'){
        ans[qid]=ans[qid].filter(v=>v!=='any');
        el.parentElement.querySelectorAll('.wo').forEach(o=>{
            if(o.textContent.includes('Spelar ingen roll'))o.classList.remove('sel');
        });
    }
}
function wBk(){if(ws>0){ws--;renderW()}}
function wNx(){const vqs=getVisibleQS();const q=vqs[ws];if(q.tp==='multi'&&(!ans[q.id]||ans[q.id].length===0)){alert('V√§lj minst ett alternativ.');return}if(q.tp==='opts'&&!ans[q.id]){alert('V√§lj ett alternativ.');return}if((q.tp==='input'||q.tp==='text'||q.tp==='hp')&&!ans[q.id]){if(q.tp==='hp'){ans[q.id]='no';}else{alert('Fyll i ett v√§rde.');return}}ws++;renderW()}

function showBlurredPlan(){
    const e=edu,a=ans;
    const userName=a.user_name||'';
    const firstName=userName.split(' ')[0]||'du';
    const age=Math.min(70,Math.max(18,parseInt(a.age)||29));
    const city=mapCity(a.current_location);
    const cn={stockholm:'Stockholm',goteborg:'G√∂teborg',malmo:'Malm√∂',uppsala:'Uppsala',linkoping:'Link√∂ping',lund:'Lund',umea:'Ume√•',orebro:'√ñrebro',other:'Sverige'};
    const cityName=cn[city]||'Sverige';
    const gp=GYM.find(g=>g.id===a.gym);
    const gk=gp?gp.k:'other';
    const full=a.has_grades==='yes'&&e.rp.includes(gk);
    const part=a.has_grades==='yes'&&e.pp.includes(gk);
    const sal=+a.current_salary||0;
    const defaultLoan=Math.round(e.tc*0.6/10)*10;
    const loan=defaultLoan;
    const mo=Math.round(e.y*10);
    const debt=loan*mo;
    const BID=4120;
    const yg=(e.s0-sal)*12;
    const op=sal*12*e.y;
    const be=yg>0?Math.ceil((op+debt)/yg):0;

    // St√§ng wizard
    closeW();

    // ‚îÄ‚îÄ LADDNINGSSK√ÑRM ‚îÄ‚îÄ
    const loadEl=document.createElement('div');
    loadEl.id='planLoader';
    loadEl.style.cssText='position:fixed;inset:0;background:#0a2e1a;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px;';

    const steps=[
        {pct:8,  msg:`H√§mtar krav f√∂r ${e.t}...`},
        {pct:22, msg:`Kontrollerar beh√∂righet ‚Äî ${gp?gp.l:'ditt gymnasieprogram'}...`},
        {pct:38, msg:`Ber√§knar CSN-st√∂d f√∂r ${cityName}...`},
        {pct:54, msg:`R√§knar p√• din budget m√•nad f√∂r m√•nad...`},
        {pct:68, msg:`Analyserar antagningspo√§ng i ${cityName}...`},
        {pct:79, msg:`Genererar tidslinje ‚Äî ${e.y} √•r till examen...`},
        {pct:90, msg:`S√§tter ihop dina konkreta steg...`},
        {pct:100,msg:`Din plan √§r klar, ${firstName}.`}
    ];

    loadEl.innerHTML=`
    <div style="text-align:center;width:100%;max-width:420px">
        <div style="font-family:'DM Serif Display',serif;font-size:1.6rem;color:#fff;margin-bottom:8px">${firstName}</div>
        <div style="font-size:.85rem;color:rgba(255,255,255,.6);margin-bottom:40px">Vi bygger din personliga plan ‚Äî det tar bara n√•gra sekunder</div>
        <div style="background:rgba(255,255,255,.1);border-radius:100px;height:6px;width:100%;margin-bottom:20px;overflow:hidden">
            <div id="planLoadBar" style="background:linear-gradient(90deg,#4CAF82,var(--ac));height:100%;width:0%;border-radius:100px;transition:width .6s ease"></div>
        </div>
        <div id="planLoadPct" style="font-family:'DM Serif Display',serif;font-size:2.2rem;color:#fff;margin-bottom:8px">0%</div>
        <div id="planLoadMsg" style="font-size:.88rem;color:rgba(255,255,255,.7);min-height:24px;transition:opacity .3s"></div>
        <div class="mob-grid-2" style="margin-top:48px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px;opacity:.5">
        <div style="padding:12px 8px;background:rgba(255,255,255,.08);border-radius:10px;text-align:center">
            <div style="font-size:.62rem;color:rgba(255,255,255,.6);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Beh√∂righet</div>
            <div style="font-size:.9rem;font-weight:700;color:#fff">${full?'‚úì Klar':part?'‚ö† N√§ra':'Kollar...'}</div>
        </div>
        <div style="padding:12px 8px;background:rgba(255,255,255,.08);border-radius:10px;text-align:center">
            <div style="font-size:.62rem;color:rgba(255,255,255,.6);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Utbildning</div>
            <div style="font-size:.9rem;font-weight:700;color:#fff">${Math.ceil(e.y)} √•r</div>
        </div>
        <div style="padding:12px 8px;background:rgba(255,255,255,.08);border-radius:10px;text-align:center">
            <div style="font-size:.62rem;color:rgba(255,255,255,.6);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Steg</div>
            <div style="font-size:.9rem;font-weight:700;color:#fff" id="planLoadSteps">‚Äî</div>
        </div>
        </div>
    </div>`;

    document.body.appendChild(loadEl);
    document.body.style.overflow='hidden';

    // Animera stegen
    let si=0;
    const bar=document.getElementById('planLoadBar');
    const pct=document.getElementById('planLoadPct');
    const msg=document.getElementById('planLoadMsg');
    const stepsEl=document.getElementById('planLoadSteps');

    function tick(){
        if(si>=steps.length){
            // Klar ‚Äî visa paywall
            setTimeout(()=>{
                loadEl.style.transition='opacity .5s';
                loadEl.style.opacity='0';
                setTimeout(()=>{
                    loadEl.remove();
                    document.body.style.overflow='';
                    showPaywall(firstName,e,debt,be,sal,full,part,gp,loan,mo,BID);
                },500);
            },700);
            return;
        }
        const s=steps[si];
        bar.style.width=s.pct+'%';
        pct.textContent=s.pct+'%';
        msg.style.opacity='0';
        setTimeout(()=>{msg.textContent=s.msg;msg.style.opacity='1';},200);
        if(si===6) stepsEl.textContent='7 st';
        si++;
        setTimeout(tick, si===steps.length-1?900:600);
    }
    setTimeout(tick,300);
}

function showPaywall(firstName,e,debt,be,sal,full,part,gp,loan,mo,BID){
    const fmt=n=>n.toLocaleString('sv-SE');
    const salDiff=e.s0-sal;
    const gradYr=new Date().getFullYear()+Math.ceil(e.y)+(full?0:part?1:2);

    const pw=document.createElement('div');
    pw.style.cssText='position:fixed;inset:0;background:#f5f4f0;z-index:9990;overflow-y:auto;';
    pw.innerHTML=`
    <div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:24px 16px 48px">

    <!-- Header -->
    <div style="text-align:center;margin-bottom:28px;max-width:480px">
        <div style="display:inline-block;background:var(--ac);color:#fff;font-size:.72rem;font-weight:700;letter-spacing:.8px;text-transform:uppercase;padding:6px 14px;border-radius:100px;margin-bottom:14px">Din plan √§r klar</div>
        <h2 style="font-family:'DM Serif Display',serif;font-size:1.75rem;color:var(--ah);line-height:1.25;margin-bottom:8px">${firstName} ‚Äî din v√§g till ${e.t.toLowerCase()}</h2>
        <p style="font-size:.88rem;color:#6c757d">Vi har analyserat din situation och tagit fram din personliga plan.</p>
    </div>

    <!-- Blurrad plan-preview -->
    <div style="width:100%;max-width:480px;margin-bottom:24px;border-radius:18px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.12);position:relative">

        <!-- Synliga nyckeltal ‚Äî lockbete -->
        <div style="background:#fff;padding:20px;border-bottom:1px solid #e0e0d8">
        <div style="font-size:.7rem;font-weight:700;color:#6c757d;text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">Ur din plan</div>
        <div class="mob-grid-3" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
            <div style="padding:12px 8px;background:${salDiff>0?'#D9F0E3':'#f8d7da'};border-radius:10px;text-align:center">
            <div style="font-size:.6rem;font-weight:700;color:${salDiff>0?'var(--ah)':'#721c24'};text-transform:uppercase;margin-bottom:3px">L√∂nef√∂r√§ndring</div>
            <div style="font-family:'DM Serif Display',serif;font-size:1.05rem;color:${salDiff>0?'var(--ah)':'#721c24'};font-weight:700">${salDiff>0?'+':''}${fmt(salDiff)} kr</div>
            <div style="font-size:.6rem;color:${salDiff>0?'var(--ah)':'#721c24'};opacity:.8">per m√•nad</div>
            </div>
            <div style="padding:12px 8px;background:#fff3cd;border-radius:10px;text-align:center">
            <div style="font-size:.6rem;font-weight:700;color:#856404;text-transform:uppercase;margin-bottom:3px">CSN-skuld</div>
            <div style="font-family:'DM Serif Display',serif;font-size:1.05rem;color:#856404;font-weight:700">${fmt(debt)} kr</div>
            <div style="font-size:.6rem;color:#856404;opacity:.8">totalt l√•n</div>
            </div>
            <div style="padding:12px 8px;background:#cfe2ff;border-radius:10px;text-align:center">
            <div style="font-size:.6rem;font-weight:700;color:#084298;text-transform:uppercase;margin-bottom:3px">Break-even</div>
            <div style="font-family:'DM Serif Display',serif;font-size:1.05rem;color:#084298;font-weight:700">${be>0&&be<40?'~'+be+' √•r':'‚Äî'}</div>
            <div style="font-size:.6rem;color:#084298;opacity:.8">sedan tj√§nar mer</div>
            </div>
        </div>
        </div>

        <!-- Blurrad resten -->
        <div style="background:#fff;padding:20px;filter:blur(5px);pointer-events:none;user-select:none">
        <div style="height:12px;background:#e0e0d8;border-radius:6px;margin-bottom:10px;width:80%"></div>
        <div style="height:12px;background:#e0e0d8;border-radius:6px;margin-bottom:10px;width:60%"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
            <div style="height:60px;background:#f0f4f1;border-radius:10px"></div>
            <div style="height:60px;background:#fff3cd;border-radius:10px"></div>
        </div>
        <div style="height:12px;background:#e0e0d8;border-radius:6px;margin-bottom:8px;width:90%"></div>
        <div style="height:12px;background:#e0e0d8;border-radius:6px;margin-bottom:8px;width:70%"></div>
        <div style="height:48px;background:#D9F0E3;border-radius:10px;margin-bottom:8px"></div>
        <div style="height:12px;background:#e0e0d8;border-radius:6px;margin-bottom:8px;width:55%"></div>
        <div style="height:12px;background:#e0e0d8;border-radius:6px;width:75%"></div>
        </div>

        <!-- L√•s-overlay -->
        <div style="position:absolute;bottom:0;left:0;right:0;height:140px;background:linear-gradient(transparent,rgba(245,244,240,.98));display:flex;align-items:flex-end;justify-content:center;padding-bottom:16px">
        <div style="display:flex;align-items:center;gap:6px;font-size:.8rem;color:#6c757d">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
            L√•s upp f√∂r att se hela planen
        </div>
        </div>
    </div>

    <!-- Vad ing√•r -->
    <div style="width:100%;max-width:480px;margin-bottom:20px">
        <div style="display:grid;gap:8px">
        ${[
            ['beh√∂righet','Din exakta beh√∂righet',`Kurs f√∂r kurs baserat p√• ${gp?gp.l:'ditt gymnasieprogram'}`],
            ['datum','Konkreta datum och deadlines',`Ans√∂kningsdag, Komvux-start, HP-anm√§lan`],
            ['budget','Interaktiv m√•nadsbudget',`Justera CSN, hyra och extrajobb i realtid`],
            ['plan','Steg-f√∂r-steg handlingsplan',`Vad du g√∂r denna vecka, n√§sta m√•nad, n√§sta √•r`],
            ['skolor','Matchade utbildningar','Filtrerat p√• din ort, studieform och studietakt']
        ].map(([ic,ti,su])=>`<div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:#fff;border-radius:10px;border:1px solid #e0e0d8">
            <div style="width:28px;height:28px;border-radius:7px;background:#f0f4f1;flex-shrink:0;display:flex;align-items:center;justify-content:center">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
            <div><div style="font-weight:700;font-size:.85rem;color:var(--ah)">${ti}</div><div style="font-size:.76rem;color:#6c757d">${su}</div></div>
        </div>`).join('')}
        </div>
    </div>

    <!-- CTA -->
    <div style="width:100%;max-width:480px">
        <button onclick="pw.remove();document.body.style.overflow='';pay();" style="width:100%;background:linear-gradient(135deg,var(--ac),var(--ah));color:#fff;border:none;padding:18px 32px;border-radius:14px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(45,90,61,.35);letter-spacing:.2px">
            L√•s upp min plan ‚Äî 99 kr
        </button>
        <p style="text-align:center;font-size:.76rem;color:#6c757d;margin-top:10px">
            Eng√•ngsbetalning &nbsp;¬∑&nbsp; Ingen prenumeration &nbsp;¬∑&nbsp; Dina svar sparas
        </p>
    </div>

    </div>`;

    // Fix knapp-referens till pw
    document.body.appendChild(pw);
    document.body.style.overflow='hidden';
    window.scrollTo(0,0);
    pw.querySelector('button').onclick=function(){pw.remove();document.body.style.overflow='';pay();};
}


function renderPay(){
    const vqs=getVisibleQS();
    const e=edu,a=ans;
    const age=Math.min(70,Math.max(18,parseInt(a.age)||29));
    const city=mapCity(a.current_location);
    const cn={stockholm:'Stockholm',goteborg:'G√∂teborg',malmo:'Malm√∂',uppsala:'Uppsala',linkoping:'Link√∂ping',lund:'Lund',umea:'Ume√•',orebro:'√ñrebro',other:'hela Sverige'};
    const cityName=cn[city]||'din stad';
    const gp=GYM.find(g=>g.id===a.gym),gk=gp?gp.k:'other';
    const full=a.has_grades==='yes'&&e.rp.includes(gk);
    const part=a.has_grades==='yes'&&e.pp.includes(gk);
    const behTxt=full?'Beh√∂rig ‚Äî s√∂k direkt':part?'Komplettering ~1 termin':'Kolla dina betyg';
    const behCol=full?'var(--ac)':part?'var(--wa)':'var(--re)';
    const netNow=Math.round(sal*0.7); // nettol√∂n (ungef√§rlig) f√∂r budgetkalkyl

    document.getElementById('wTi').textContent='Din plan √§r klar';
    document.getElementById('wBar').style.width='100%';
    document.getElementById('wSL').textContent='';
    document.getElementById('wB').innerHTML=`<div class="wq">
    <div style="background:linear-gradient(135deg,var(--ac),var(--ah));border-radius:12px;padding:20px;color:#fff;margin-bottom:20px;text-align:center">
    <div style="font-family:'DM Serif Display',serif;font-size:1.15rem;margin-bottom:4px">${age} √•r ‚Äî din v√§g till ${e.t.toLowerCase()}</div>
    <div style="opacity:.85;font-size:.84rem">${cityName} ¬∑ ${e.y} √•r ¬∑ Examen ${new Date().getFullYear()+(new Date().getMonth()<5?0:1)+e.y}</div>
    </div>

    <div style="display:grid;gap:6px;margin-bottom:20px">
    <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;border:1.5px solid var(--bo)">
    <div style="width:8px;height:8px;border-radius:50%;background:${behCol};flex-shrink:0"></div>
    <span style="font-size:.86rem;font-weight:600">Beh√∂righet</span>
    <span style="margin-left:auto;font-size:.82rem;color:${behCol};font-weight:600">${behTxt}</span></div>

    <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;border:1.5px solid var(--bo)">
    <div style="width:8px;height:8px;border-radius:50%;background:var(--bl);flex-shrink:0"></div>
    <span style="font-size:.86rem;font-weight:600">Ekonomi</span>
    <span style="margin-left:auto;font-size:.82rem;color:var(--mu)">${fmt(netNow)} kr ‚Üí <span style="filter:blur(4px)">XX XXX kr</span></span></div>

    <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;border:1.5px solid var(--bo)">
    <div style="width:8px;height:8px;border-radius:50%;background:var(--wa);flex-shrink:0"></div>
    <span style="font-size:.86rem;font-weight:600">Handlingsplan</span>
    <span style="margin-left:auto;font-size:.82rem;color:var(--mu)">6 steg + checklista</span></div>

    <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;border:1.5px solid var(--bo)">
    <div style="width:8px;height:8px;border-radius:50%;background:var(--pu);flex-shrink:0"></div>
    <span style="font-size:.86rem;font-weight:600">Skolor</span>
    <span style="margin-left:auto;font-size:.82rem;color:var(--mu)">${e.sch.length} matchade</span></div>
    </div>

    <div style="text-align:center;margin-bottom:16px"><div style="font-family:'DM Serif Display',serif;font-size:1.1rem;margin-bottom:4px">L√•s upp hela planen</div><div style="font-size:.82rem;color:var(--mu)">Personlig budget, tidslinje, skolmatchning ‚Äî allt baserat p√• dina ${vqs.length} svar.</div></div>

    <div class="fld"><label>Namn</label><input type="text" id="pNam" placeholder="Ditt namn"></div>
    <div class="fld"><label>Mejl</label><input type="email" id="pEm" placeholder="namn@mejl.se"></div>
    <div class="fld"><label>Telefon (valfritt)</label><input type="tel" id="pTel" placeholder="070-123 45 67"></div>
    <button class="btn" onclick="pay()">Betala 50 kr ‚Äî l√•s upp</button>
    <div style="display:flex;align-items:center;justify-content:center;gap:6px;margin-top:10px;font-size:.76rem;color:var(--li)"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>S√§ker betalning ‚Äî eng√•ngsbetalning</div>
    <div class="wnav" style="margin-top:16px"><button class="wbk" onclick="ws=${vqs.length-1};renderW()">‚Üê Tillbaka</button><div></div></div>
    </div>`;
}

function pay(){
    const userName=ans.user_name||'Anv√§ndare';

    // Ta bort blur och visa planen
    const blurWrap=document.querySelector('.blur-wrap');
    if(blurWrap){
        blurWrap.style.filter='none';
        blurWrap.style.opacity='1';
        blurWrap.style.pointerEvents='auto';
        blurWrap.style.userSelect='auto';
    }
    const blurContent=document.querySelector('.blur-content');
    if(blurContent){
        blurContent.style.filter='none';
        blurContent.style.opacity='1';
        blurContent.style.maxHeight='none';
        blurContent.style.overflow='visible';
        blurContent.style.pointerEvents='auto';
        blurContent.style.userSelect='auto';
    }
    const paywallOverlay=document.querySelector('.paywall-overlay');
    if(paywallOverlay) paywallOverlay.style.display='none';

    const paywallCard=document.querySelector('.paywall-card');
    if(paywallCard) paywallCard.style.display='none';

    // Visa planen
    const fpDiv=document.getElementById('fpDiv');
    fpDiv.classList.add('v');
    fpDiv.style.display='block';

    // Bygg om planen f√∂r att s√§kra allt renderas
    buildFP(userName);

    setTimeout(()=>{
        window.scrollTo({top:fpDiv.offsetTop-70,behavior:'smooth'});
    },200);
}



// Map free-text city to key
function mapCity(txt){
    if(!txt)return'other';const t=txt.toLowerCase().trim();
    const m={stockholm:'stockholm',sthlm:'stockholm',g√∂teborg:'goteborg',gbg:'goteborg',malm√∂:'malmo',uppsala:'uppsala',link√∂ping:'linkoping',lund:'lund',ume√•:'umea',√∂rebro:'orebro'};
    for(const[k,v]of Object.entries(m))if(t.includes(k))return v;
    return'other';
}

function buildFP(name){
    const e=edu,a=ans;

    // ‚ïê‚ïê‚ïê DERIVE VALUES FROM ANSWERS ‚ïê‚ïê‚ïê
    // Convert age range to approximate number
    const age=Math.min(70,Math.max(18,parseInt(a.age)||29));
    
    const city=mapCity(a.current_location);
    const campus=a.study_mode==='campus'?'campus':a.study_mode==='distance'?'distance':'any';
    
    // Housing - use direct answer
    const hou=a.housing||'student';
    
    // Determine if working needed based on work status
    const workNeeded=a.work_during==='parttime'||a.work_status==='parttime';
    
    const pm=workNeeded?2:1,ry=e.y*pm;
    const rent=hou==='home'?0:Math.round((CIT[city]||4500)*(HOU[hou]||.75));
    
    // CSN loan - default based on user's answer
    const defaultLoan=a.need_csn==='grant'?0:a.need_csn==='no'?0:6000;
    const loan=defaultLoan;
    
    const wh=workNeeded?15:(a.need_csn==='both')?10:0;
    const wi=Math.round(wh*WR*4.3);
    const mo=Math.round(ry*10),debt=loan*mo,pb=debt>0?Math.round(debt*.04/12):0;
    
    // Use salary from initial form
    const currentSal=sal;
    
    // Convert expenses - use direct values
    const fixedExp=parseInt(a.fixed_expenses)||10000;
    const variableExp=parseInt(a.variable_expenses)||4000;
    
    // Budget logic:
    // If staying home: use current expenses (fixed+variable), rent=0
    // If moving: use only variable expenses + calculated student rent
    const userExp=hou==='home'?(fixedExp+variableExp):variableExp;
    
    // Kids and family
    const numKids=a.num_kids?parseInt(a.num_kids)||1:0;
    const cc=a.has_kids==='yes'?2000*numKids:0;
    const barnCSN=a.has_kids==='yes'?2648:0;
    
    const op=currentSal*12*ry,yg=(e.s0-currentSal)*12,be=yg>0?Math.ceil((op+debt)/yg):0;
    const dfa=debt>0&&pb>0?Math.round(age+ry+debt/(pb*12)):0;
    const ti=BID+barnCSN+loan+wi,to=rent+userExp+cc,bal=ti-to;
    const defRent=hou==='home'?0:Math.round((CIT[city]||4500)*(HOU[hou]||.75));
    const afterTax=v=>Math.round(v*0.7);
    const cn={stockholm:'Stockholm',goteborg:'G√∂teborg',malmo:'Malm√∂',uppsala:'Uppsala',linkoping:'Link√∂ping',lund:'Lund',umea:'Ume√•',orebro:'√ñrebro',other:'hela Sverige'};
    const cityName=cn[city]||'din stad';
    const hn={student:'studentboende',shared:'delad l√§genhet',rental:'hyresr√§tt',home:'hemma'};

    

    const fl=campus==='campus'?'campus':campus==='distance'?'distans':'campus/distans';

    // Beh√∂righet from gym program + education requirements
    const gp=GYM.find(g=>g.id===a.gym),gk=gp?gp.k:'other';
    const full=a.has_grades==='yes'&&e.rp.includes(gk);
    const part=a.has_grades==='yes'&&e.pp.includes(gk);
    const need=!full;

    // Dates
    const now=new Date(),yr=now.getFullYear(),mo2=now.getMonth();
    const wantSoon=a.when_start==='asap'||a.when_start==='next'||a.when_start==='6mo';
    const htStart=wantSoon&&mo2<5?'HT'+yr:'HT'+(yr+1);
    const komvuxStart=mo2<5?'VT'+yr:'VT'+(yr+1);
    const studyStart=htStart;
    const startYr=parseInt(studyStart.slice(2));
    const compTime=need?(part?1:2):0;
    const gradYear=startYr+Math.ceil(ry)+compTime;
    const gradAge=age+Math.ceil(ry)+compTime;
    const firstName=name.split(' ')[0];
    const formTxt=campus==='distance'?'Distans':campus==='campus'?'Campus':'Campus/Distans';

    // Opportunity cost: total lost income during studies
    const opCost=afterTax(sal)*12*ry;

    // Schools ‚Äî filter by user preferences
    const schs=e.sch.filter(s=>{
        // Studieform filter
        if(a.study_mode==='campus'&&s.f==='distance')return false;
        if(a.study_mode==='distance'&&s.f==='campus')return false;
        
        // Utbildningstyp filter
        const eduTypes=Array.isArray(a.education_type)?a.education_type:(a.education_type?[a.education_type]:[]);
        if(eduTypes.length>0&&!eduTypes.includes('any')){
            const wantsYH=eduTypes.includes('yh');
            const wantsUni=eduTypes.includes('uni');
            const isYH=s.p===0;
            const isUni=s.p>0;
            
            if(!wantsYH&&isYH)return false;
            if(!wantsUni&&isUni)return false;
        }
        
        // Studietakt filter
        if(a.study_pace==='parttime'&&s.pace==='fulltime')return false;
        
        // CSN filter
        if(a.csn_needed==='yes'&&!s.csn)return false;
        
        // Avgift filter
        if(a.fee_ok==='no'&&s.fee>0)return false;
        
        // Spr√•k filter
        if(a.language==='swedish'&&s.lang==='english')return false;
        if(a.language==='english'&&s.lang==='swedish')return false;
        
        return true;
    }).sort((x,y)=>{
        // Prioritera stad
        if(x.c===city&&y.c!==city)return -1;
        if(y.c===city&&x.c!==city)return 1;
        // Sedan antagningspo√§ng
        return (y.p||0)-(x.p||0);
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Studiestaden & boendelogik ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const studyCity=(schs.length>0&&schs[0]&&schs[0].c)?schs[0].c:city;
    const studyCityName=(schs.length>0&&schs[0].c!==city)?({stockholm:'Stockholm',goteborg:'G√∂teborg',malmo:'Malm√∂',uppsala:'Uppsala',linkoping:'Link√∂ping',lund:'Lund',umea:'Ume√•',orebro:'√ñrebro'}[schs[0].c]||cityName):cityName;
    const isMovingCity=studyCity!==city;
    const isDistanceStudy=a.study_mode==='distance'||(a.study_mode==='hybrid'&&!isMovingCity);
    // Visa boendesteg: inte bor kvar hemma OCH faktiskt relevant
    // Distansstudenter som inte valt att flytta beh√∂ver inget boendesteg
    const showHousing=hou!=='home'&&!(isDistanceStudy&&a.willing_to_move!=='yes');
    
    // K√∂tider f√∂r studentboende per studiestad (ungef√§rliga ‚Äî varierar)
    const KOTID={
        stockholm:{q:'1‚Äì5 √•r',org:'SSSB',url:'https://sssb.se'},
        goteborg:{q:'6 m√•n‚Äì2 √•r',org:'SGS Studentbost√§der',url:'https://sgs.se'},
        malmo:{q:'6‚Äì18 m√•nader',org:'MKB Studentbostad',url:'https://mkb.se'},
        uppsala:{q:'1‚Äì3 √•r',org:'Studentstaden Uppsala',url:'https://studentstaden.se'},
        linkoping:{q:'6‚Äì18 m√•nader',org:'LiU Studentbostad',url:'https://liu.se/studera/studentbostad'},
        lund:{q:'6‚Äì18 m√•nader',org:'AF Bost√§der',url:'https://afbostader.se'},
        umea:{q:'3‚Äì12 m√•nader',org:'Ume√• Studentbostad',url:'https://umeastudentbostad.se'},
        orebro:{q:'3‚Äì9 m√•nader',org:'√ñrebrobost√§der',url:'https://orebrobostader.se'}
    };
    const kotidInfo=KOTID[studyCity]||{q:'3‚Äì12 m√•nader',org:'ortens studentbostadsbolag',url:'https://studera.nu'};

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PERSONAL INTRO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const salDiff=e.s0-currentSal;
    const jobTxt=`Du tj√§nar ${fmt(currentSal)} kr/m√•n`;
    const certaintyTxt=(()=>{
        if(age>=45) return `Att b√∂rja vid ${age} ger dig ${65-age-Math.ceil(ry)-compTime} √•r i yrket ‚Äî det r√§cker mer √§n v√§l.`;
        if(age>=35) return `${age} √•r med ${Math.round(currentSal/1000)}k i l√∂n och erfarenhet √§r en f√∂rdel, inte ett hinder.`;
        if(a.has_kids==='yes') return `Med barn och studier samtidigt ‚Äî det g√∂rs varje dag. Planen √§r byggd f√∂r det.`;
        if(a.biggest_concern==='economy') return `Ekonomin √§r den vanligaste oron. Vi har r√§knat p√• den ‚Äî och visar dig exakt vad som g√§ller.`;
        if(a.biggest_concern==='age') return `√Öldern √§r inte ett hinder ‚Äî tusentals g√∂r samma byte varje √•r.`;
        if(salDiff>8000) return `L√∂ne√∂kningen p√• ${fmt(salDiff)} kr/m√•n g√∂r det h√§r till en av dina b√§sta investeringar.`;
        return `Du har redan gjort det sv√•raste ‚Äî att faktiskt unders√∂ka m√∂jligheten.`;
    })();
    const introLine=salDiff>5000?`Som ${e.t.toLowerCase()} √∂kar din l√∂n med ${fmt(salDiff)} kr/m√•n ‚Äî och det √§r bara starten.`:
        salDiff>0?`L√∂nen √∂kar med ${fmt(salDiff)} kr/m√•n. Med erfarenhet n√•r du ${fmt(e.s1)} kr.`:
        `Du tj√§nar redan bra. ${e.t} ger dig nya arbetsvillkor och ett l√∂netak p√• ${fmt(e.s1)} kr.`;

    let h=`<div class="pwel"><h3>${firstName}, ${age} √•r ‚Äî din v√§g till ${e.t.toLowerCase()}</h3>
    <p class="pintro">${jobTxt} och √§r ${age} √•r. ${certaintyTxt} ${introLine}</p>
    <div style="margin-top:14px;padding:14px;background:rgba(255,255,255,.12);border-radius:10px;display:grid;gap:6px;font-size:.84rem">
    <div style="display:flex;justify-content:space-between"><span style="opacity:.75">Utbildning</span><span style="font-weight:700">${e.t}</span></div>
    <div style="display:flex;justify-content:space-between"><span style="opacity:.75">Skolor</span><span style="font-weight:700">${schs.length} alternativ</span></div>
    <div style="display:flex;justify-content:space-between"><span style="opacity:.75">Studieform</span><span style="font-weight:700">${formTxt}, ${ry} √•r</span></div>
    <div style="display:flex;justify-content:space-between"><span style="opacity:.75">Examen</span><span style="font-weight:700">${gradYear} (${gradAge} √•r)</span></div>
    ${a.has_kids==='yes'?'<div style="display:flex;justify-content:space-between"><span style="opacity:.75">Barntill√§gg CSN</span><span style="font-weight:700">+'+fmt(barnCSN)+' kr/m√•n</span></div>':''}
    </div></div>`;

    // ‚ïê‚ïê‚ïê STICKY TABS ‚ïê‚ïê‚ïê
    // Tab order for prev/next navigation
    const TAB_ORDER=['overview','beh','ekon','tid','skol'];
    let currentTabIdx=0;
    h+=`<div style="position:relative">`;
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:0 16px 0;max-width:860px;margin:0 auto">
    <button onclick="navPlan(-1)" id="planPrev" style="flex-shrink:0;width:36px;height:36px;border-radius:50%;border:1.5px solid var(--bo);background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--mu)" title="F√∂reg√•ende"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="ptbar" id="planTabs" style="flex:1;overflow-x:auto">
    <button class="act" onclick="planTab('overview',this)"><span class="tf">√ñversikt</span><span class="ts">Start</span></button>
    <button onclick="planTab('beh',this)"><span class="tf">Beh√∂righet</span><span class="ts">Betyg</span></button>
    <button onclick="planTab('ekon',this)"><span class="tf">Ekonomi</span><span class="ts">Budget</span></button>
    <button onclick="planTab('tid',this)"><span class="tf">Tidslinje</span><span class="ts">Tidslinje</span></button>
    <button onclick="planTab('skol',this)"><span class="tf">Sammanfattning</span><span class="ts">Summering</span></button>
    <button onclick="printPlan()" style="margin-left:auto;background:none;border:1px solid var(--bo);border-radius:8px;padding:6px 12px;font-size:.78rem;color:var(--mu);cursor:pointer;display:flex;align-items:center;gap:5px;white-space:nowrap" title="Ladda ner som PDF"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span class="tf">Spara PDF</span></button>
    </div>
    <button onclick="navPlan(1)" id="planNext" style="flex-shrink:0;width:36px;height:36px;border-radius:50%;border:1.5px solid var(--bo);background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--mu)" title="N√§sta"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg></button>
    </div>`;
    h+=`</div>`; // end ptbar wrapper
    // Nav arrow buttons
    h+=`<div id="planNavWrap" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:10px">
    <button id="planPrev" onclick="planPrev()" style="display:flex;align-items:center;gap:6px;padding:10px 16px;border:2px solid #e0e0d8;border-radius:10px;background:#fff;font-family:inherit;font-size:.82rem;font-weight:600;color:#6c757d;cursor:pointer;transition:all .2s;white-space:nowrap" disabled>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg> F√∂reg√•ende
    </button>
    <span id="planStepLabel" style="font-size:.78rem;color:#6c757d;font-weight:600;text-align:center">1 / 5</span>
    <button id="planNext" onclick="planNext()" style="display:flex;align-items:center;gap:6px;padding:10px 16px;border:2px solid var(--ac);border-radius:10px;background:#fff;font-family:inherit;font-size:.82rem;font-weight:600;color:var(--ac);cursor:pointer;transition:all .2s;white-space:nowrap">
    N√§sta <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
    </div>`;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STUDIETIDEN PANEL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    h+=`<div id="planOverview">`;
    let secN=0;

    // ‚Äî FRAMTIDSVISION: DIN FRAMTID ‚Äî
    const futureYear=gradYear+5;
    const futureAge=gradAge+5;
    const futureSalary=Math.round(e.s0+(e.s1-e.s0)*0.6); // 60% av v√§gen till max
    const salaryIncrease=futureSalary-currentSal;
    const debtAtFuture=debt>0?Math.max(0,debt-pb*12*5):0;
    
    h+=`<div style="background:linear-gradient(135deg,var(--ac),var(--ah));border-radius:16px;padding:32px 28px;margin-bottom:32px;color:#fff">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    <div>
    <div style="font-family:'DM Serif Display',serif;font-size:2rem">Din framtid som ${e.t.toLowerCase()}</div>
    <div style="opacity:.85;font-size:.95rem">Om 5 √•r (${futureYear}) ‚Äî du √§r ${futureAge} √•r</div>
    </div>
    </div>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:24px">
    <div style="background:rgba(255,255,255,.15);padding:20px;border-radius:12px">
    <div style="font-size:.8rem;opacity:.8;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">M√•nadsl√∂n</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.8rem;margin-bottom:4px">${fmt(futureSalary)} kr</div>
    <div style="font-size:.85rem;opacity:.9">‚Üë ${fmt(salaryIncrease)} kr mer √§n idag</div>
    </div>
    
    <div style="background:rgba(255,255,255,.15);padding:20px;border-radius:12px">
    <div style="font-size:.8rem;opacity:.8;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">Jobbmarknad</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.8rem;margin-bottom:4px">${e.dem===5?'Mycket h√∂g':e.dem===4?'H√∂g':e.dem===3?'Stabil':'God'}</div>
    <div style="font-size:.85rem;opacity:.9">${e.dem===5?'Akut brist - garanterat jobb':e.dem===4?'Arbetsgivare s√∂ker aktivt':'Balanserad marknad'}</div>
    </div>
    
    ${debt>0?`<div style="background:rgba(255,255,255,.15);padding:20px;border-radius:12px">
    <div style="font-size:.8rem;opacity:.8;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">CSN-skuld</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.8rem;margin-bottom:4px">${debtAtFuture>0?fmt(debtAtFuture)+' kr':'Betald!'}</div>
    <div style="font-size:.85rem;opacity:.9">${debtAtFuture>0?fmt(debt-debtAtFuture)+' kr betalt av '+fmt(debt)+' kr':'Skuldfri!'}</div>
    </div>`:`<div style="background:rgba(255,255,255,.15);padding:20px;border-radius:12px">
    <div style="font-size:.8rem;opacity:.8;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">Ekonomisk frihet</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.8rem;margin-bottom:4px">Ingen skuld</div>
    <div style="font-size:.85rem;opacity:.9">Du klarade utan l√•n!</div>
    </div>`}
    
    <div style="background:rgba(255,255,255,.15);padding:20px;border-radius:12px">
    <div style="font-size:.8rem;opacity:.8;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">Karri√§rstege</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.8rem;margin-bottom:4px">${e.sc.sp}</div>
    <div style="font-size:.85rem;opacity:.9">Fr√•n ${e.sc.st} ‚Üí ${e.sc.le}</div>
    </div>
    </div>
    
    <!-- AI och framtid -->
    <div style="margin-top:20px;padding:16px;background:rgba(255,255,255,.1);border-radius:10px;border-left:3px solid ${e.ai>=12?'#d4a853':'rgba(255,255,255,.3)'}">
    <div style="font-size:.88rem;line-height:1.65;opacity:.95">
    <strong>AI och automatisering (Risk: ${e.ai}/20):</strong> ${e.ai>=15?'AI kommer f√∂r√§ndra yrket, men m√§nniskan beh√∂vs fortfarande. Rutinuppgifter automatiseras, vilket <em>h√∂jer</em> kraven p√• kvalificerad personal.':e.ai>=10?'AI √§r ett verktyg som f√∂rb√§ttrar arbetet, inte ers√§tter det. Automatisering hanterar rutinen, du hanterar komplexiteten.':e.ai>=5?'AI har begr√§nsad p√•verkan p√• k√§rnuppgifterna. Yrket bygger p√• m√§nsklig interaktion och omd√∂me.':'L√•g AI-p√•verkan. M√§nsklig kompetens, empati och omd√∂me √§r central.'} ${e.id===2?'Utvecklare som anv√§nder AI-verktyg (GitHub Copilot, ChatGPT) √§r 35% mer produktiva enligt GitHub Stats 2024.':e.id===1?'V√•rden beh√∂ver sjuksk√∂terskor mer √§n n√•gonsin ‚Äî AI kan inte s√§tta dropp, tr√∂sta patienter eller fatta akuta beslut.':''}
    </div>
    </div>
    
    ${age>=28?`<div style="margin-top:16px;padding:16px;background:rgba(255,255,255,.1);border-radius:10px">
    <div style="font-size:.88rem;line-height:1.65;opacity:.95">
    <strong>Du har ${65-age-Math.ceil(ry)-compTime} √•r kvar att jobba som ${e.t.toLowerCase()}</strong> om du b√∂rjar nu${compTime>0?' (inkl. komplettering)':''}. Det √§r ${65-age-Math.ceil(ry)-compTime>=30?'tre decennier':65-age-Math.ceil(ry)-compTime>=20?'tv√• decennier':'m√•nga √•r'}. L√•t oss vara tydliga: <strong>du kommer √•ldras oavsett</strong>. Om ${Math.ceil(ry)} √•r √§r du ${age+Math.ceil(ry)+compTime} √•r ‚Äî med eller utan den h√§r utbildningen. Fr√•gan √§r inte <em>om</em> du ska g√∂ra f√∂r√§ndringen, utan <em>n√§r</em>.
    </div>
    </div>`:''}
    
    </div>`;
    
    // ‚Äî DU √ÑR INTE ENSAM ‚Äî
    // Typisk skuld vid fullt CSN-l√•n (9484 kr/m√•n) f√∂r denna utbildning
    const avgDebt=9484*Math.round(e.y*10);
    const yourDebtVsAvg=debt<avgDebt?'l√§gre':'h√∂gre';
    
    // Utbildningsspecifik statistik
    const eduStats={
        1:{students:'~4 200',employ:'95%',avgAge:'26'},
        2:{students:'~3 500',employ:'88%',avgAge:'24'},
        3:{students:'~5 100',employ:'92%',avgAge:'25'},
        4:{students:'~3 800',employ:'82%',avgAge:'23'},
        5:{students:'~2 400',employ:'91%',avgAge:'22'},
        6:{students:'~2 900',employ:'87%',avgAge:'27'},
        7:{students:'~1 800',employ:'94%',avgAge:'25'},
        8:{students:'~1 200',employ:'78%',avgAge:'26'}
    };
    const stats=eduStats[e.id]||{students:'~2 500',employ:'85%',avgAge:'25'};
    
    // √Öldersstatistik (anv√§nds i b√•de "Du √§r inte ensam" och "Det h√§r beh√∂ver du veta")
    const ageGroup=age<25?'18-24':age<30?'25-29':age<35?'30-34':age<40?'35-39':'40+';
    const ageStats={'18-24':'42%','25-29':'31%','30-34':'15%','35-39':'8%','40+':'4%'};
    const yourAgePercent=ageStats[ageGroup]||'8%';
    
    h+=`<div style="background:#f8f9fa;border-radius:12px;padding:24px;margin-bottom:32px">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
    <h3 style="font-family:'DM Serif Display',serif;font-size:1.3rem;color:var(--ah);margin:0">Du √§r inte ensam ‚Äî och du √§r inte f√∂r gammal</h3>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:20px">
    <div>
    <div style="font-size:2rem;font-weight:700;color:var(--ac)">${stats.students}</div>
    <div style="font-size:.88rem;color:#495057">b√∂rjade ${e.t.toLowerCase()}-utbildning f√∂rra √•ret</div>
    </div>
    <div>
    <div style="font-size:2rem;font-weight:700;color:var(--ac)">${stats.employ}</div>
    <div style="font-size:.88rem;color:#495057">fick jobb inom 6 m√•nader efter examen</div>
    </div>
    <div>
    <div style="font-size:2rem;font-weight:700;color:var(--ac)">${yourAgePercent}</div>
    <div style="font-size:.88rem;color:#495057">av nyb√∂rjarna √§r i din √•ldersgrupp (${ageGroup} √•r)</div>
    </div>
    <div>
    <div style="font-size:2rem;font-weight:700;color:var(--ac)">${stats.avgAge} √•r</div>
    <div style="font-size:.88rem;color:#495057">medel√•lder f√∂r nyb√∂rjare ‚Äî siffran stiger varje √•r</div>
    </div>
    </div>
    
    
    
    ${age>=28?`<div style="padding:14px 16px;background:#fff;border-radius:8px;border-left:3px solid var(--ac);font-size:.85rem;color:#495057;line-height:1.65;margin-bottom:12px">
    <strong style="color:var(--ah)">En vanlig oro: "Konkurrerar jag inte ut av yngre med samma examen?"</strong>
    <div style="margin-top:8px">Baserat p√• efterfr√•gan inom ${e.t.toLowerCase()} (${e.dem===5?'akut brist':e.dem===4?'h√∂g efterfr√•gan':'god arbetsmarknad'}) √§r det troligt att din bakgrund √§r en <em>f√∂rdel</em>, inte ett hinder. Arbetsgivare inom detta yrke s√∂ker aktivt personer med livserfarenhet, probleml√∂sningsf√∂rm√•ga och mognad. Din tidigare yrkeskarri√§r g√∂r dig mer anst√§llningsbar, inte mindre.</div>
    ${e.dem>=4?`<div style="margin-top:8px;padding:8px 10px;background:#f0f4f1;border-radius:6px;font-size:.82rem"><strong>Konkret:</strong> Med ${e.dem===5?'akut brist':'h√∂g efterfr√•gan'} p√• ${e.t.toLowerCase()} tar de flesta f√§rska studenter jobb direkt. F√§ltet √§r inte nollsummespel ‚Äî det finns plats f√∂r alla som examineras.</div>`:''} 
    </div>`:''}
    
    
    </div>`;
    h+=`</div>`; // end #planOverview
    
    // ‚ïê‚ïê‚ïê BEH√ñRIGHET PANEL ‚ïê‚ïê‚ïê
    h+=`<div id="planBeh" style="display:none">`;

    // ‚îÄ‚îÄ‚îÄ Kurs-till-gym-mappning ‚îÄ‚îÄ‚îÄ
    const GYM_COURSES={
        natur:['Matte 1','Matte 2a','Matte 2b','Matte 3c','Matte 4','Fysik 1a','Fysik 2','Kemi 1','Kemi 2','Biologi 1','Biologi 2','Naturkunskap 2','Samh√§llskunskap 1b'],
        teknik:['Matte 1','Matte 2a','Matte 2b','Matte 3c','Matte 4','Fysik 1a','Fysik 2','Kemi 1','Naturkunskap 2','Samh√§llskunskap 1b'],
        samhall:['Matte 1','Samh√§llskunskap 1b','Samh√§llskunskap 2','Historia 1b','Naturkunskap 1a1'], // Matte 2 √§r valfritt p√• Samh√§ll - listas EJ
        ekonomi:['Matte 1','Matte 2a','Matte 2b','Samh√§llskunskap 1b','Historia 1b','F√∂retagsekonomi 1','F√∂retagsekonomi 2','Naturkunskap 1a1'],
        estet:['Matte 1','Samh√§llskunskap 1b','Historia 1b','Naturkunskap 1a1'],
        vard:['Matte 1','Samh√§llskunskap 1b','Naturkunskap 1a1','Naturkunskap 2','Biologi 1','Psykologi 1'],
        bygg:['Matte 1','Matte 2a','Fysik 1a','Samh√§llskunskap 1b'],
        el:['Matte 1','Matte 2a','Matte 3c','Fysik 1a','Fysik 2','Samh√§llskunskap 1b'],
        industri:['Matte 1','Matte 2a','Fysik 1a','Samh√§llskunskap 1b'],
        other:[]
    };
    const myCourses=GYM_COURSES[a.gym]||[];
    const reqStatus=e.req.map(req=>{
        const reqNorm=req.split('/')[0].trim().toLowerCase();
        const found=myCourses.some(mc=>mc.split('/')[0].trim().toLowerCase()===reqNorm||mc.toLowerCase().startsWith(reqNorm.split(' ').slice(0,2).join(' ')));
        return{req,found};
    });

    // ‚îÄ‚îÄ‚îÄ Kurskrav + din bakgrund ‚îÄ‚îÄ‚îÄ
    h+=`<div style="background:#fff;border:2px solid #e0e0d8;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
    <div style="width:32px;height:32px;border-radius:50%;background:${full?'var(--ac)':part?'#d4a853':'#c24b3b'};color:#fff;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0">${full?'‚úì':part?'!':'?'}</div>
    <div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.15rem;color:var(--ah)">Beh√∂righet till ${e.t}</div>
    <div style="font-size:.78rem;color:#6c757d">Baserat p√• att du gick ${gp?gp.l:'gymnasiet'}</div>
    </div>
    </div>
    <div style="margin-bottom:16px;padding:12px 16px;background:${full?'#D9F0E3':part?'#fff3cd':'#f8d7da'};border-radius:10px;border-left:4px solid ${full?'var(--ac)':part?'#d4a853':'#c24b3b'}">
    <div style="font-weight:700;font-size:.9rem;color:${full?'var(--ah)':part?'#856404':'#721c24'};margin-bottom:4px">${full?'‚úì Troligen beh√∂rig ‚Äî s√∂k direkt till '+studyStart:part?'‚ö† Beh√∂ver troligen komplettera ett par kurser':'Kolla dina betyg ‚Äî beh√∂righet oklart'}</div>
    <div style="font-size:.84rem;color:${full?'var(--ah)':part?'#856404':'#721c24'};line-height:1.6">${full?(gp?gp.l:'Ditt gymnasieprogram')+'-programmet inkluderar normalt alla kurser som '+e.t+' kr√§ver. Kontrollera dina konkreta betyg p√• antagning.se f√∂r att vara helt s√§ker.':part?(gp?gp.l:'Ditt gymnasieprogram')+'-programmet ger dig de flesta grundkraven, men saknar troligen n√•gra enstaka kurser. Kika igenom listan nedan.':'Ditt gymnasieprogram inkluderar inte alla kurser som kr√§vs. Se vad du beh√∂ver komplettera nedan.'}</div>
    </div>
    <div style="font-size:.82rem;font-weight:700;color:#6c757d;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">${e.t} kr√§ver ‚Äî kurs f√∂r kurs</div>
    <div style="display:grid;gap:8px;margin-bottom:14px">
    ${reqStatus.map(rs=>`<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:${rs.found?'#f0f4f1':'#fff8e1'};border-radius:8px;border-left:3px solid ${rs.found?'var(--ac)':'#d4a853'}">
    <span style="font-size:1rem;flex-shrink:0">${rs.found?'‚úÖ':'‚ö†Ô∏è'}</span>
    <div>
    <span style="font-weight:600;font-size:.88rem">${rs.req}</span>
    <div style="font-size:.78rem;color:#6c757d;margin-top:2px">${rs.found?'Ing√•r troligen i '+(gp?gp.l:'ditt gymnasieprogram')+'-programmet':'Ing√•r troligen inte i '+(gp?gp.l:'ditt gymnasieprogram')+' ‚Äî beh√∂ver kompletteras via Komvux'}</div>
    </div>
    </div>`).join('')}
    </div>
    <a href="https://www.antagning.se/sv/sokandet/behorighet-och-meriter/" target="_blank" style="display:flex;align-items:center;gap:6px;padding:10px 14px;background:#f0f4f1;border-radius:8px;text-decoration:none;font-size:.84rem;font-weight:600;color:var(--ac)">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
    Verifiera exakt p√• antagning.se ‚Üí
    </a>
    </div>`;

    // ‚îÄ‚îÄ‚îÄ Antagningspo√§ng fr√•n matchade skolor ‚îÄ‚îÄ‚îÄ
    const topSchs=schs.slice(0,3);
    if(topSchs.length>0){
    h+=`<div style="background:#fff;border:2px solid #e0e0d8;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
    <div style="font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--ah);margin-bottom:4px">Antagningspo√§ng ‚Äî dina n√§rmaste alternativ</div>
    <div style="font-size:.78rem;color:#6c757d;margin-bottom:16px">L√§gsta po√§ng fr√•n senaste antagningsomg√•ngen</div>
    <div style="display:grid;gap:10px">`;
    topSchs.forEach(s=>{
        const cutoffColor=s.cutoff>=20?'#721c24':s.cutoff>=17?'#856404':'var(--ah)';
        const cutoffBg=s.cutoff>=20?'#f8d7da':s.cutoff>=17?'#fff3cd':'#D9F0E3';
        const cutoffLabel=s.cutoff>=20?'H√∂g konkurrens':s.cutoff>=17?'Medel':'Relativt tillg√§nglig';
        h+=`<div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:#f8f9fa;border-radius:10px;border-left:3px solid ${cutoffColor}">
        <div style="flex:1;min-width:0">
        <div style="font-weight:700;font-size:.88rem;color:var(--ah)">${s.school}</div>
        <div style="font-size:.78rem;color:#6c757d;margin-top:2px">${s.n}${s.f==='distance'?' ¬∑ Distans':s.f==='campus'?' ¬∑ Campus':''} ¬∑ ${s.length}</div>
        </div>
        <div style="text-align:right;flex-shrink:0">
        <div style="padding:4px 10px;background:${cutoffBg};border-radius:6px;font-size:.82rem;font-weight:700;color:${cutoffColor}">${s.cutoff>0?s.cutoff+' meritpo√§ng':'‚Äî'}</div>
        <div style="font-size:.7rem;color:#6c757d;margin-top:3px">${cutoffLabel}</div>
        </div>
        </div>`;
    });
    h+=`</div>
    <div style="margin-top:12px;padding:10px 14px;background:#f0f4f1;border-radius:8px;font-size:.8rem;color:var(--ah);line-height:1.5">
    Po√§ngen varierar √•r f√∂r √•r. Reservantagning ger ofta 30‚Äì50% chans √§ven om du √§r n√§ra gr√§nsen.
    <a href="https://www.antagning.se" target="_blank" style="color:var(--ac);font-weight:600;display:inline-block;margin-top:2px">Kolla exakt po√§ng p√• antagning.se ‚Üí</a>
    </div>
    </div>`;}

    // ‚îÄ‚îÄ‚îÄ H√∂gskoleprov (HP) ‚îÄ‚îÄ‚îÄ
    h+=`<div style="background:#fff;border:2px solid #e0e0d8;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
    <div style="width:32px;height:32px;border-radius:50%;background:#084298;color:#fff;display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:700;flex-shrink:0">HP</div>
    <div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--ah)">H√∂gskoleprov ‚Äî alternativ v√§g in</div>
    <div style="font-size:.78rem;color:#6c757d">Ca ‚Öì av platserna p√• de flesta program reserveras f√∂r HP-antagning</div>
    </div>
    </div>
    <div style="font-size:.84rem;color:#495057;line-height:1.7;margin-bottom:14px">
    H√∂gskolans antagning sker i tv√• kvoter: <strong>kvot 1</strong> (gymnasiebetyg) och <strong>kvot 2</strong> (h√∂gskoleprov). Det inneb√§r att √§ven om dina betyg inte r√§cker kan ett bra HP-resultat ge dig plats. Du t√§vlar separat mot andra HP-s√∂kande, inte mot dem med h√∂ga betyg.
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:14px">
    <div style="padding:12px;background:#cfe2ff;border-radius:10px;text-align:center">
    <div style="font-size:.68rem;font-weight:700;color:#084298;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Kostnad</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.1rem;color:#084298">450 kr</div>
    </div>
    <div style="padding:12px;background:#cfe2ff;border-radius:10px;text-align:center">
    <div style="font-size:.68rem;font-weight:700;color:#084298;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Genomf√∂rs</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.1rem;color:#084298">V√•r & h√∂st</div>
    </div>
    <div style="padding:12px;background:#cfe2ff;border-radius:10px;text-align:center">
    <div style="font-size:.68rem;font-weight:700;color:#084298;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Resultat giltigt</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.1rem;color:#084298">5 provomg√•ngar (~2,5 √•r)</div>
    </div>
    <div style="padding:12px;background:#cfe2ff;border-radius:10px;text-align:center">
    <div style="font-size:.68rem;font-weight:700;color:#084298;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Max po√§ng</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.1rem;color:#084298">2,0</div>
    </div>
    </div>
    <div style="padding:10px 14px;background:#f0f4ff;border-radius:8px;font-size:.82rem;color:#084298;line-height:1.5;margin-bottom:12px">
    üí° Du kan skriva HP hur m√•nga g√•nger du vill och anv√§nda ditt b√§sta resultat. M√•nga skriver det en g√•ng utan f√∂rberedelse, och sedan en g√•ng efter √∂vning ‚Äî po√§ngen f√∂rb√§ttras markant med tr√§ning.
    </div>
    <a href="https://www.studera.nu/hogskoleprov/" target="_blank" style="display:flex;align-items:center;gap:6px;padding:10px 14px;background:#cfe2ff;border-radius:8px;text-decoration:none;font-size:.84rem;font-weight:600;color:#084298">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
    Anm√§l dig till HP p√• studera.nu ‚Üí
    </a>
    </div>`;

    // ‚îÄ‚îÄ‚îÄ Komplettering ‚îÄ‚îÄ‚îÄ
    if(!full){
    const missingReqs=reqStatus.filter(r=>!r.found).map(r=>r.req);
    h+=`<div data-komp style="background:#fff;border:2px solid #e0e0d8;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
    <div style="font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--ah)">Komplettering ‚Äî ${missingReqs.length} kurs${missingReqs.length===1?'':'er'} saknas</div>
    <button onclick="this.closest('[data-komp]').querySelector('[data-komp-detail]').style.display=this.closest('[data-komp]').querySelector('[data-komp-detail]').style.display==='none'?'block':'none';this.textContent=this.textContent==='Visa detaljer ‚ñæ'?'D√∂lj ‚ñ¥':'Visa detaljer ‚ñæ'" style="font-size:.78rem;color:var(--ac);background:none;border:none;cursor:pointer;font-family:inherit;padding:0">Visa detaljer ‚ñæ</button>
    </div>
    <div style="font-size:.85rem;color:#495057;margin-bottom:12px">Tar <strong>~${part?'1 termin':'1‚Äì2 terminer'}</strong> ‚Äî b√•da v√§garna √§r CSN-ber√§ttigade (${fmt(BID)} kr/m√•n i bidrag).</div>
    <div style="padding:8px 12px;background:#f0f4f1;border-radius:8px;font-size:.82rem;color:var(--ah);margin-bottom:14px"><strong>Kurser:</strong> ${missingReqs.length>0?missingReqs.join(' ¬∑ '):'Se antagning.se'}</div>
    <div data-komp-detail style="display:none"><div style="display:grid;gap:12px;margin-bottom:14px">
    <div style="padding:16px;background:#f0f4f1;border-radius:12px;border:2px solid var(--ac)">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    <div style="font-weight:700;font-size:.9rem;color:var(--ah)">Heltid dagtid ‚Äî ~${part?'1 termin':'1‚Äì2 terminer'} (snabbast)</div>
    </div>
    <div style="font-size:.84rem;color:#495057;line-height:1.65">
    Komvux heltid, ungef√§r 08‚Äì15 p√• vardagar ‚Äî precis som gymnasiet. Klarar du det snabbare ger du dig mer flexibilitet vid ans√∂kan. Kr√§ver att du tar tj√§nstledighet eller g√•r ner i arbetstid.
    ${part?'Klart till '+studyStart+' ‚Äî du s√∂ker programmet senast '+(studyStart.startsWith('HT')?'15 april':'15 oktober')+' '+startYr+'.':'Sannolikt klart till HT'+(startYr+1)+'.'}
    </div>
    <div style="margin-top:8px;padding:8px 10px;background:#fff;border-radius:6px;font-size:.8rem;color:var(--ac);font-weight:600">
    Kurser att s√∂ka: ${missingReqs.length>0?missingReqs.join(' ¬∑ '):'Se antagning.se f√∂r exakta krav'}
    </div>
    </div>
    <div style="padding:16px;background:#fff8e1;border-radius:12px;border:2px solid #d4a853">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#856404" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
    <div style="font-weight:700;font-size:.9rem;color:#856404">Deltid kv√§ll via distans ‚Äî ${part?'2‚Äì3 terminer':'3‚Äì4 terminer'} (du beh√•ller l√∂nen)</div>
    </div>
    <div style="font-size:.84rem;color:#495057;line-height:1.65">
    De flesta Komvux erbjuder distansundervisning kv√§llstid (17‚Äì21) och p√• helger. Du <strong>beh√•ller jobbet och hela din l√∂n</strong> under kompletteringen ‚Äî det enda du offrar √§r kv√§llstid. Kr√§ver disciplin men √§r ekonomiskt det tryggaste alternativet.
    </div>
    <div style="margin-top:8px;padding:8px 10px;background:#fff;border-radius:6px;font-size:.8rem;color:#856404;font-weight:600">
    S√∂k hos: ${cityName!=='hela Sverige'?cityName+' Komvux (distans)':'Din kommuns Komvux'} ‚Äî leta efter kv√§llskurser i ${missingReqs.length>0?missingReqs[0]:'√§mnet'}
    </div>
    </div>
    </div>
    <div style="padding:10px 14px;background:#f8f9fa;border-radius:8px;font-size:.8rem;color:#6c757d;line-height:1.5">
    üí° S√∂k kurs p√• <a href="https://www.studera.nu" target="_blank" style="color:var(--ac);font-weight:600">studera.nu</a> ‚Äî filtrera p√• distans + kv√§ll + din ort f√∂r att hitta exakt r√§tt kurs.
    </div>
    </div></div>`;}

    h+=`</div>`; // end #planBeh
    
    // ‚ïê‚ïê‚ïê EKONOMI PANEL ‚ïê‚ïê‚ïê
    h+=`<div id="planEkon" style="display:none;position:relative">`;

    // ‚Äî EKONOMI ‚Äî
    secN++;
    const netNow=afterTax(sal),netCSN=BID+barnCSN+loan+wi,monthDiff=netCSN-netNow;
    h+=`<div class="psec">
    <div style="background:linear-gradient(135deg,var(--ah),var(--ac));border-radius:16px;padding:28px 24px;margin-bottom:24px">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
    <div style="color:#fff;font-family:'DM Serif Display',serif;font-size:1.8rem">Din ekonomi under studietiden</div>
    </div>
    <div style="color:rgba(255,255,255,.85);font-size:.95rem">${monthDiff>=0?'Baserat p√• dina svar ser det ut att g√• ihop ‚Äî justera reglagen nedan f√∂r att se hur dina val p√•verkar balansen.':'Du tappar '+fmt(Math.abs(monthDiff))+' kr/m√•n j√§mf√∂rt med idag ‚Äî justera l√•n, hyra och extrajobb nedan f√∂r att se vad som funkar f√∂r dig.'}</div>
    </div>
    
    <div style="padding:14px 16px;background:#fff;border-radius:10px;border:2px solid #e0e0d8;margin-bottom:20px;font-size:.85rem;color:#495057;line-height:1.65">
    <strong style="color:var(--ah)">Kan man klara sig p√• CSN?</strong> Baserat p√• din situation (${hou==='home'?'bo kvar hemma':hou==='student'?'studentboende':'egen bostad'}, ${a.work_during==='no'?'inget extrajobb':'extrajobb'}) ser ditt utg√•ngsl√§ge ${bal>=0?'balanserat ut ‚Äî men det √§r tajt':'anstr√§ngt ut'}. ${loan>0?'CSN-l√•net ger mer luft i budgeten men bygger skuld som √•terbetalas efter examen ‚Äî vad som passar beror p√• din situation och risktolerans.':'Du klarar dig utan l√•n i ditt scenario.'} ${a.work_during!=='no'?'Att jobba extra √§r m√∂jligt ‚Äî de flesta program till√•ter deltid (helger, kv√§ll) utan att studerandet lider.':'Om budgeten k√§rvar kan ett deltidsjobb (10‚Äì15 h/v) g√∂ra stor skillnad utan att studierna p√•verkas.'}
    </div>`;

    // Interactive budget
        // ‚Äî DIN PLAN I SIFFROR ‚Äî
    const behText=full?'‚úÖ Beh√∂rig direkt':part?'‚ö†Ô∏è Komplettering ~1 termin':'‚ùå Komplettering kr√§vs';
    const behColor=full?'var(--ah)':part?'#856404':'#721c24';
    const behBg=full?'#D9F0E3':part?'#fff3cd':'#f8d7da';
    const dfaAge=dfa>0?dfa:0;
    const opCostTkr=Math.round(opCost/1000);
    const netGain10yr=yg*10-opCost-debt;
    const netGain10yrTkr=Math.round(netGain10yr/1000);

    h+=`<div class="budget-sticky">
    <div style="font-size:.72rem;font-weight:700;color:#6c757d;text-transform:uppercase;letter-spacing:.6px;margin-bottom:12px">Din plan i siffror ‚Äî uppdateras n√§r du justerar budgeten</div>
    <div class="mob-grid-2" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px">

    <div style="padding:12px 10px;background:${bal>=0?'#D9F0E3':'#f8d7da'};border-radius:13px;text-align:center" id="fBV2wrap">
    <div style="font-size:.6rem;font-weight:700;color:${bal>=0?'var(--ah)':'#721c24'};text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px" id="fBV2lbl">Kvar / m√•n</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.35rem;color:${bal>=0?'var(--ah)':'#721c24'};line-height:1" id="fBV2">${(bal>=0?'+':'')+fmt(bal)} kr</div>
    <div style="font-size:.65rem;color:${bal>=0?'var(--ah)':'#721c24'};opacity:.8;margin-top:4px">som student</div>
    </div>

    <div style="padding:12px 10px;background:#fff3cd;border-radius:13px;text-align:center">
    <div style="font-size:.6rem;font-weight:700;color:#856404;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px">CSN-skuld</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.35rem;color:#856404;line-height:1" id="fD2s">${fmt(debt)} kr</div>
    <div style="font-size:.65rem;color:#856404;opacity:.8;margin-top:4px">${fmt(loan)} kr/m√•n √ó ${mo} m√•n</div>
    </div>

    <div style="padding:12px 10px;background:${netGain10yr>0?'#D9F0E3':'#fff3cd'};border-radius:13px;text-align:center">
    <div style="font-size:.6rem;font-weight:700;color:${netGain10yr>0?'var(--ah)':'#856404'};text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px">Vinst √•r 10</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.35rem;color:${netGain10yr>0?'var(--ah)':'#856404'};line-height:1">${netGain10yr>0?'+':'-'}${fmt(Math.abs(netGain10yr))} kr</div>
    <div style="font-size:.65rem;color:${netGain10yr>0?'var(--ah)':'#856404'};opacity:.8;margin-top:4px">netto vs att stanna</div>
    </div>

    </div>
    <div class="mob-grid-2" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">

    <div style="padding:12px 10px;background:var(--al);border-radius:13px;text-align:center">
    <div style="font-size:.6rem;font-weight:700;color:var(--ah);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px">√Öterbetalning</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.35rem;color:var(--ah);line-height:1" id="fPB">${pb>0?fmt(pb)+' kr':'‚Äî'}</div>
    <div style="font-size:.65rem;color:var(--ah);opacity:.8;margin-top:4px">per m√•n efter examen</div>
    </div>

    <div style="padding:12px 10px;background:var(--bll);border-radius:13px;text-align:center">
    <div style="font-size:.6rem;font-weight:700;color:var(--bl);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px">Break-even</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.35rem;color:var(--bl);line-height:1" id="fBE">${be>0&&be<50?'~'+be+' √•r':'‚Äî'}</div>
    <div style="font-size:.65rem;color:var(--bl);opacity:.8;margin-top:4px">sedan tj√§nar du mer livet ut</div>
    </div>

    <div style="padding:12px 10px;background:#D9F0E3;border-radius:13px;text-align:center">
    <div style="font-size:.6rem;font-weight:700;color:var(--ah);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px">Toppinkomst</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.35rem;color:var(--ah);line-height:1">${fmt(e.s1)} kr</div>
    <div style="font-size:.65rem;color:var(--ah);opacity:.8;margin-top:4px">med erfarenhet som ${e.t.toLowerCase()}</div>
    </div>

    </div>
    </div>`;

        h+=`<div style="background:linear-gradient(135deg,var(--ah),var(--ac));border-radius:16px;padding:28px 24px;margin:32px 0 24px">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>
    <div style="color:#fff;font-family:'DM Serif Display',serif;font-size:1.8rem">Din interaktiva budget</div>
    </div>
    <div style="color:rgba(255,255,255,.85);font-size:.95rem">Dra i reglagen f√∂r att hitta din balans</div>
    </div>
    
    <div class="pcard" style="border:none;box-shadow:0 2px 12px rgba(0,0,0,.08)"><div class="pcardb">
    <div style="font-weight:600;font-size:.82rem;color:#495057;margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px">Inkomster</div>
    <div class="brow" style="background:#D9F0E3;border-left:4px solid var(--ac)"><label>CSN Bidrag</label><span class="bv" style="color:var(--ah)">${fmt(BID)} kr</span></div>`;
    
    if(barnCSN){
        h+=`<div class="brow" style="background:#D9F0E3;border-left:4px solid var(--ac)"><label>Barntill√§gg CSN</label><span class="bv" style="color:var(--ah)">${fmt(barnCSN)} kr</span></div>`;
    }
    
    h+=`<div class="bsrow" style="background:#fff3cd;border-left:4px solid #d4a853">
    <div style="display:flex;justify-content:space-between"><label style="font-size:.88rem;font-weight:600">CSN L√•n</label><span class="bv" style="color:#856404" id="fLV">${fmt(loan)} kr</span></div>`;
    
    if(a.need_csn==='grant'){
        h+=`<div style="font-size:.72rem;color:#856404;margin-bottom:6px;line-height:1.4;opacity:.85">Du valde endast bidrag. L√•net √§r frivilligt och kan aktiveras om du beh√∂ver.</div>`;
    }else if(a.need_csn==='no'){
        h+=`<div style="font-size:.72rem;color:#856404;margin-bottom:6px;line-height:1.4;opacity:.85">Du valde inget CSN-st√∂d. L√•net kan aktiveras om du √§ndrar dig.</div>`;
    }else{
        h+=`<div style="font-size:.72rem;color:#856404;margin-bottom:6px;line-height:1.4;opacity:.85">Frivilligt l√•n med l√•g r√§nta (~0.55%). Justera efter behov.</div>`;
    }
    
    h+=`<input type="range" class="bslider" id="fL" min="0" max="9484" step="100" value="${loan}" oninput="upd()" style="accent-color:#d4a853;width:100%">
    <div class="bsmeta"><span>0 kr</span><span>Max 9 484 kr</span></div>
    </div>
    <div class="bsrow" style="background:#cfe2ff;border-left:4px solid #084298">
    <div style="display:flex;justify-content:space-between;margin-bottom:6px">
    <label style="font-size:.88rem;font-weight:600">Extrajobb</label>
    <span class="bv" style="color:#084298" id="fWV">${fmt(wi)} kr</span>
    </div>
    <div style="font-size:.72rem;color:#084298;margin-bottom:6px;line-height:1.4;opacity:.85">Timmar per vecka √ó timl√∂n</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px">
    <div>
    <div style="font-size:.75rem;color:#495057;margin-bottom:4px">Timmar/vecka</div>
    <input type="range" class="bslider" id="fW" min="0" max="20" step="1" value="${wh}" oninput="upd()" style="accent-color:#084298;width:100%">
    <div class="bsmeta" style="margin-top:2px"><span>0 h</span><span id="fWH">${wh} h</span></div>
    </div>
    <div>
    <div style="font-size:.75rem;color:#495057;margin-bottom:4px">Timl√∂n</div>
    <input type="range" class="bslider" id="fWR" min="100" max="250" step="5" value="${WR}" oninput="upd()" style="accent-color:#084298;width:100%">
    <div class="bsmeta" style="margin-top:2px"><span>100 kr</span><span id="fWRL">${WR} kr</span></div>
    </div>
    </div>
    </div>
    <div class="btot" style="background:var(--ac);color:#fff"><span>Totalt in</span><span id="fTI">${fmt(ti)} kr</span></div>
    <div style="font-weight:600;font-size:.82rem;color:#495057;margin:20px 0 12px;text-transform:uppercase;letter-spacing:.5px">Utgifter</div>
    <div class="bsrow" style="background:#f8d7da;border-left:4px solid #c24b3b">
    <div style="display:flex;justify-content:space-between;margin-bottom:6px"><label style="font-size:.88rem;font-weight:600">Boende</label><span class="bv" style="color:#721c24" id="fRV">${fmt(rent)} kr</span></div>`;
    
    if(hou==='home'){
        h+=`<div style="font-size:.72rem;color:#721c24;margin-bottom:6px;line-height:1.4;opacity:.85">Du bor kvar d√§r du bor nu. Boendekostnaden ing√•r i dina fasta utgifter nedan.</div>`;
    }else{
        h+=`<div style="font-size:.72rem;color:#721c24;margin-bottom:6px;line-height:1.4;opacity:.85">Ber√§knat f√∂r ${hn[hou]} i ${cityName}. Snitt: ${fmt(defRent)} kr. Justera efter din verklighet med slidern.</div>`;
    }
    
    h+=`<div id="houBtns" style="display:flex;gap:4px;margin-bottom:8px">
    <button class="houbtn${hou==='student'?' hact':''}" onclick="setHou('student',this)">Studentboende</button>
    <button class="houbtn${hou==='shared'?' hact':''}" onclick="setHou('shared',this)">Delad lgh</button>
    <button class="houbtn${hou==='rental'?' hact':''}" onclick="setHou('rental',this)">Hyresr√§tt</button>
    <button class="houbtn${hou==='home'?' hact':''}" onclick="setHou('home',this)">Bo kvar</button>
    </div>
    <div style="position:relative"><input type="range" class="bslider" id="fR" min="0" max="12000" step="250" value="${rent}" oninput="upd()" style="accent-color:#c24b3b;width:100%"><div id="fRMark" style="position:absolute;top:-2px;width:2px;height:12px;background:#721c24;border-radius:1px;pointer-events:none;left:${defRent/12000*100}%"></div></div>
    <div class="bsmeta"><span>0 kr</span><span id="fRDef">Snitt ${hn[hou]}: ${fmt(defRent)} kr</span></div>
    </div>
    <div class="brow" style="background:#f5f5f0;border-left:4px solid #6c757d"><label>Levnadskostnader</label><span class="bv" style="color:#495057" id="fUserExp">${fmt(userExp)} kr</span></div>
    
    <div id="expensesSection">`;
    
    if(hou==='home'){
        h+=`<div style="font-size:.72rem;color:#495057;margin:-4px 0 8px 0;padding:0 12px;line-height:1.4;opacity:.85">Dina fasta utgifter + r√∂rliga utgifter. Inkluderar din nuvarande hyra.</div>`;
    }else{
        h+=`<div style="font-size:.72rem;color:#495057;margin:-4px 0 8px 0;padding:0 12px;line-height:1.4;opacity:.85">Endast r√∂rliga utgifter (mat, transport, n√∂je). Boende √§r separat ovan.</div>`;
    }
    
    h+=`<div style="padding:12px;background:#fff;border-radius:8px;margin-bottom:8px;border:1px solid #dee2e6">`;
    
    if(hou==='home'){
        h+=`<div style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <label style="font-size:.85rem;font-weight:600;color:#495057">Fasta utgifter</label>
        <span style="font-size:.95rem;font-weight:600;color:#495057" id="fFixedExp">${fmt(fixedExp)} kr</span>
        </div>
        <input type="range" class="bslider" id="fFixed" min="3000" max="20000" step="250" value="${fixedExp}" oninput="upd()" style="accent-color:#6c757d;width:100%">
        <div class="bsmeta"><span>3 000 kr</span><span>20 000 kr</span></div>
        <div style="font-size:.72rem;color:#6c757d;margin-top:4px;opacity:.85">Hyra, el, f√∂rs√§kringar, abonnemang</div>
        </div>`;
    }
    
    h+=`<div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
    <label style="font-size:.85rem;font-weight:600;color:#495057">R√∂rliga utgifter</label>
    <span style="font-size:.95rem;font-weight:600;color:#495057" id="fVarExp">${fmt(variableExp)} kr</span>
    </div>
    <input type="range" class="bslider" id="fVariable" min="1000" max="10000" step="250" value="${variableExp}" oninput="upd()" style="accent-color:#6c757d;width:100%">
    <div class="bsmeta"><span>1 000 kr</span><span>10 000 kr</span></div>
    <div style="font-size:.72rem;color:#6c757d;margin-top:4px;opacity:.85">Mat, transport, n√∂je, kl√§der</div>
    </div>
    </div>
    </div>`;
    
    if(a.has_kids==='yes'){
        h+=`<div class="brow" style="background:#f5f5f0;border-left:4px solid #6c757d"><label>Barnomsorg / barnkostnader</label><span class="bv" style="color:#495057">${fmt(cc)} kr</span></div>`;
    }
    
    h+=`<div class="btot" style="background:#6c757d;color:#fff"><span>Totalt ut</span><span id="fTO">${fmt(to)} kr</span></div>`;
    
    h+=`<div style="background:${bal>=0?'#D9F0E3':'#f8d7da'};border:2px solid ${bal>=0?'var(--ac)':'#c24b3b'};border-radius:12px;padding:20px;margin-top:16px" id="fBx">
    <div style="font-size:.82rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:${bal>=0?'var(--ah)':'#721c24'};margin-bottom:8px" id="fBL">${bal>=0?'Kvar varje m√•nad':'Underskott'}</div>
    <div style="font-family:'DM Serif Display',serif;font-size:2rem;color:${bal>=0?'var(--ah)':'#721c24'};margin-bottom:8px" id="fBV">${(bal>=0?'+':'')+fmt(bal)} kr</div>
    <div style="font-size:.88rem;color:${bal>=0?'var(--ah)':'#721c24'};opacity:.9" id="fBA">${bal>=500?'Bra marginal!':bal>=0?'Tight men funkar.':'√ñka l√•n, s√§nk hyra eller extrajobb.'}</div>
    </div>
    </div></div>`;

    // CSN DEBT - Dynamic banner that updates based on slider
    h+=`<div id="debtBanner"></div>`;

    h+=`</div>`; // end ekonomi psec
    h+=`</div>`; // end #planEkon
    
    h+=`<div id="planLifeChange" style="display:none">`;

    // ‚Äî HUR LIVET F√ñR√ÑNDRAS ‚Äî
    secN++;
    h+=`<div style="background:linear-gradient(135deg,var(--ah),var(--ac));border-radius:16px;padding:28px 24px;margin:32px 0 24px">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
    <div style="color:#fff;font-family:'DM Serif Display',serif;font-size:1.8rem">Fr√•n jobb till studentliv</div>
    </div>
    <div style="color:rgba(255,255,255,.85);font-size:.95rem">S√• h√§r f√∂r√§ndras din vardag</div>
    </div>`;
    
    h+=`<div class="pcard" style="border:none;box-shadow:0 2px 12px rgba(0,0,0,.08)"><div class="pcardb" style="display:grid;gap:20px">
    <div style="display:flex;gap:12px"><div style="width:36px;height:36px;border-radius:10px;background:var(--bll);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--bl)" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><div><div style="font-weight:700;font-size:.88rem">Studietakt: Heltid</div><div style="font-size:.82rem;color:var(--mu)">~40 h/vecka. F√∂rel√§sningar, labbar, grupparbeten. ${e.y} √•r till examen.</div></div></div>
    <div style="display:flex;gap:12px"><div style="width:36px;height:36px;border-radius:10px;background:var(--al);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div><div><div style="font-weight:700;font-size:.88rem">Studieform: ${formTxt}</div><div style="font-size:.82rem;color:var(--mu)">${campus==='distance'?'Hemifr√•n. F√∂rel√§sningar online. Kr√§ver disciplin.':'P√• plats i '+cityName+'. Lektioner, bibliotek, studiegrupper.'}</div></div></div>
    <div style="display:flex;gap:12px"><div style="width:36px;height:36px;border-radius:10px;background:var(--wl);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--wa)" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg></div><div><div style="font-weight:700;font-size:.88rem">Examen: ${gradYear} ‚Äî du √§r ${gradAge} √•r</div><div style="font-size:.82rem;color:var(--mu)">Ing√•ngsl√∂n ${fmt(e.s0)} kr. Toppniv√•: ${fmt(e.s1)} kr med erfarenhet.</div></div></div>
    </div></div>`;
    h+=`</div>`;
    h+=`</div>`; // end #planLifeChange

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HANDLINGSPLAN PANEL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    h+=`<div id="planTid" style="display:none">`;

    // ‚îÄ‚îÄ‚îÄ Varf√∂r-echo (speglar tillbaka deras anledning) ‚îÄ‚îÄ‚îÄ
    // ‚îÄ‚îÄ‚îÄ Datum-ber√§kningar ‚îÄ‚îÄ‚îÄ
    const applyDateAction=studyStart.startsWith('HT')?new Date(startYr+compTime,3,15):new Date(startYr+compTime,9,15);
    const daysUntilApply=Math.max(0,Math.ceil((applyDateAction-Date.now())/(1000*60*60*24)));
    const startDateAction=studyStart.startsWith('HT')?new Date(startYr+compTime,7,15):new Date(startYr+compTime,0,15);
    const daysUntilStart=Math.max(0,Math.ceil((startDateAction-Date.now())/(1000*60*60*24)));
    const mo3=Math.round(daysUntilStart/30);
    const yr1After=gradYear+1;
    const yr3After=gradYear+3;
    const salYr1=e.s0;
    const salYr3=Math.round(e.s0+(e.s1-e.s0)*0.4);
    const salYr5=Math.round(e.s0+(e.s1-e.s0)*0.75);

    // ‚îÄ‚îÄ‚îÄ Fas-rubrik-helper ‚îÄ‚îÄ‚îÄ
    const fasHeader=(icon,title,sub,col='var(--ah)',bg='linear-gradient(135deg,var(--ah),var(--ac))')=>
        `<div style="background:${bg};border-radius:14px;padding:18px 20px;margin:24px 0 14px;display:flex;align-items:center;gap:12px">
        ${icon}
        <div>
        <div style="color:#fff;font-family:'DM Serif Display',serif;font-size:1.3rem;line-height:1.2">${title}</div>
        <div style="color:rgba(255,255,255,.75);font-size:.8rem;margin-top:2px">${sub}</div>
        </div></div>`;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FAS 1 ‚Äî F√ñRBEREDELSE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    h+=fasHeader(
        `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
        'Fas 1 ‚Äî F√∂rberedelse',
        `Idag till studiestart ${studyStart} ‚Äî ${mo3>0?'om ca '+mo3+' m√•nader':'snart'}`
    );

    // Psykologisk √∂ppning Fas 1
    h+=`<div style="font-size:.95rem;line-height:1.75;color:#495057;padding:0 4px 20px;border-bottom:1px solid #e8e4d8;margin-bottom:24px">
    ${mo3<=3?`Du √§r n√§rmare √§n du tror. Ans√∂kan st√§nger om ${mo3>0?mo3+' m√•nader':'kort tid'} ‚Äî det √§r tillr√§ckligt med tid om du b√∂rjar den h√§r veckan.`
    :mo3<=6?`Du har ${mo3} m√•nader. Det r√§cker med r√•ge om du b√∂rjar nu.`
    :`Du har gott om tid. Anv√§nd det till att f√∂rbereda dig r√§tt ‚Äî inte till att tveka.`}
    </div>`;
    // Viktiga datum-kort
    h+=`<div class="mob-grid-3" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">
    <div style="padding:14px 10px;background:#fff3cd;border-radius:12px;text-align:center;border:1.5px solid #d4a853">
    <div style="font-family:'DM Serif Display',serif;font-size:1.4rem;color:#856404;line-height:1">${applyDateAction.getDate()} ${['jan','feb','mar','apr','maj','jun','jul','aug','sep','okt','nov','dec'][applyDateAction.getMonth()]}</div>
    <div style="font-size:.68rem;color:#856404;font-weight:700;text-transform:uppercase;margin-top:4px">Ans√∂kan st√§nger</div>
    <div style="font-size:.7rem;color:#856404;margin-top:2px;opacity:.8">${(()=>{
    const ad=studyStart.startsWith('HT')?new Date(startYr+compTime,2,15):new Date(startYr+compTime,9,15);
    const months=['jan','feb','mar','apr','maj','jun','jul','aug','sep','okt','nov','dec'];
    return daysUntilApply>0?'Ans√∂kan √∂ppnar '+ad.getDate()+' '+months[ad.getMonth()]:'Nu √∂ppen';
})()}</div>
    </div>
    <div style="padding:14px 10px;background:var(--al);border-radius:12px;text-align:center;border:1.5px solid var(--ac)">
    <div style="font-family:'DM Serif Display',serif;font-size:1.4rem;color:var(--ah);line-height:1">${studyStart.startsWith('HT')?'Juli':'Dec'}</div>
    <div style="font-size:.68rem;color:var(--ah);font-weight:700;text-transform:uppercase;margin-top:4px">Antagningsbesked</div>
    <div style="font-size:.7rem;color:var(--ah);margin-top:2px;opacity:.8">${startYr+compTime}</div>
    </div>
    <div style="padding:14px 10px;background:#D9F0E3;border-radius:12px;text-align:center;border:1.5px solid var(--ac)">
    <div style="font-family:'DM Serif Display',serif;font-size:1.4rem;color:var(--ah);line-height:1">${studyStart.startsWith('HT')?'Aug':'Jan'}</div>
    <div style="font-size:.68rem;color:var(--ah);font-weight:700;text-transform:uppercase;margin-top:4px">Studiestart</div>
    <div style="font-size:.7rem;color:var(--ah);margin-top:2px;opacity:.8">${startYr+compTime}</div>
    </div>
    </div>`;

    // Steg till studiestart
    h+=`<div style="display:grid;gap:8px;margin-bottom:8px">`;
    let sN=0;
    const step=(when,title,desc,urgent=false)=>
        `<div style="display:flex;gap:12px;padding:14px;background:#fff;border-radius:11px;border:${urgent?'2px solid var(--ac)':'1px solid #e0e0d8'}">
        <div style="flex-shrink:0;width:26px;height:26px;border-radius:50%;background:${urgent?'var(--ac)':'#f0f4f1'};color:${urgent?'#fff':'#6c757d'};display:flex;align-items:center;justify-content:center;font-size:.78rem;font-weight:700;margin-top:1px">${++sN}</div>
        <div style="flex:1">
        <div style="font-size:.66rem;font-weight:700;color:${urgent?'var(--ac)':'#6c757d'};text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">${when}</div>
        <div style="font-weight:700;font-size:.9rem;color:var(--ah);margin-bottom:3px">${title}</div>
        <div style="font-size:.82rem;color:#495057;line-height:1.6">${desc}</div>
        </div></div>`;

    if(a.has_grades==='unsure'){
        h+=step('Denna vecka','Kolla dina gymnasiebetyg',`Logga in p√• <strong>antagning.se</strong> med BankID ‚Üí "Mina meriter". ${e.t} kr√§ver: <strong>${e.req.join(', ')}</strong>. Ta 10 minuter nu ‚Äî det avg√∂r resten av planen.`,true);
    } else if(need){
        h+=step('Inom 2 veckor',`Ans√∂k till Komvux i ${cityName!=='hela Sverige'?cityName:'din kommun'}`,`Du saknar troligen <strong>${reqStatus.filter(r=>!r.found).map(r=>r.req).join(' och ')}</strong>. V√§lj ${a.work_status==='fulltime'?'<strong>deltid kv√§ll/distans</strong> ‚Äî du beh√•ller jobbet':'<strong>heltid</strong> ‚Äî snabbaste v√§gen'}. S√∂k p√• studera.nu, filtrera p√• distans + kv√§ll. Klart till ${studyStart.startsWith('HT')?'HT'+(startYr+1):'VT'+(startYr+1)}.`,true);
    }
    if(a.savings_amount==='none'||a.savings_amount==='under10'){
        const buf=Math.round(to*2);
        h+=step('Redan nu',`Bygg en startbuffert: ${fmt(buf)} kr`,`CSN tar 4‚Äì6 veckor p√• att betala ut. Utan buffert √§r du i kl√§m direkt. √ñppna ett separat sparkonto nu ‚Äî s√§tt in ${fmt(Math.round(buf/Math.max(2,Math.round(mo3/2))))} kr/m√•n tills studiestart.`);
    }
    if(showHousing){
        const housingTitle=isMovingCity?`Ordna boende i ${studyCityName}`:`Hitta ${hn[hou]} i ${cityName}`;
        const housingUrgency=hou==='student'&&isMovingCity?'S√• snart som m√∂jligt ‚Äî k√∂tid kan vara l√•ng':hou==='student'?'S√• snart som m√∂jligt':'Innan studiestart';
        let housingDesc='';
        if(hou==='student'){
            housingDesc=`St√§ll dig i <strong>${kotidInfo.org}</strong>s k√∂ idag. K√∂tid i ${studyCityName}: <strong>ca ${kotidInfo.q}</strong>. Gratis att st√• i k√∂ ‚Äî registrera dig nu p√• <strong>${kotidInfo.url.replace('https://','')}</strong>. Du kan alltid tacka nej om planerna √§ndras.`;
            if(isMovingCity){
                housingDesc=`Du verkar sikta p√• ${studyCityName}. St√§ll dig i <strong>${kotidInfo.org}</strong>s k√∂ <em>idag</em> ‚Äî k√∂tiden √§r ca <strong>${kotidInfo.q}</strong>. Det √§r gratis och du f√∂rlorar ingenting p√• att k√∂a tidigt.`;
            }
        } else if(hou==='shared'){
            housingDesc=`S√∂k delad l√§genhet i ${isMovingCity?studyCityName:cityName} via Blocket och Facebook-grupper. Budget: <strong>${fmt(rent)} kr/m√•n</strong>. B√∂rja leta 2‚Äì3 m√•nader f√∂re studiestart. Kontraktstid √§r ofta 1 √•r ‚Äî kolla att det st√§mmer med din studiel√§ngd.`;
        } else {
            housingDesc=`S√∂k hyresr√§tt i ${isMovingCity?studyCityName:cityName} via <strong>Blocket</strong> och ${isMovingCity?studyCityName:cityName}s bostadsf√∂rmedling. Budget: <strong>${fmt(rent)} kr/m√•n</strong>. R√§kna med 2‚Äì4 m√•naders ledtid.`;
        }
        h+=step(housingUrgency,housingTitle,housingDesc,hou==='student'&&isMovingCity);
    }
    if(a.work_status==='fulltime'||a.work_status==='parttime'){
        h+=step('2‚Äì3 m√•n f√∂re start','Prata med din arbetsgivare',`Unders√∂k om tj√§nstledighet √§r m√∂jligt ‚Äî du har r√§tt att s√∂ka det (Studieledighetslagen). ${a.study_pace==='parttime'?'Med deltidsstudier kan du kanske g√• ner till halvtid ist√§llet f√∂r att s√§ga upp dig helt.':'Om du m√•ste s√§ga upp dig: kolla din upps√§gningstid och ber√§kna innest√•ende semesterdagar som extra buffert.'}`);
    }
    h+=step(`Senast ${studyStart.startsWith('HT')?'15 april':'15 oktober'} ${startYr+compTime}`,`S√∂k ${e.t} p√• antagning.se`,`S√∂k det h√§r programmet plus 2‚Äì3 backupalternativ. Du kan prioritera upp till 20 program ‚Äî anv√§nd det. ${schs.length>0?'Dina n√§rmaste alternativ: <strong>'+schs.slice(0,2).map(s=>s.school).join('</strong>, <strong>')+'</strong>.':''}`,true);
    if(a.need_csn!=='no'){
        h+=step('Direkt efter antagningsbesked','Ans√∂k om CSN p√• csn.se',`Bidrag: <strong>${fmt(BID)} kr/m√•n</strong>${barnCSN?' + barntill√§gg '+fmt(barnCSN)+' kr':''}${loan>0?'. L√•n: <strong>'+fmt(loan)+' kr/m√•n</strong>':''}. Ans√∂k direkt ‚Äî CSN betalar inte retroaktivt. Ha personnummer och programkod redo.`);
    }
    h+=step(studyStart.startsWith('HT')?'Augusti '+(startYr+compTime):'Januari '+(startYr+compTime),'STUDIESTART',`${Math.ceil(ry)} √•r. Du tar examen ${gradYear} ‚Äî ${gradAge} √•r gammal.`);
    h+=`</div>`;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FAS 2 ‚Äî STUDIETIDEN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    h+=fasHeader(
        `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>`,
        'Fas 2 ‚Äî Studietiden',
        `${Math.ceil(ry)} √•r ‚Äî ${studyStart} ${startYr+compTime} till examen ${gradYear}`,
        'var(--ah)','linear-gradient(135deg,var(--ah),#356b4b)'
    );

    // Intro-text baserad p√• studieform
    const studieIntro=a.study_pace==='parttime'?`Du studerar p√• deltid ‚Äî det tar l√§ngre men du beh√•ller inkomst och minskar ekonomisk stress. De flesta som studerar deltid s√§ger att det √§r mer h√•llbart √§n de trodde.`:a.study_mode==='distance'?`Du studerar p√• distans ‚Äî stor frihet men kr√§ver struktur. Schemal√§gg studietid i din kalender som fasta block, annars skjuter du upp det.`:`Du studerar p√• heltid. Det g√•r fort ‚Äî och det √§r intensivt. Planera in buffert i schema och ekonomi redan nu.`;
    h+=`<div style="padding:14px 16px;background:var(--al);border-radius:10px;border-left:3px solid var(--ac);font-size:.85rem;color:var(--ah);line-height:1.65;margin-bottom:14px">${studieIntro}</div>`;

    // Psykologisk mening Fas 2
    h+=`<div style="padding:14px 16px;background:rgba(0,0,0,.04);border-radius:10px;font-size:.9rem;line-height:1.7;color:#3a4a3a;margin-bottom:20px;border-left:3px solid var(--ac)">
    ${Math.ceil(ry)} √•r g√•r oavsett. Fr√•gan √§r om du √§r ${gradAge} med eller utan examen.
    </div>`;
    // Termin/√•r-kort
    const termCards=[
        {period:`Vecka 1‚Äì4`,title:'Det vilda startskedet',
        desc:`CSN har inte betalat ut √§n ‚Äî <strong>du beh√∂ver bufferten du byggde</strong>. Introduktionsveckan √§r intensiv: nya m√§nniskor, nytt system, ny rutin. K√§nslan av att "alla verkar veta mer √§n jag" √§r universell och g√•r √∂ver. F√∂rsta utbetalningen fr√•n CSN kommer vecka 5‚Äì6.`,
        note:loan>0?`Budget dessa veckor: sparad buffert + eventuell l√∂n om du jobbar extra.`:`Bidrag startar vecka 5‚Äì6: ${fmt(BID)} kr/m√•n.`},

        {period:`Termin 1`,title:'Det sv√•raste halv√•ret',
        desc:`Studietakten √§r annorlunda √§n jobbet ‚Äî mer sj√§lvstudier, mer ansvar. ${e.id===1?'VFU-veckor (praktik p√• v√•rdinstitution) b√∂rjar redan √•r 1 f√∂r m√•nga sjuksk√∂terskeprogrammen.':e.id===2?'F√∂rsta programmeringskurserna √§r intensiva. Plug-and-play l√∂sningar finns inte ‚Äî du m√•ste f√∂rst√•.':'Det tar en termin att l√§ra sig hur man studerar. Det √§r normalt.'} De flesta som hoppar av g√∂r det nu ‚Äî de som stannar kvar √§r n√∂jda att de gjorde det.`,
        note:`${a.work_during!=='no'?'Du planerar att jobba extra ‚Äî h√•ll det under 10‚Äì15 h/v det f√∂rsta halv√•ret.':'Om ekonomin k√§rvar: ett extra skifte i veckan g√∂r stor skillnad utan att studierna p√•verkas.'}`},

        {period:`√Ör ${Math.min(2,Math.ceil(ry))}${Math.ceil(ry)>1?'‚Äì'+Math.ceil(ry-1):''}`,title:'Ryggm√§rgen',
        desc:`Nu vet du hur systemet fungerar. Examinationsstressen minskar. Du b√∂rjar se dig sj√§lv som ${e.t.toLowerCase()}. ${e.id===1?'VFU-perioder b√∂rjar v√§xa ‚Äî du tr√§ffar patienter, arbetar i team, f√∂rst√•r varf√∂r du valde detta.':e.id===2?'Du b√∂rjar bygga projekt, l√§r dig Git, f√∂rst√•r varf√∂r saker fungerar som de g√∂r.':'Kurser som k√§ndes abstrakta √•r 1 faller p√• plats.'} ${a.has_partner==='yes_same'?'St√§m av regelbundet med din partner ‚Äî studietiden p√•verkar relationen mer √§n folk tror, men det g√•r om ni pratar om det.':''}`,
        note:debt>0?`Du betalar inga CSN-l√•n under studietiden. Skulden ${fmt(debt)} kr v√§ntar tills examen.`:`Du studerar utan l√•n ‚Äî det h√•ller skulds√§ttningen l√•g.`},

        {period:`Sista terminen`,title:'Rakan mot examen',
        desc:`${e.id===1?'Examensarbete + sista VFU-blocken. M√•nga tackar ja till jobb p√• sin VFU-plats direkt.':e.id===2?'Examensarbete och ofta en LIA-praktik (L√§rande i arbete) d√§r de flesta f√•r jobberbud.':'Examensarbete. B√∂rja n√§tverka nu ‚Äî LinkedIN, branschevent, studiepraktik.'} B√∂rja s√∂ka jobb <strong>3‚Äì4 m√•nader f√∂re examen</strong>. Arbetsgivare r√§knar med att du b√∂rjar m√•naden efter.`,
        note:`Examen: ${gradYear}. Du √§r ${gradAge} √•r.`}
    ];

    h+=`<div style="display:grid;gap:10px;margin-bottom:8px">`;
    termCards.slice(0,Math.ceil(ry)>=2?4:2).forEach(tc=>{
        h+=`<div style="background:#fff;border-radius:12px;border:1px solid #e0e0d8;overflow:hidden">
        <div style="padding:10px 14px;background:#f8f9fa;border-bottom:1px solid #e0e0d8;display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700;font-size:.85rem;color:var(--ah)">${tc.title}</div>
        <div style="font-size:.72rem;font-weight:700;color:var(--ac);background:var(--al);padding:3px 10px;border-radius:20px">${tc.period}</div>
        </div>
        <div style="padding:14px">
        <div style="font-size:.84rem;color:#495057;line-height:1.7;margin-bottom:8px">${tc.desc}</div>
        <div style="font-size:.78rem;color:#6c757d;padding:8px 12px;background:#f8f9fa;border-radius:7px;border-left:2px solid #d0d0c8">${tc.note}</div>
        </div>
        </div>`;
    });
    h+=`</div>`;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FAS 3 ‚Äî LIVET EFTER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    h+=fasHeader(
        `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></svg>`,
        'Fas 3 ‚Äî Livet efter examen',
        `${gradYear} och fram√•t ‚Äî ${gradAge} √•r gammal`,
        'var(--ah)','linear-gradient(135deg,#1a4530,var(--ac))'
    );

    h+=`<div style="padding:14px 16px;background:rgba(0,0,0,.04);border-radius:10px;font-size:.9rem;line-height:1.7;color:#3a4a3a;margin-bottom:20px;border-left:3px solid var(--ac)">
    Det h√§r √§r inte en dr√∂m l√§ngre. Det √§r ett schema.
    </div>
    <div style="display:grid;gap:10px;margin-bottom:16px">

    <div style="background:#fff;border-radius:12px;border:1px solid #e0e0d8;overflow:hidden">
    <div style="padding:10px 14px;background:#D9F0E3;border-bottom:1px solid rgba(122,194,154,.3);display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:700;font-size:.85rem;color:var(--ah)">F√∂rsta jobbet ‚Äî √Ör 1</div>
    <div style="font-size:.8rem;font-weight:700;color:var(--ah)">${fmt(salYr1)} kr/m√•n</div>
    </div>
    <div style="padding:14px;font-size:.84rem;color:#495057;line-height:1.7">
    Ing√•ngsl√∂nen f√∂r ${e.t.toLowerCase()} √§r <strong>${fmt(salYr1)} kr/m√•n</strong>. ${e.dem>=4?'Med '+( e.dem===5?'akut':'h√∂g')+' efterfr√•gan tar de flesta examinerade jobb inom 1‚Äì3 m√•nader. Arbetsgivare rekryterar aktivt.':'Rekryteringstiden varierar ‚Äî r√§kna med 1‚Äì4 m√•nader.'} 
    ${debt>0?`<br><br>CSN-√•terbetalning startar ~6 m√•nader efter examen: ca <strong>${fmt(pb)} kr/m√•n</strong>. Du tj√§nar ${fmt(salYr1-pb)} kr (brutto) efter amortering ‚Äî ${salYr1-pb>+(a.current_salary||0)?'mer √§n du tj√§nar idag':'justerat f√∂r √•terbetalning'}.`:'Inga studiel√•n att betala tillbaka.'}
    </div>
    </div>

    <div style="background:#fff;border-radius:12px;border:1px solid #e0e0d8;overflow:hidden">
    <div style="padding:10px 14px;background:var(--al);border-bottom:1px solid #d0e4d6;display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:700;font-size:.85rem;color:var(--ah)">Med erfarenhet ‚Äî √Ör 3‚Äì5</div>
    <div style="font-size:.8rem;font-weight:700;color:var(--ah)">${fmt(salYr3)}‚Äì${fmt(salYr5)} kr/m√•n</div>
    </div>
    <div style="padding:14px;font-size:.84rem;color:#495057;line-height:1.7">
    Med 3‚Äì5 √•rs erfarenhet r√∂r sig l√∂nen mot <strong>${fmt(salYr3)}</strong> (√•r 3) och <strong>${fmt(salYr5)}</strong> (√•r 5). 
    ${e.id===1?'Som specialistsjuksk√∂terska (1 extra √•r) √∂kar l√∂nen ytterligare ‚Äî avl√∂nat med specialisttill√§gg p√• 2 000‚Äì5 000 kr/m√•n.':e.id===2?'Seniora systemutvecklare kan f√∂rhandla l√∂n aktivt ‚Äî 5 000‚Äì15 000 kr-hopp √§r vanliga p√• 3‚Äì5 √•r.':e.id===3?'L√§rarl√∂nen √∂kar med erfarenhet och ansvar. Lektors- och f√∂rstel√§rartill√§gg ger 3 000‚Äì6 000 kr extra.':'L√∂ne√∂kningen beror p√• bransch och arbetsgivare ‚Äî f√∂rhandla aktivt, det l√∂nar sig.'}
    </div>
    </div>

    <div style="background:#fff;border-radius:12px;border:1px solid #e0e0d8;overflow:hidden">
    <div style="padding:10px 14px;background:#cfe2ff;border-bottom:1px solid #b6d4fe;display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:700;font-size:.85rem;color:#084298">Toppinkomst</div>
    <div style="font-size:.8rem;font-weight:700;color:#084298">${fmt(e.s1)} kr/m√•n</div>
    </div>
    <div style="padding:14px;font-size:.84rem;color:#495057;line-height:1.7">
    Erfarna ${e.t.toLowerCase().replace(/^./,c=>c.toLowerCase())}s med specialisering, ledarskap eller nischkompetens n√•r <strong>${fmt(e.s1)} kr/m√•n</strong>. 
    ${be>0&&be<40?`Break-even f√∂r din investering √§r om <strong>~${be} √•r</strong> ‚Äî efter det √§r varje extra m√•nad i yrket ren vinst j√§mf√∂rt med att ha blivit kvar.`:'Investeringen i utbildning l√∂nar sig med r√§nta p√• r√§nta-effekten av den h√∂jda l√∂nen.'}
    </div>
    </div>

    </div>`;

    // Social proof ‚Äî forum/artikel-stories
    h+=`<div style="margin-bottom:16px">
    <div style="font-size:.72rem;font-weight:700;color:#6c757d;text-transform:uppercase;letter-spacing:.6px;margin-bottom:10px">Erfarenheter fr√•n forum och artiklar</div>
    <div style="display:grid;gap:10px">`;

    const stories={
        1:[
            {quote:'Jobbade 8 √•r i butik. Var 33 n√§r jag s√∂kte sjuksk√∂terskeutbildningen. Trodde att det var f√∂r sent ‚Äî det var det inte. De √§ldre i klassen var de b√§sta studenterna.',from:'Flashback, V√•rd & h√§lsa',yr:'2023'},
            {quote:'F√∂rsta terminen var chocken. Ekonomin stressade, jag hann inte med. Andra terminen satte jag ett system och det funkade. Examen togs 2022, jobbar nu p√• Karolinska.',from:'Reddit r/Sweden, karri√§rbyte',yr:'2022'},
            {quote:'R√§dslan att "inte vara smart nog" √§r den vanligaste orsaken till att folk inte s√∂ker. I klassen p√• 40 hade h√§lften jobbat minst 5 √•r innan.',from:'Universitetsl√§rare citerad i Dagens Nyheter',yr:'2023'}
        ],
        2:[
            {quote:'Bygg i 12 √•r. S√∂kte systemutvecklarprogrammet vid 38. Fick jobb p√• Klarna 3 m√•nader efter examen. Min bakgrund var en f√∂rdel ‚Äî de beh√∂vde folk som f√∂rst√•r verkliga problem.',from:'LinkedIn, karri√§rbyte-tr√•d',yr:'2023'},
            {quote:'Distansprogrammet h√∂ll hela familjelivet intakt. Pluggade p√• kv√§llar och helger i 2,5 √•r. Sv√•rt ‚Äî men genomf√∂rbart. Idag 20 000 kr mer i m√•naden.',from:'Flashback, Studier & utbildning',yr:'2024'},
            {quote:'Det sv√•raste var att s√§ga upp mig. Sedan det var gjort f√∂rsvann tvivlet. Hj√§rnan slutar h√•lla tv√• alternativ √∂ppna.',from:'Twitter/X, tr√•d om karri√§rbyte',yr:'2023'}
        ],
        3:[
            {quote:'Byte fr√•n detaljhandel till l√§rare vid 31. Praktiken det sista √•ret √∂ppnade alla d√∂rrar ‚Äî fick jobberbjudande p√• min VFU-skola direkt.',from:'L√§rarf√∂rbundets forum',yr:'2023'},
            {quote:'KBT-terapeuten fr√•gade vad jag ville g√∂ra om tio √•r. L√§rare. "Vad v√§ntar du p√•?" Tre √•r senare tog jag examen.',from:'Aftonbladet, reportage om karri√§rbyte',yr:'2022'},
            {quote:'Klassen bestod till 60% av folk som bytt karri√§r. Snittalder 29. Det var inte skolan jag mindes ‚Äî det var ett lag med syfte.',from:'Flashback, Studier & utbildning',yr:'2024'}
        ],
        4:[
            {quote:'Jobbade som butiksansvarig i 7 √•r. S√∂kte civilekonomprogrammet vid 32. Alla sa att det var f√∂r sent. Nu √§r jag controller p√• ett techbolag ‚Äî l√∂nen √§r det dubbla.',from:'LinkedIn, karri√§rbyte',yr:'2023'},
            {quote:'Det sv√•raste var att acceptera att betygen fr√•n gymnasiet faktiskt r√§ckte. Jag trodde att ekonomiprogram kr√§ver toppbetyg. Det g√∂r de inte om man v√§ljer r√§tt skola.',from:'Flashback, Studier & utbildning',yr:'2024'},
            {quote:'Businesssidan gav mig perspektiv som de som gick rakt fr√•n gymnasiet inte hade. Arbetsgivare fr√•gade aktivt om min tidigare branscherfarenhet.',from:'Reddit r/Ekonomi',yr:'2023'}
        ],
        5:[
            {quote:'Tre √•r l√§rling. S√∂kte civilingenj√∂r vid 26. Kombinationen praktisk erfarenhet + ingenj√∂rsexamen √§r extremt s√§llsynt ‚Äî det m√§rks direkt p√• l√∂neerbjudandena.',from:'Ingenj√∂ren.se, forum',yr:'2023'},
            {quote:'Matte var skr√§cken. Men det visar sig att vuxna l√§r sig matte b√§ttre ‚Äî man f√∂rst√•r varf√∂r man l√§r sig det. Tog Matte 4 p√• komvux p√• ett √•r.',from:'Flashback, Utbildning',yr:'2024'},
            {quote:'Fem √•r p√• KTH √§r en l√•ng tid. Men jag √§r 31 med ingenj√∂rsexamen och 42 000 kr/m√•n. Kollegorna som inte pluggade tj√§nar fortfarande 29 000.',from:'Twitter/X, tr√•d om ingenj√∂rsl√∂n',yr:'2023'}
        ],
        51:[
            {quote:'Indek √§r b√§sta kombinationen om du vill leda teknikprojekt men hata att sitta och r√§kna FEM-simuleringar. Du f√∂rst√•r ingenj√∂rerna och kan prata med ekonomerna.',from:'Reddit r/ingenjor',yr:'2024'},
            {quote:'Jobbet efter examen kom via sommarjobb under √•r 4. N√§tverket p√• Link√∂ping √§r exceptionellt ‚Äî hela √ñsterg√∂tlandsregionen rekryterar d√§rifr√•n.',from:'Flashback, Jobb & karri√§r',yr:'2023'},
            {quote:'Ingen √•ngrade valet av Indek. Det √§r det enda jag h√∂rt fr√•n alla p√• mitt program, och vi √§r nu 6 √•r efter examen.',from:'LinkedIn-kommentar, Link√∂ping alumni',yr:'2024'}
        ],
        6:[
            {quote:'Var sjukv√•rdsbitr√§de i 9 √•r. Tog steget till socionom vid 35. Sv√•rt ekonomiskt ‚Äî men jobbet efter√•t √§r meningsfullt p√• ett helt annat plan.',from:'Akademikerf√∂rbundet SSR, forum',yr:'2023'},
            {quote:'Folk fr√•gar om det √§r tungt att jobba med sv√•ra fall. Det √§r det. Men det √§r ocks√• ett av de enda jobb d√§r du faktiskt m√§rker att du gjort skillnad.',from:'Flashback, V√•rd & omsorg',yr:'2024'},
            {quote:'VFU-handledaren erbj√∂d mig jobb direkt. 26 veckor praktik bygger relationer och referenserna √§r guld v√§rda.',from:'Socionomprogrammets alumnigrupp, Facebook',yr:'2023'}
        ],
        7:[
            {quote:'YH-utbildningen var praktisk fr√•n dag 1. Inget fluff. Fick jobb 3 veckor efter examen ‚Äî arbetsgivaren hade sett mig under LIA redan.',from:'Yrgo.se studentblogg',yr:'2024'},
            {quote:'Elektriker √§r det b√§sta yrkesvalet jag gjort. Alltid jobb. Kan jobba i alla st√§der. Kan starta eget. Och AI kan inte dra kabel √•t dig.',from:'Flashback, El & energi',yr:'2023'},
            {quote:'Folk tittar ned p√• yrkesutbildningar. De tj√§nar 28 000 kr. Jag tj√§nar 38 000. De undrar varf√∂r.',from:'Reddit r/sweden, l√∂n-diskussion',yr:'2024'}
        ],
        8:[
            {quote:'S√∂kte utan portfolio. Fick backa och b√∂rja om med riktiga projekt. B√§sta r√•det: bygg tre fall-studier under utbildningen ‚Äî inte kursinl√§mningar, utan skarpa projekt.',from:'Nackademin studentblogg',yr:'2024'},
            {quote:'AI f√∂r√§ndrar UX-rollen, men det g√∂r alla senior-positioner mer v√§rdefulla, inte f√§rre. Du m√•ste kunna designa f√∂r och med AI ‚Äî det √§r en kompetens, inte ett hot.',from:'Linkedin, UX-debatt',yr:'2024'},
            {quote:'Switchar fr√•n marknadsf√∂ring. Kursen l√§rde mig att argumentera med data ist√§llet f√∂r magk√§nsla. Det √§r det som separerar junior fr√•n senior UX.',from:'Flashback, Design & kreativt',yr:'2023'}
        ]
    };
    const storySet=stories[e.id]||(stories[5]&&e.id===51?stories[51]:stories[1]);
    storySet.forEach(s=>{
        h+=`<div style="padding:14px 16px;background:#fff;border-radius:11px;border:1px solid #e0e0d8;border-left:3px solid var(--ac)">
        <div style="font-size:.84rem;color:var(--ah);line-height:1.7;margin-bottom:8px;font-style:italic">"${s.quote}"</div>
        <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:.72rem;color:#6c757d">${s.from}</div>
        <div style="font-size:.7rem;color:#aaa">${s.yr}</div>
        </div>
        </div>`;
    });
    h+=`</div></div>`;

    // Backup-planer
    h+=`<div style="background:#fff;border-radius:12px;border:1px solid #e0e0d8;padding:18px;margin-bottom:8px">
    <div style="font-weight:700;font-size:.9rem;color:var(--ah);margin-bottom:12px">Om du inte kommer in f√∂rsta g√•ngen</div>
    <div style="display:grid;gap:10px">
    <div style="display:flex;gap:10px;align-items:flex-start"><div style="width:6px;height:6px;border-radius:50%;background:var(--ac);flex-shrink:0;margin-top:6px"></div><div style="font-size:.83rem;color:#495057;line-height:1.6"><strong>Reservplats</strong> ‚Äî tacka alltid ja. M√•nga program fyller p√• hela juli/december. Chansen √§r 30‚Äì50%.</div></div>
    <div style="display:flex;gap:10px;align-items:flex-start"><div style="width:6px;height:6px;border-radius:50%;background:var(--ac);flex-shrink:0;margin-top:6px"></div><div style="font-size:.83rem;color:#495057;line-height:1.6"><strong>H√∂gskoleprov</strong> ‚Äî anm√§l dig n√§sta omg√•ng (450 kr). Giltigt i 5 √•r. Parallell kvot in ‚Äî du konkurrerar inte mot betygss√∂kande.</div></div>
    <div style="display:flex;gap:10px;align-items:flex-start"><div style="width:6px;height:6px;border-radius:50%;background:var(--ac);flex-shrink:0;margin-top:6px"></div><div style="font-size:.83rem;color:#495057;line-height:1.6"><strong>Annan ort</strong> ‚Äî l√§gre antagningspo√§ng p√• mindre orter. Kolla Studentum med hela Sverige som filter.</div></div>
    <div style="display:flex;gap:10px;align-items:flex-start"><div style="width:6px;height:6px;border-radius:50%;background:var(--ac);flex-shrink:0;margin-top:6px"></div><div style="font-size:.83rem;color:#495057;line-height:1.6"><strong>Anv√§nd tiden v√§l</strong> ‚Äî ett √•r av extra Komvux-kurser, mer besparingar och ett HP-f√∂rs√∂k g√∂r n√§sta ans√∂kan avsev√§rt starkare.</div></div>
    </div>
    </div>`;

    h+=`</div>`; // end #planTid
    
    // ‚ïê‚ïê‚ïê SAMMANFATTNING PANEL ‚ïê‚ïê‚ïê
    h+=`<div id="planSkol" style="display:none">`;

    // ‚îÄ‚îÄ Bygg personlig situationsanalys ‚îÄ‚îÄ
    const whyMap={meaning:'ett meningsfullt jobb',salary:'b√§ttre l√∂n',burnout:'att l√§mna ett jobb som tar ut dig',career:'b√§ttre karri√§rm√∂jligheter',passion:'f√∂lja det du alltid velat g√∂ra',other:''};
    const whyText=whyMap[a.why_change]||'';
    const concern=a.biggest_concern||'none';
    const hpConsidered=a.hp_considered||'no';

    // Concern-svar
    const concernReply={
        economy: bal<0?`Ekonomin √§r din oro ‚Äî och med nuvarande inst√§llningar √§r det tight (${(bal>=0?'+':'')+fmt(bal)} kr/m√•n). G√• till Ekonomi-fliken och prova att h√∂ja l√•net eller l√§gga till extrajobb f√∂r att se vad som funkar.`:`Du oroar dig f√∂r ekonomin, men baserat p√• dina svar ser det faktiskt okej ut: ${fmt(bal>0?'+'+bal:bal)} kr kvar per m√•nad. Forts√§tt finjustera i Ekonomi-fliken.`,
        time: `Tid √§r en verklig begr√§nsning. ${a.study_pace==='parttime'?'Du har redan valt deltid ‚Äî det √§r r√§tt beslut. Halvfart tar '+Math.ceil(ry*2)+' √•r men du beh√•ller inkomst och balans.':'Heltid kr√§ver att du frig√∂r ~40 h/v. Om du jobbar idag beh√∂ver du planera upps√§gning eller tj√§nstledighet.'}`,
        grades: `Betyg √§r inte allt ‚Äî HP ger en separat kvot in. ${hpConsidered==='no'||hpConsidered==='no_considered'?'Du har inte skrivit HP √§nnu. Anm√§l dig n√§sta omg√•ng (450 kr) och tr√§na p√• gamla prov ‚Äî po√§ngen f√∂rb√§ttras markant med √∂vning.':'Bra att du redan funderat p√• HP ‚Äî h√•ll det som plan B om betygen inte r√§cker.'}`,
        age: `√Öldern √§r inte ett hinder ‚Äî det √§r en f√∂rdel. ${age>=35?'Tusentals b√∂rjar vid 35+ varje √•r. Med '+fmt(e.s1)+' kr i toppinkomst och '+(65-age-Math.ceil(ry)-compTime)+' √•r kvar i yrket betalar investeringen sig klart.':'Du √§r '+age+' √•r. N√§stan en tredjedel av alla studenter √§r 25+. Arbetsgivare v√§rdes√§tter livserfarenhet.'}`,
        job: `Jobbutsikterna f√∂r ${e.t.toLowerCase()} √§r ${e.dem===5?'extremt starka ‚Äî akut brist i sektorn':e.dem===4?'starka ‚Äî arbetsgivare s√∂ker aktivt':'stabila'}. ${e.dem>=4?'De flesta examinerade tar jobb direkt efter examen.':'Kontrollera den lokala arbetsmarknaden p√• arbetsformedlingen.se.'}`,
        none: `Du verkar redo ‚Äî det √§r bra. Planen nedan √§r din konkreta v√§g fram√•t.`
    };
    const concernText=concernReply[concern]||concernReply.none;

    // Datum-ber√§kningar
    const now2=new Date();
    const nowMo=now2.getMonth(); // 0-indexed
    const nowYr=now2.getFullYear();
    // N√§sta Komvux-ans√∂kan (l√∂pande, men VT startar jan, HT startar aug)
    const komvuxDeadline=nowMo<6?'1 juni '+(nowYr):('1 november '+nowYr);
    const komvuxStartTerm=nowMo<6?'HT'+nowYr:'VT'+(nowYr+1);
    // HP-datum
    const hpNextTerm=nowMo<3?'mars/april '+nowYr:nowMo<8?'oktober '+nowYr:'mars/april '+(nowYr+1);
    const hpDeadline=nowMo<3?'februari '+nowYr:nowMo<8?'september '+nowYr:'februari '+(nowYr+1);
    // Antagning.se deadline
    const _applyDLDate=studyStart.startsWith('HT')?new Date(startYr,3,15):new Date(startYr,9,15);
    const _applyDLNextDate=studyStart.startsWith('HT')?new Date(startYr+1,3,15):new Date(startYr+1,9,15);
    const applyDL=_applyDLDate<now2?(studyStart.startsWith('HT')?'15 april '+(startYr+1):'15 oktober '+(startYr+1)):(studyStart.startsWith('HT')?'15 april '+startYr:'15 oktober '+startYr);

    // Bygg steg
    const steps2=[];
    let stepDue='Denna vecka';

    // Steg 0: Oro-svar
    // (inline i sammanfattningstext)

    // Steg 1: Betyg/beh√∂righet
    if(a.has_grades==='unsure'){
        steps2.push({when:'Denna vecka',icon:'üéì',title:'Kolla dina gymnasiebetyg',desc:'Logga in p√• <strong>antagning.se</strong> med BankID ‚Üí "Mina meriter". Ta 10 minuter nu ‚Äî det avg√∂r hela din tidslinje.',urgent:true});
    } else if(need&&part){
        steps2.push({when:komvuxDeadline,icon:'üìö',title:'Ans√∂k till Komvux i '+(cityName!=='hela Sverige'?cityName:'din kommun'),desc:`Du saknar troligen ${reqStatus.filter(r=>!r.found).map(r=>r.req).join(' och ')}. S√∂k Komvux ${a.work_status==='fulltime'&&a.study_mode!=='distance'?'<strong>deltid kv√§ll/distans</strong> vid sidan av jobbet':'<strong>heltid</strong> f√∂r snabbaste v√§g'}. Deadline: <strong>${komvuxDeadline}</strong> f√∂r start ${komvuxStartTerm}.`,urgent:true});
    } else if(need&&!part){
        steps2.push({when:komvuxDeadline,icon:'üìö',title:'Starta med Komvux',desc:`Du beh√∂ver komplettera ${reqStatus.filter(r=>!r.found).map(r=>r.req).join(', ')}. S√∂k p√• <strong>studera.nu</strong> ‚Äî filtrera p√• distans + kv√§ll om du vill beh√•lla jobbet. Deadline: <strong>${komvuxDeadline}</strong>.`,urgent:true});
    }

    // Steg 2: HP (om relevant)
    if((hpConsidered==='no_considered'||hpConsidered==='no')&&(need||!full)){
        steps2.push({when:hpDeadline,icon:'üìù',title:'Anm√§l dig till H√∂gskoleprov',desc:`HP ger dig en separat kvot in ‚Äî du konkurrerar inte med betygss√∂kande. Anm√§lan √∂ppnar ca <strong>${hpDeadline}</strong>, provdatum <strong>${hpNextTerm}</strong>. Kostar 450 kr. Tr√§na 2‚Äì4 veckor p√• gamla prov ‚Äî po√§ngen f√∂rb√§ttras tydligt med √∂vning. Anm√§l p√• <strong>studera.nu/hogskoleprov</strong>.`});
    }

    // Steg 3: Buffert om sparande = 0
    if(a.savings_amount==='none'||a.savings_amount==='under10'){
        const buffert=Math.round(to*2);
        const mthsLeft=Math.max(1,Math.ceil((new Date(startYr+compTime,studyStart.startsWith('HT')?7:0,1)-now2)/(1000*60*60*24*30)));
        const savePerMo=Math.round(buffert/Math.min(mthsLeft,6));
        steps2.push({when:'Innan studiestart',icon:'üí∞',title:`Bygg buffert: ${fmt(buffert)} kr`,desc:`CSN tar 4‚Äì6 veckor innan f√∂rsta utbetalning. Du beh√∂ver t√§cka ${fmt(to)} kr/m√•n i ca 2 m√•nader. S√§tt undan ungef√§r <strong>${fmt(savePerMo)} kr/m√•n</strong> fram√•t. √ñppna ett separat sparkonto ‚Äî m√§rk det "Studiestart".`});
    }

    // Steg 4: Boende
    if(showHousing){
        const houTarget=isMovingCity?studyCityName:cityName;
        let houDesc='';
        if(hou==='student'){
            houDesc=`St√§ll dig i ${kotidInfo.org}s k√∂ idag ‚Äî <strong>${kotidInfo.url.replace('https://','')}</strong>. K√∂tid i ${houTarget}: ca <strong>${kotidInfo.q}</strong>. Gratis att k√∂a, inga f√∂rpliktelser.`;
        } else {
            houDesc=`S√∂k ${hn[hou]} i ${houTarget} via Blocket och lokala Facebook-grupper. Budget: ${fmt(rent)} kr/m√•n. B√∂rja leta 2‚Äì3 m√•nader f√∂re studiestart.`;
        }
        steps2.push({when:hou==='student'?'S√• snart som m√∂jligt':'Innan studiestart',title:`${isMovingCity?'Flytt till '+houTarget+' ‚Äî ordna boende':'Ordna '+hn[hou]+' i '+houTarget}`,desc:houDesc});
    }

    // Steg 5: Ans√∂kan till program
    const applyYearNote=compTime>0?` (${compTime} √•r senare pga. komplettering)`:'';
    steps2.push({when:applyDL+applyYearNote,icon:'üéØ',title:`S√∂k ${e.t} p√• antagning.se`,desc:`G√• till <strong>antagning.se</strong> ‚Üí s√∂k "${e.t}" ‚Üí v√§lj ${schs.length>0?'"'+schs[0].school+(schs.length>1?'" eller "'+schs[1].school:'')+'"':'din skola'}. Du kan prioritera upp till 20 program. <strong>Deadline: ${applyDL}</strong>. Sent inkommen ans√∂kan = ingen plats.${compTime>0?' Obs: Kompletteringen tar '+compTime+(compTime===1?' √•r':' √•r') +' ‚Äî d√§rav det senare datumet.':''}`,urgent:true});

    // Steg 6: CSN
    if(a.need_csn!=='no'){
        const csnYear=startYr+compTime;
        const csnMonth=studyStart.startsWith('HT')?'juli':'december';
        steps2.push({when:'Efter antagningsbesked ('+csnMonth+' '+csnYear+')',icon:'üí≥',title:'Ans√∂k om CSN',desc:`Logga in p√• <strong>csn.se</strong> direkt n√§r du f√•tt antagningsbesked. Bidrag: <strong>${fmt(BID)} kr/m√•n</strong>${barnCSN?' + barntill√§gg '+fmt(barnCSN)+' kr/m√•n':''}${loan>0?', l√•n: '+fmt(loan)+' kr/m√•n':''}. Viktigt: ans√∂k i tid ‚Äî utbetalning sker inte retroaktivt.`});
    }

    // Steg 7: Jobbet
    if(a.work_status==='fulltime'||a.work_status==='parttime'){
        const actualStartYr=startYr+compTime;
        const noticeMo=studyStart.startsWith('HT')?'maj/juni '+actualStartYr:'november/december '+(actualStartYr-1);
        steps2.push({when:noticeMo,icon:'üíº',title:'Planera din upps√§gning',desc:`${a.study_pace==='parttime'?'Du planerar deltid ‚Äî kolla om din arbetsgivare kan g√• ner i tj√§nst ist√§llet f√∂r att s√§ga upp. Tj√§nstledighet f√∂r studier √§r en laglig r√§ttighet (Studieledighetslagen).':'L√§mna in din upps√§gning i god tid. Kolla din upps√§gningstid i anst√§llningsavtalet ‚Äî vanligtvis 1‚Äì3 m√•nader.'} R√§kna med innest√•ende semesterdagar som extra buffert.`});
    }

    // Steg 8: Barn
    if(a.has_kids==='yes'){
        steps2.push({when:'Innan studiestart',icon:'üë∂',title:'Ordna barnomsorg under studietiden',desc:`Kolla om ${cityName!=='hela Sverige'?cityName:'din kommun'} ger studenter f√∂rtur i barnomsorgen ‚Äî m√•nga kommuner g√∂r det. St√§m av ditt schema mot barnomsorgens √∂ppettider. ${a.study_mode==='distance'?'Distansstudier ger mer flexibilitet men kr√§ver √§nd√• struktur.':''}`});
    }

    // L√§gg till studiestart som sista steg
    steps2.push({when:(studyStart.startsWith('HT')?'Augusti ':'Januari ')+( startYr+compTime),icon:'üéì',title:`STUDIESTART ‚Äî ${e.t}`,desc:`${ry} √•r. Examen ${gradYear}, du √§r ${gradAge} √•r. Ing√•ngsl√∂n: <strong>${fmt(e.s0)} kr/m√•n</strong>. Toppinkomst med erfarenhet: <strong>${fmt(e.s1)} kr/m√•n</strong>.`,final:true});

    // ‚îÄ‚îÄ RENDERA PANELEN ‚îÄ‚îÄ

    // Intro-kort med oro-svar
    h+=`<div style="background:#fff;border:2px solid #e0e0d8;border-radius:16px;padding:22px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
    <div style="display:flex;align-items:flex-start;gap:12px">
    <div style="width:36px;height:36px;border-radius:50%;background:var(--ac);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0">‚ú¶</div>
    <div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.2rem;color:var(--ah);margin-bottom:6px">${firstName} ‚Äî h√§r √§r din konkreta plan</div>
    <p style="font-size:.88rem;color:#495057;line-height:1.7;margin-bottom:10px">Du funderar p√• att bli <strong>${e.t.toLowerCase()}</strong>. Du √§r ${age} √•r, tj√§nar ${fmt(currentSal)} kr/m√•n idag och vill b√∂rja studera ${a.when_start==='asap'?'s√• snart som m√∂jligt':a.when_start==='next'?'n√§sta termin':'inom '+a.when_start.replace('mo',' m√•nader').replace('12mo','12 m√•nader')}. Utbildningen tar <strong>${ry} √•r</strong> och du tar examen <strong>${gradYear}</strong> ‚Äî ${gradAge} √•r gammal.</p>
    ${whyText?`<p style="font-size:.88rem;color:#495057;line-height:1.7;margin-bottom:10px">Du vill ha <strong>${whyText}</strong> ‚Äî planen nedan √§r byggd f√∂r att ta dig dit.</p>`:''}
    ${concern!=='none'?`<div style="padding:10px 14px;background:#f0f4f1;border-radius:8px;border-left:3px solid var(--ac);font-size:.84rem;color:var(--ah);line-height:1.65">${concernText}</div>`:``}
    </div>
    </div>
    </div>`;

    // Live-kort (4 st)
    h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:20px">
    <div style="padding:12px;background:${bal>=0?'#D9F0E3':'#f8d7da'};border-radius:10px;text-align:center" id="fBV3wrap">
    <div style="font-size:.65rem;font-weight:700;color:${bal>=0?'var(--ah)':'#721c24'};text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px" id="fBV3lbl">Kvar/m√•n som student</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.2rem;color:${bal>=0?'var(--ah)':'#721c24'}" id="fBV3">${(bal>=0?'+':'')+fmt(bal)} kr</div>
    </div>
    <div style="padding:12px;background:#fff3cd;border-radius:10px;text-align:center">
    <div style="font-size:.65rem;font-weight:700;color:#856404;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">CSN-skuld</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.2rem;color:#856404" id="fD3">${fmt(debt)} kr</div>
    </div>
    <div style="padding:12px;background:var(--bll);border-radius:10px;text-align:center">
    <div style="font-size:.65rem;font-weight:700;color:var(--bl);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Break-even</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.2rem;color:var(--bl)" id="fBE3">${be>0&&be<50?'~'+be+' √•r':'‚Äî'}</div>
    <div style="font-size:.65rem;color:var(--bl);opacity:.8;margin-top:3px">${be>0&&be<50?'fr√•n '+( gradYear+be)+' tj√§nar du mer livet ut':'‚Äî'}</div>
    </div>
    <div style="padding:12px;background:#D9F0E3;border-radius:10px;text-align:center">
    <div style="font-size:.65rem;font-weight:700;color:var(--ah);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Examen</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.2rem;color:var(--ah)">${gradYear} (${gradAge} √•r)</div>
    </div>
    </div>`;

    // Steg-f√∂r-steg plan
    h+=`<div style="background:linear-gradient(135deg,var(--ah),var(--ac));border-radius:14px;padding:20px 18px;margin-bottom:16px">
    <div style="color:#fff;font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:4px">Din plan ‚Äî steg f√∂r steg</div>
    <div style="color:rgba(255,255,255,.8);font-size:.82rem">Baserat p√• dina svar ‚Äî i kronologisk ordning</div>
    </div>
    <div style="display:grid;gap:10px;margin-bottom:20px">`;
    steps2.forEach((s,i)=>{
        h+=`<div style="display:flex;gap:14px;padding:16px;background:#fff;border-radius:12px;border:${s.urgent?'2px solid var(--ac)':s.final?'2px solid #d4a853':'1px solid #e0e0d8'};box-shadow:0 1px 6px rgba(0,0,0,.05)">
        <div style="flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:4px">
        <div style="width:32px;height:32px;border-radius:50%;background:${s.final?'#d4a853':s.urgent?'var(--ac)':'#f0f4f1'};color:${s.final||s.urgent?'#fff':'#6c757d'};display:flex;align-items:center;justify-content:center;font-size:.95rem">${s.icon}</div>
        ${i<steps2.length-1?`<div style="width:2px;flex:1;background:#e0e0d8;min-height:16px;margin-top:4px"></div>`:''}
        </div>
        <div style="flex:1;min-width:0">
        <div style="font-size:.7rem;font-weight:700;color:${s.final?'#856404':s.urgent?'var(--ac)':'#6c757d'};text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">${s.when}</div>
        <div style="font-weight:700;font-size:.92rem;color:var(--ah);margin-bottom:4px">${s.title}</div>
        <div style="font-size:.83rem;color:#495057;line-height:1.65">${s.desc}</div>
        </div>
        </div>`;
    });
    h+=`</div>`;

    // S√∂k utbildning
    const eduTypeText2=Array.isArray(a.education_type)?a.education_type.map(t=>({yh:'Yrkesh√∂gskola',uni:'H√∂gskola/Universitet',komvux:'Komvux',folk:'Folkh√∂gskola',private:'Privat skola'}[t]||t)).filter(t=>t!=='any').join(', '):'';
    const studyModeText2={campus:'Campus',distance:'Distans',hybrid:'Hybrid'}[a.study_mode]||'';
    const filterParts2=[eduTypeText2,studyModeText2,e.t,cityName!=='hela Sverige'?cityName:''].filter(Boolean);

    // ‚îÄ‚îÄ Skolrekommendation ‚îÄ‚îÄ
    if(schs.length>0){
        const topSch=schs[0];
        const rec2=schs.length>1?schs[1]:null;
        h+=`<div style="background:#fff;border:2px solid var(--ac);border-radius:16px;padding:22px;margin-bottom:16px;box-shadow:0 4px 16px rgba(122,194,154,.12)">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <div style="width:28px;height:28px;border-radius:50%;background:var(--ac);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.82rem;font-weight:700;flex-shrink:0">‚òÖ</div>
        <div style="font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--ah)">V√•r rekommendation f√∂r dig</div>
        </div>
        <div style="padding:16px;background:#f0f4f1;border-radius:12px;margin-bottom:${rec2?'10px':'0'}">
        <div style="font-weight:700;font-size:.95rem;color:var(--ah);margin-bottom:2px">${topSch.school}</div>
        <div style="font-size:.82rem;color:#6c757d;margin-bottom:8px">${topSch.n} ¬∑ ${topSch.length}${topSch.f==='distance'?' ¬∑ Distans':topSch.f==='campus'?' ¬∑ Campus':''}</div>
        <div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px">${topSch.t.map(tag=>'<span style="background:var(--al);color:var(--ac);padding:3px 9px;border-radius:5px;font-size:.72rem;font-weight:600">'+tag+'</span>').join('')}</div>
        <a href="${topSch.url}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;color:var(--ac);font-size:.82rem;font-weight:700;text-decoration:none">L√§s mer p√• skolans sida ‚Üí</a>
        </div>
        ${rec2?`<div style="padding:12px 16px;background:#f8f9fa;border-radius:10px;border-left:3px solid #ccc">
        <div style="font-size:.75rem;font-weight:600;color:#6c757d;margin-bottom:2px">Alternativ</div>
        <div style="font-weight:600;font-size:.88rem;color:#495057">${rec2.school} ‚Äî ${rec2.n}</div>
        <a href="${rec2.url}" target="_blank" style="font-size:.78rem;color:var(--ac);font-weight:600;text-decoration:none">Mer info ‚Üí</a>
        </div>`:''}
        </div>`;
    }

    h+=`<div style="background:linear-gradient(135deg,var(--ah),var(--ac));border-radius:14px;padding:20px 18px;margin-bottom:14px">
    <div style="color:#fff;font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:4px">S√∂k din utbildning</div>
    <div style="color:rgba(255,255,255,.8);font-size:.82rem">Filtrerat baserat p√• dina svar</div>
    </div>
    <div style="background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:14px">
    ${filterParts2.length>0?`<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">${filterParts2.map(f=>'<span style="background:#f0f4f1;border:1.5px solid var(--ac);color:var(--ac);padding:5px 12px;border-radius:8px;font-size:.8rem;font-weight:600">'+f+'</span>').join('')}</div>`:``}
    ${a.study_mode==='distance'||a.study_mode==='hybrid'?`<div style="padding:10px 14px;background:var(--al);border-radius:8px;margin-bottom:14px;font-size:.82rem;color:var(--ah)">Distans: Linn√©universitetet, Mittuniversitetet och √ñrebro Uni satsar aktivt p√• flexibla program.</div>`:``}
    <a href="https://www.studentum.se/utbildning" target="_blank" style="display:block;text-align:center;background:linear-gradient(135deg,var(--ac),var(--ah));color:#fff;padding:14px 32px;border-radius:10px;font-weight:700;font-size:1rem;text-decoration:none;box-shadow:0 4px 12px rgba(122,194,154,.3)">
    S√∂k p√• Studentum ‚Üí
    </a>
    </div>`;

    // Vill du testa + upsell
    h+=`<div style="padding:18px 20px;background:#fff;border-radius:12px;border:2px solid #e0e0d8;margin-bottom:14px">
    <div style="font-weight:700;font-size:.9rem;color:var(--ah);margin-bottom:8px">Vill du testa innan du best√§mmer?</div>
    <div style="font-size:.83rem;color:#495057;line-height:1.65;margin-bottom:12px">Kom ig√•ng med ${e.t.toLowerCase()} redan idag ‚Äî utan att ans√∂ka:</div>
    <div style="display:grid;gap:7px;margin-bottom:14px">
    ${e.id===2?`<a href="https://www.freecodecamp.org" target="_blank" style="display:flex;align-items:center;gap:10px;padding:9px 14px;background:#f8f9fa;border-radius:8px;text-decoration:none;color:var(--ah);font-size:.83rem;font-weight:600">üñ•Ô∏è freeCodeCamp <span style="font-size:.76rem;color:#6c757d;font-weight:400">‚Äî gratis kodl√§rning, b√∂rja idag</span></a><a href="https://www.theodinproject.com" target="_blank" style="display:flex;align-items:center;gap:10px;padding:9px 14px;background:#f8f9fa;border-radius:8px;text-decoration:none;color:var(--ah);font-size:.83rem;font-weight:600">üõ†Ô∏è The Odin Project <span style="font-size:.76rem;color:#6c757d;font-weight:400">‚Äî fullstack fr√•n grunden</span></a>`
    :e.id===1?`<a href="https://www.1177.se" target="_blank" style="display:flex;align-items:center;gap:10px;padding:9px 14px;background:#f8f9fa;border-radius:8px;text-decoration:none;color:var(--ah);font-size:.83rem;font-weight:600">üè• 1177 V√•rdguiden <span style="font-size:.76rem;color:#6c757d;font-weight:400">‚Äî l√§r k√§nna v√•rden utifr√•n</span></a><a href="https://www.coursera.org/browse/health" target="_blank" style="display:flex;align-items:center;gap:10px;padding:9px 14px;background:#f8f9fa;border-radius:8px;text-decoration:none;color:var(--ah);font-size:.83rem;font-weight:600">üìö Coursera Health <span style="font-size:.76rem;color:#6c757d;font-weight:400">‚Äî introduktionskurser i v√•rd</span></a>`
    :`<a href="https://www.coursera.org" target="_blank" style="display:flex;align-items:center;gap:10px;padding:9px 14px;background:#f8f9fa;border-radius:8px;text-decoration:none;color:var(--ah);font-size:.83rem;font-weight:600">üìö Coursera <span style="font-size:.76rem;color:#6c757d;font-weight:400">‚Äî gratis introduktionskurser</span></a><a href="https://www.youtube.com" target="_blank" style="display:flex;align-items:center;gap:10px;padding:9px 14px;background:#f8f9fa;border-radius:8px;text-decoration:none;color:var(--ah);font-size:.83rem;font-weight:600">‚ñ∂Ô∏è YouTube <span style="font-size:.76rem;color:#6c757d;font-weight:400">‚Äî s√∂k yrket + "dag i livet"</span></a>`}
    </div>
    <div style="border-top:1px solid #e0e0d8;padding-top:12px">
    <div style="font-size:.76rem;font-weight:700;color:#6c757d;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Vill du ha ett √§rligt samtal?</div>
    <div onclick="alert('Kommer snart!')" style="display:flex;align-items:center;gap:14px;padding:14px 16px;background:linear-gradient(135deg,var(--wl),#FFF8EE);border:2px solid var(--wa);border-radius:12px;cursor:pointer">
    <div style="width:40px;height:40px;border-radius:50%;background:var(--wa);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg></div>
    <div style="flex:1">
    <div style="font-weight:700;font-size:.9rem;color:var(--ah)">Prata med en ${e.t.toLowerCase()} ‚Äî 20 min</div>
    <div style="font-size:.8rem;color:#6c757d;margin-top:2px">St√§ll fr√•gorna siffrorna inte svarar p√•. Vad √§r sv√•rast med jobbet? Hur var studietiden egentligen?</div>
    </div>
    <div style="font-weight:700;font-size:1rem;color:var(--wa);white-space:nowrap">499 kr ‚Üí</div>
    </div>
    </div>
    </div>`;

    // ‚îÄ‚îÄ Avslutande CTA ‚îÄ‚îÄ
    h+=`<div style="background:linear-gradient(135deg,#1a1a18,#2d2d29);border-radius:16px;padding:32px 28px;margin-top:8px;text-align:center">
    <div style="font-family:'DM Serif Display',serif;font-size:1.6rem;color:#fff;margin-bottom:10px;line-height:1.25">${firstName} ‚Äî nu √§r det dags att ta n√§sta steg.</div>
    <div style="font-size:.9rem;color:rgba(255,255,255,.7);margin-bottom:24px;line-height:1.6;max-width:380px;margin-left:auto;margin-right:auto">Planen √§r din. Spara den, skriv ut den, dela den. Det enda som saknas √§r att du faktiskt g√∂r det.</div>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
    <button onclick="printPlan()" style="padding:13px 24px;background:var(--ac);color:#fff;border:none;border-radius:10px;font-family:inherit;font-weight:700;font-size:.9rem;cursor:pointer;display:flex;align-items:center;gap:8px">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Spara som PDF</button>
    <a href="https://www.antagning.se" target="_blank" style="padding:13px 24px;background:rgba(255,255,255,.1);color:#fff;border:1.5px solid rgba(255,255,255,.2);border-radius:10px;font-family:inherit;font-weight:700;font-size:.9rem;cursor:pointer;text-decoration:none;display:flex;align-items:center;gap:8px">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>G√• till antagning.se</a>
    </div>
    <div style="margin-top:20px;font-size:.75rem;color:rgba(255,255,255,.4)">Planen ers√§tter inte professionell studiev√§gledning ‚Äî men den ger dig ett rej√§lt f√∂rspr√•ng.</div>
    </div>`;

    h+=`</div>`; // end #planSkol

    // planSummary removed ‚Äî Sammanfattning tab covers this now
    h+=`<div id="planSummary" style="display:none"></div>`;

    document.getElementById('fpDiv').innerHTML=h;
}

// Tab switching
const PLAN_TABS=['tid','overview','ekon','beh','skol'];
const PLAN_LABELS=['Tidslinje','√ñversikt','Ekonomi','Beh√∂righet','Sammanfattning'];
let planTabIdx=0;

function navPlan(dir){
    const tabs=PLAN_TABS;
    const cur=tabs.indexOf(window._curTab||'overview');
    const next=Math.max(0,Math.min(tabs.length-1,cur+dir));
    if(next===cur)return;
    const btn=document.querySelectorAll('.ptbar button')[next];
    planTab(tabs[next],btn);
    document.getElementById('planTabs').closest('section')||document.querySelector('.fp').scrollIntoView({behavior:'smooth',block:'start'});
    window.scrollTo({top:document.getElementById('planTabs').getBoundingClientRect().top+window.scrollY-70,behavior:'smooth'});
}
function planTab(tab,btn){
    window._curTab=tab;document.querySelectorAll('.ptbar button').forEach(b=>b.classList.remove('act'));
    if(btn) btn.classList.add('act');
    else {
        const btns=document.querySelectorAll('.ptbar button');
        const idx=PLAN_TABS.indexOf(tab);
        if(btns[idx]) btns[idx].classList.add('act');
    }
    planTabIdx=PLAN_TABS.indexOf(tab);
    if(planTabIdx<0) planTabIdx=0;
    ['planOverview','planBeh','planEkon','planTid','planSkol','planLifeChange'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.style.display='none';
    });
    const map={overview:'planOverview',beh:'planBeh',ekon:'planEkon',tid:'planTid',skol:'planSkol'};
    const panelId=map[tab];
    if(panelId) document.getElementById(panelId).style.display='block';
    if(tab==='overview'){
        const lc=document.getElementById('planLifeChange');
        if(lc) lc.style.display='block';
    }
    // Update arrows
    const prev=document.getElementById('planPrev');
    const next=document.getElementById('planNext');
    const lbl=document.getElementById('planStepLabel');
    if(prev){prev.disabled=planTabIdx===0;prev.style.opacity=planTabIdx===0?'0.35':'1';}
    if(next){next.disabled=planTabIdx===PLAN_TABS.length-1;next.style.opacity=planTabIdx===PLAN_TABS.length-1?'0.35':'1';}
    if(lbl) lbl.textContent=PLAN_LABELS[planTabIdx]+' ('+(planTabIdx+1)+'/'+PLAN_TABS.length+')';
    const welcomeEl=document.querySelector('.pwel');
    if(welcomeEl) window.scrollTo({top:welcomeEl.offsetTop-70,behavior:'smooth'});
}
function planPrev(){if(planTabIdx>0) planTab(PLAN_TABS[planTabIdx-1],null);}
function planNext(){if(planTabIdx<PLAN_TABS.length-1) planTab(PLAN_TABS[planTabIdx+1],null);}

function checkGrades(){
    const boxes=document.querySelectorAll('#gradeCheck input[type=checkbox]');
    const res=document.getElementById('gradeResult');
    const missing=[...boxes].filter(b=>!b.checked).map(b=>b.parentElement.querySelector('span').textContent);
    if(!missing.length){res.style.background='var(--al)';res.style.color='var(--ac)';res.textContent='Alla kurser avklarade.';}
    else{res.style.background='var(--rl)';res.style.color='var(--re)';res.textContent='Saknas: '+missing.join(', ')+'. Komplettera via Komvux.';}
}

function setHou(type,btn){
    const city=mapCity(ans.current_location);
    const defR=type==='home'?0:Math.round((CIT[city]||4500)*(HOU[type]||.75));
    document.getElementById('fR').value=defR;
    document.getElementById('fRMark').style.left=(defR/12000*100)+'%';
    const hn2={student:'studentboende',shared:'delad lgh',rental:'hyresr√§tt',home:'bo kvar'};
    document.getElementById('fRDef').textContent='Snitt '+(hn2[type]||type)+': '+fmt(defR)+' kr';
    document.querySelectorAll('.houbtn').forEach(b=>b.classList.remove('hact'));
    btn.classList.add('hact');
    
    // Update housing type in answers
    ans.housing=type;
    
    // Re-render expenses section
    updateExpensesSection(type);
    
    upd();
}

function updateExpensesSection(hou){
    const expSection=document.getElementById('expensesSection');
    if(!expSection)return;
    
    const fixedExp=parseInt(ans.fixed_expenses)||10000;
    const variableExp=parseInt(ans.variable_expenses)||4000;
    const userExp=hou==='home'?(fixedExp+variableExp):variableExp;
    
    let h='';
    
    if(hou==='home'){
        h+=`<div style="font-size:.72rem;color:#495057;margin:-4px 0 8px 0;padding:0 12px;line-height:1.4;opacity:.85">Dina fasta utgifter + r√∂rliga utgifter. Inkluderar din nuvarande hyra.</div>`;
    }else{
        h+=`<div style="font-size:.72rem;color:#495057;margin:-4px 0 8px 0;padding:0 12px;line-height:1.4;opacity:.85">Endast r√∂rliga utgifter (mat, transport, n√∂je). Boende √§r separat ovan.</div>`;
    }
    
    h+=`<div style="padding:12px;background:#fff;border-radius:8px;margin-bottom:8px;border:1px solid #dee2e6">`;
    
    if(hou==='home'){
        h+=`<div style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <label style="font-size:.85rem;font-weight:600;color:#495057">Fasta utgifter</label>
        <span style="font-size:.95rem;font-weight:600;color:#495057" id="fFixedExp">${fmt(fixedExp)} kr</span>
        </div>
        <input type="range" class="bslider" id="fFixed" min="3000" max="20000" step="250" value="${fixedExp}" oninput="upd()" style="accent-color:#6c757d;width:100%">
        <div class="bsmeta"><span>3 000 kr</span><span>20 000 kr</span></div>
        <div style="font-size:.72rem;color:#6c757d;margin-top:4px;opacity:.85">Hyra, el, f√∂rs√§kringar, abonnemang</div>
        </div>`;
    }
    
    h+=`<div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
    <label style="font-size:.85rem;font-weight:600;color:#495057">R√∂rliga utgifter</label>
    <span style="font-size:.95rem;font-weight:600;color:#495057" id="fVarExp">${fmt(variableExp)} kr</span>
    </div>
    <input type="range" class="bslider" id="fVariable" min="1000" max="10000" step="250" value="${variableExp}" oninput="upd()" style="accent-color:#6c757d;width:100%">
    <div class="bsmeta"><span>1 000 kr</span><span>10 000 kr</span></div>
    <div style="font-size:.72rem;color:#6c757d;margin-top:4px;opacity:.85">Mat, transport, n√∂je, kl√§der</div>
    </div>
    </div>`;
    
    expSection.innerHTML=h;
}

function upd(){
    if(!edu)return;
    const a=ans;
    const age=Math.min(70,Math.max(18,parseInt(a.age)||29));
    const ry=edu.y;
    const loan=+document.getElementById('fL').value;
    const wh=+document.getElementById('fW').value;
    const wr=+document.getElementById('fWR').value;
    const rent=+document.getElementById('fR').value;
    const wi=Math.round(wh*wr*4.3);
    const barnCSN=a.has_kids==='yes'?2648:0;
    const numKids=a.num_kids?parseInt(a.num_kids)||1:0;
    const cc=a.has_kids==='yes'?2000*numKids:0;
    
    // Get expenses from sliders
    const hou=a.housing||'student';
    const fFixedEl=document.getElementById('fFixed');
    const fixedExp=hou==='home'&&fFixedEl?+fFixedEl.value:(parseInt(a.fixed_expenses)||10000);
    const variableExp=+document.getElementById('fVariable').value;
    const userExp=hou==='home'?(fixedExp+variableExp):variableExp;
    
    const ti=BID+barnCSN+loan+wi,to=rent+userExp+cc,bal=ti-to;
    const mo=Math.round(ry*10),debt=loan*mo,pb=debt>0?Math.round(debt*.04/12):0;
    const op=sal*12*ry,yg=(edu.s0-sal)*12,be=yg>0?Math.ceil((op+debt)/yg):0;

    document.getElementById('fLV').textContent=fmt(loan)+' kr';
    document.getElementById('fWV').textContent=fmt(wi)+' kr';
    document.getElementById('fWH').textContent=wh+' h';
    document.getElementById('fWRL').textContent=wr+' kr';
    document.getElementById('fRV').textContent=fmt(rent)+' kr';
    
    // Update expenses
    if(hou==='home'&&document.getElementById('fFixedExp')){
        document.getElementById('fFixedExp').textContent=fmt(fixedExp)+' kr';
    }
    document.getElementById('fVarExp').textContent=fmt(variableExp)+' kr';
    document.getElementById('fUserExp').textContent=fmt(userExp)+' kr';
    
    document.getElementById('fTI').textContent=fmt(ti)+' kr';
    document.getElementById('fTO').textContent=fmt(to)+' kr';

    const bx=document.getElementById('fBx'),bl2=document.getElementById('fBL'),bv=document.getElementById('fBV'),ba=document.getElementById('fBA');
    const c=bal>=0?'var(--ac)':'#c24b3b',bg=bal>=0?'#D9F0E3':'#f8d7da';
    bx.style.background=bg;bx.style.borderColor=c;bl2.style.color=bv.style.color=ba.style.color=c;
    bl2.textContent=bal>=0?'Kvar varje m√•nad':'Underskott';
    bv.textContent=(bal>=0?'+':'')+fmt(bal)+' kr';
    ba.textContent=bal>=500?'Bra marginal!':bal>=0?'Tight men funkar.':'√ñka l√•n, s√§nk hyra eller extrajobb.';

    const bv2=document.getElementById('fBV2');
    if(bv2){bv2.textContent=(bal>=0?'+':'')+fmt(bal)+' kr';
    const col=bal>=0?'var(--ah)':'#721c24';const bg=bal>=0?'#D9F0E3':'#f8d7da';
    bv2.style.color=col;
    const wrap=document.getElementById('fBV2wrap');if(wrap)wrap.style.background=bg;
    const lbl=document.getElementById('fBV2lbl');if(lbl){lbl.style.color=col;}
    bv2.querySelectorAll&&bv2.querySelectorAll('div').forEach(d=>d.style.color=col);}
    const fPBel=document.getElementById('fPB');if(fPBel)fPBel.textContent=debt>0&&pb>0?fmt(pb)+' kr':'‚Äî';
    const fD2=document.getElementById('fD2');if(fD2)fD2.textContent=fmt(debt)+' kr';
    const fD2s=document.getElementById('fD2s');if(fD2s)fD2s.textContent=fmt(debt)+' kr';
    const fBE=document.getElementById('fBE');if(fBE)fBE.textContent=be>0&&be<50?'~'+be+' √•r':'‚Äî';
    // Sync summary cards (alltid synlig sektion)
    const bv3=document.getElementById('fBV3');if(bv3){bv3.textContent=(bal>=0?'+':'')+fmt(bal)+' kr';bv3.style.color=bal>=0?'var(--ac)':'#c24b3b';}
    const fd3=document.getElementById('fD3');if(fd3)fd3.textContent=fmt(debt)+' kr';
    const fbe3=document.getElementById('fBE3');if(fbe3)fbe3.textContent=be>0&&be<50?'~'+be+' √•r':'‚Äî';
    
    // Render debt banner dynamically
    renderDebtBanner(debt, age, ry);
}

function renderDebtBanner(debt, age, ry){
    const banner=document.getElementById('debtBanner');
    if(!banner)return;
    
    if(debt>0){
        const pb=Math.round(debt*0.04/12);
        const yearsToPayoff=Math.ceil(debt/(pb*12));
        const debtFreeAge=age+ry+yearsToPayoff;
        
        banner.innerHTML=`<div style="background:linear-gradient(135deg,#fff9f0,#fff3e0);border:2px solid #e8b86d;border-radius:16px;padding:32px 28px;margin:32px 0">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px">
        <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="#7d6131" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <div style="flex:1">
        <div style="font-family:'DM Serif Display',serif;font-size:1.6rem;color:#7d6131;margin-bottom:4px">Din investering i framtiden</div>
        <div style="font-size:.9rem;color:#7d6131;opacity:.85">CSN-l√•n med l√•g r√§nta (~0.55%) ‚Äî den billigaste l√•neformen som finns</div>
        </div>
        <div style="text-align:right">
        <div style="font-size:.78rem;text-transform:uppercase;color:#7d6131;opacity:.75;letter-spacing:.5px">Total summa</div>
        <div style="font-family:'DM Serif Display',serif;font-size:2.2rem;color:#7d6131;font-weight:700" id="fD2">${fmt(debt)} kr</div>
        </div>
        </div>
        
        <div style="background:#fff;border-radius:12px;padding:20px;margin-bottom:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <label style="font-size:.92rem;font-weight:600;color:#495057">M√•nadsbelopp (du v√§ljer)</label>
        <span style="font-size:1.1rem;font-weight:700;color:#7d6131" id="fPB">${fmt(pb)} kr/m√•n</span>
        </div>
        <input type="range" class="bslider" id="fPayback" min="${Math.round(debt*0.04/12)}" max="${Math.round(debt*0.10/12)}" step="100" value="${pb}" oninput="updPayback()" style="accent-color:#e8b86d;width:100%">
        <div style="display:flex;justify-content:space-between;font-size:.75rem;color:#6c757d;margin-top:6px">
        <span>Lugnt tempo (${fmt(Math.round(debt*0.04/12))} kr)</span>
        <span>Snabbare tempo (${fmt(Math.round(debt*0.10/12))} kr)</span>
        </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div style="background:#fff;padding:16px;border-radius:10px;text-align:center">
        <div style="font-size:.75rem;color:#6c757d;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">Skuldfri vid</div>
        <div style="font-family:'DM Serif Display',serif;font-size:1.6rem;color:var(--ac)" id="fDebtFreeAge">${debtFreeAge} √•r</div>
        </div>
        <div style="background:#fff;padding:16px;border-radius:10px;text-align:center">
        <div style="font-size:.75rem;color:#6c757d;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">√Öterbetalningstid</div>
        <div style="font-family:'DM Serif Display',serif;font-size:1.6rem;color:var(--ac)" id="fYearsToPayoff">${yearsToPayoff} √•r</div>
        </div>
        </div>
        </div>`;
    }else{
        banner.innerHTML=`<div style="background:linear-gradient(135deg,#D9F0E3,#a3cfbb);border:2px solid var(--ac);border-radius:16px;padding:32px 28px;margin:32px 0;text-align:center">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--ah)" stroke-width="2" style="margin:0 auto 16px"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        <div style="font-family:'DM Serif Display',serif;font-size:1.8rem;color:var(--ah);margin-bottom:8px">Ingen skuld!</div>
        <div style="font-size:1rem;color:var(--ah);opacity:.9">Du klarar studierna utan CSN-l√•n. Det ger dig ekonomisk frihet direkt efter examen.</div>
        </div>`;
    }
}

function updPayback(){
    const a=ans;
    const age=Math.min(70,Math.max(18,parseInt(a.age)||29));
    const loan=+document.getElementById('fL').value;
    const ry=edu.y;
    const mo=Math.round(ry*10),debt=loan*mo;
    const pb=+document.getElementById('fPayback').value;
    const yearsToPayoff=debt>0&&pb>0?Math.ceil(debt/(pb*12)):0;
    const debtFreeAge=age+ry+yearsToPayoff;
    
    document.getElementById('fPB').textContent=fmt(pb)+' kr/m√•n';
    document.getElementById('fDebtFreeAge').textContent=debtFreeAge>0?debtFreeAge+' √•r':'‚Äî';
    document.getElementById('fYearsToPayoff').textContent=yearsToPayoff>0?yearsToPayoff+' √•r':'‚Äî';
}

// Debt banner is rendered dynamically via upd() and buildFP()


// ‚ïê‚ïê‚ïê DIN-PLAN LOGIC ‚ïê‚ïê‚ïê

const fmt2 = n => n.toLocaleString('sv-SE');

function handlePayment() {
    // F√∂rifylla e-post + l√∂senord fr√•n wizard (via localStorage)
    try {
        const savedEmail = localStorage.getItem('svg_email');
        const savedPwd = localStorage.getItem('svg_password');
        if (savedEmail) document.getElementById('emailInput').value = savedEmail;
        if (savedPwd) document.getElementById('passwordInput').value = savedPwd;
    } catch(e) {}
    document.getElementById('emailModal').style.display = 'flex';
    setTimeout(()=>{
        const ei = document.getElementById('emailInput');
        if (!ei.value) ei.focus();
        else document.getElementById('passwordInput').focus();
    }, 100);
}

async function saveAndUnlock() {
    const email = document.getElementById('emailInput').value.trim().toLowerCase();
    const password = document.getElementById('passwordInput').value.trim();

    if (!email || !email.includes('@')) {
        document.getElementById('emailError').style.display = 'block';
        return;
    }
    if (!password || password.length < 4) {
        document.getElementById('passwordError').style.display = 'block';
        return;
    }
    document.getElementById('emailError').style.display = 'none';
    document.getElementById('passwordError').style.display = 'none';

    const btn = document.getElementById('emailSubmitBtn');
    btn.textContent = 'Sparar...';
    btn.disabled = true;

    // Spara till Supabase plans-tabell med l√∂senord
    try {
        await fetch(SUPABASE_URL + '/rest/v1/plans', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Prefer': 'return=minimal'
            },
            body: JSON.stringify({
                email: email,
                password: password,
                session_id: getSid(),
                education_id: edu ? edu.id : null,
                salary: sal || null,
                data: ans
            })
        });
    } catch(e) {
        console.warn('Supabase plans save failed:', e.message);
    }

    // Spara i localStorage
    try { localStorage.setItem('svg_email', email); } catch(e) {}
    try { localStorage.setItem('svg_password', password); } catch(e) {}

    // G√• direkt till /min-plan
    window.location.href = '/min-plan';
}

function getSid() {
    const params = new URLSearchParams(window.location.search);
    return params.get('sid') || localStorage.getItem('svg_sid') || '';
}

function showPreviewCards(a, e, currentSal) {
    const loan = a.need_csn === 'no' || a.need_csn === 'grant' ? 0 : 6000;
    const debt = loan * Math.round(e.y * 10);
    const yg = (e.s0 - currentSal) * 12;
    const op = currentSal * 12 * e.y;
    const be = yg > 0 ? Math.ceil((op + debt) / yg) : 0;
    const salDiff = e.s0 - currentSal;
    const firstName = (a.user_name || 'Din plan').split(' ')[0];
    const salColor = salDiff > 0 ? 'var(--ah)' : '#721c24';
    const salBg = salDiff > 0 ? '#D9F0E3' : '#f8d7da';
    const salTxt = (salDiff >= 0 ? '+' : '') + fmt2(salDiff) + ' kr';
    const beTxt = be > 0 && be < 50 ? '~' + be + ' ar' : '---';
    const card = document.createElement('div');
    card.style.cssText = 'background:var(--card);border:2px solid var(--bo);border-radius:16px;padding:20px;margin-bottom:4px';
    card.innerHTML = '<div style="font-family:DM Serif Display,serif;font-size:1.2rem;margin-bottom:14px;color:var(--ah)">' + firstName + ' ‚Äî din v√§g till ' + e.t.toLowerCase() + '</div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center"><div style="background:' + salBg + ';padding:12px;border-radius:10px"><div style="font-size:.65rem;font-weight:700;color:' + salColor + ';text-transform:uppercase;margin-bottom:3px">L√∂ne√∂kning</div><div style="font-family:DM Serif Display,serif;font-size:1.1rem;color:' + salColor + '">' + salTxt + '</div></div><div style="background:#fff3cd;padding:12px;border-radius:10px"><div style="font-size:.65rem;font-weight:700;color:#856404;text-transform:uppercase;margin-bottom:3px">CSN-skuld</div><div style="font-family:DM Serif Display,serif;font-size:1.1rem;color:#856404">' + fmt2(debt) + ' kr</div></div><div style="background:var(--bll);padding:12px;border-radius:10px"><div style="font-size:.65rem;font-weight:700;color:var(--bl);text-transform:uppercase;margin-bottom:3px">Break-even</div><div style="font-family:DM Serif Display,serif;font-size:1.1rem;color:var(--bl)">' + beTxt + '</div></div></div>';
    document.getElementById('previewCards').appendChild(card);
}


function getSid() {
    const params = new URLSearchParams(window.location.search);
    return params.get('sid') || localStorage.getItem('svg_sid') || '';
}

// handlePayment definierad ovan

async function init() {
    const sid = getSid();
    if (!sid) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'flex';
        return;
    }
    
    let answersData = null;
    
    // 1. F√∂rs√∂k h√§mta fr√•n Supabase
    if (sb) {
        try {
            const { data, error } = await sb
                .from('answers')
                .select('*')
                .filter('data->>_session_id', 'eq', sid)
                .order('created_at', { ascending: false })
                .limit(1)
                .single();
            
            if (!error && data) {
                answersData = Object.assign({}, data.data, {
                    _salary: data.salary,
                    _eduId: data.education_id
                });
            }
        } catch(e) {
            console.warn('Supabase fetch failed:', e.message);
        }
    }
    
    // 2. Fallback: localStorage
    if (!answersData) {
        try {
            const saved = localStorage.getItem('svg_answers');
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed._session_id === sid) {
                    answersData = Object.assign({}, parsed, {
                        _salary: parseInt(localStorage.getItem('svg_sal')) || 0,
                        _eduId: parseInt(localStorage.getItem('svg_edu')) || 0
                    });
                }
            }
        } catch(e) {}
    }
    
    if (!answersData) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'flex';
        return;
    }
    
    // Set global state
    ans = answersData;
    sal = answersData._salary || 0;
    const eduId = answersData._eduId || 0;
    edu = E.find(function(e) { return e.id === eduId; });
    
    if (!edu) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'flex';
        return;
    }
    
    // Build plan
    const userName = answersData.user_name || 'Anvaendare';
    buildFP(userName);
    
    // Show preview cards
    showPreviewCards(ans, edu, sal);
    
    // Show plan
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('planWrap').style.display = 'block';
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>